<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="icon" type="image/png" sizes="32x32" href="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="Houmin" type="application/atom+xml">
  <meta name="google-site-verification" content="zdGhdEF7jHoJW58lsdN6l9JrQFjJFwakCIc7TbbosV0">
  <meta name="msvalidate.01" content="2F527B379ED5537861D0D38C2C754C2B">
  <meta name="baidu-site-verification" content="xAag2PqzKE">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css">
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":true},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: true,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="在 RESTful API 我介绍了 RESTful 架构的约束条件与最佳实践，但还没有实际上手构建过一个 RESTful 的架构服务。本文将基于 go-restful 这一轻量级框架，介绍在 Go 语言中如何实现 RESTful API，本文中所有代码参考自go-restful examples，可在我的 Github 中找到。">
<meta name="keywords" content="Go,REST">
<meta property="og:type" content="article">
<meta property="og:title" content="【Awesome Go】Go RESTful">
<meta property="og:url" content="http://houmin.cc/posts/e3978252/index.html">
<meta property="og:site_name" content="Houmin">
<meta property="og:description" content="在 RESTful API 我介绍了 RESTful 架构的约束条件与最佳实践，但还没有实际上手构建过一个 RESTful 的架构服务。本文将基于 go-restful 这一轻量级框架，介绍在 Go 语言中如何实现 RESTful API，本文中所有代码参考自go-restful examples，可在我的 Github 中找到。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-12-03_go-restful.png">
<meta property="og:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-12-05_go-restful-hello.png">
<meta property="og:updated_time" content="2020-12-05T10:46:04.049Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-12-03_go-restful.png">

<link rel="canonical" href="http://houmin.cc/posts/e3978252/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>【Awesome Go】Go RESTful | Houmin</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


  <script src="/js/photoswipe.min.js?v="></script>
  <script src="/js/photoswipe-ui-default.min.js?v="></script>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Houmin</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">Yesterday You Said Tomorrow</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-album">

    <a href="/album" rel="section"><i class="fa fa-fw fa-camera"></i>相册</a>

  </li>
        <li class="menu-item menu-item-movies">

    <a href="/movies/" rel="section"><i class="fa fa-fw fa-film"></i>观影</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="/books/" rel="section"><i class="fa fa-fw fa-book"></i>阅读</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://houmin.cc/posts/e3978252/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/avatar.png">
      <meta itemprop="name" content="Houmin">
      <meta itemprop="description" content="丈夫拥书万卷，何假南面百城">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Houmin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          【Awesome Go】Go RESTful
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-15 15:06:41" itemprop="dateCreated datePublished" datetime="2020-07-15T15:06:41+08:00">2020-07-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9C%AF%E4%B8%9A%E4%B8%93%E6%94%BB/" itemprop="url" rel="index">
                    <span itemprop="name">术业专攻</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/posts/e3978252/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/posts/e3978252/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>37 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>在 <a href="../45b76dc5">RESTful API</a> 我介绍了 <code>RESTful</code> 架构的约束条件与最佳实践，但还没有实际上手构建过一个 <code>RESTful</code> 的架构服务。本文将基于 <a href="https://github.com/emicklei/go-restful" target="_blank" rel="external nofollow noopener noreferrer"><strong>go-restful</strong></a> 这一轻量级框架，介绍在 Go 语言中如何实现 <code>RESTful</code> API，本文中所有代码参考自<code>go-restful examples</code>，可在我的 <a href="https://github.com/SimpCosm/godemo/restful" target="_blank" rel="external nofollow noopener noreferrer">Github</a> 中找到。</p>
<a id="more"></a>
<p><a href="https://github.com/emicklei/go-restful" target="_blank" rel="external nofollow noopener noreferrer"><strong>go-restful</strong></a> 并不是 Go 语言中唯一的 RESTful API 框架，<a href="https://github.com/astaxie/beego" target="_blank" rel="external nofollow noopener noreferrer">beego</a> 、<a href="https://github.com/gin-gonic/gin" target="_blank" rel="external nofollow noopener noreferrer">gin</a> 都属于这一范畴，<code>go-restful</code> 的一大优点在于其轻量性，<code>k8s apisever</code> 中也使用了 <code>go-restful</code> 框架。在深入了解 <code>go-restful</code> 之前，结合 <a href="../45b76dc5">RESTful API</a> 中讨论的 <code>REST</code> 架构的基本原则，我们先提出一个问题，Go 语言不是已经给我们提供了原生的 <code>net/http</code> 包吗？我们为什么还需要一个独立的 <code>RESTful API</code> 框架呢， <code>RESTful API</code> 框架需要实现什么？</p>
<p>一个 RESTful API 框架应该具备以下几个元素：</p>
<ul>
<li><strong>Resources</strong>：资源的定义，即 <code>HTTP URI</code> 的定义，RESTful API 的设计围绕着 Resource 进行建模。</li>
<li><strong>Handlers</strong>：资源处理器，是资源业务逻辑处理的具体实现。</li>
<li><strong>Request Routers</strong>：资源请求路由器，完成 <code>HTTP URIs</code>、<code>HTTP Request Methods</code> 和 <code>Handlers</code> 三者之间的映射与路由。</li>
<li><strong>Request Verification Schemas</strong>：<code>HTTP Request Body</code> 校验器，验证请求实体的合法性。</li>
<li><strong>Response View Builder</strong>：<code>HTTP Response Body</code> 生成器，生成合法的响应实体。</li>
<li><strong>Controllers</strong>：资源表现层状态转移控制器，每个 Resource 都有着各自的 Controller，将 Resource 自身及其所拥有的 <code>Handlers</code>、<code>Request Verification Schemas</code> 以及 <code>Response View Builder</code> 进行封装，配合 <code>Request Routers</code> 完成 <code>RESTful</code> 请求的处理即响应。</li>
</ul>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p><img alt data-src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-12-03_go-restful.png"></p>
<h3 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h3><p>Route 表示一条请求路由记录，即：Resource 的 URL Path（URI），从编程的角度可细分为 RootPath 和 SubPath。Route 包含了 Resource 的 <code>URL Path</code>、<code>HTTP Method</code>、<code>Handler</code> 三者之间的组合映射关系。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Route binds a HTTP Method,Path,Consumes combination to a RouteFunction.</span></span><br><span class="line"><span class="keyword">type</span> Route <span class="keyword">struct</span> &#123;</span><br><span class="line">	Method   <span class="keyword">string</span></span><br><span class="line">	Produces []<span class="keyword">string</span></span><br><span class="line">	Consumes []<span class="keyword">string</span></span><br><span class="line">	Path     <span class="keyword">string</span> <span class="comment">// webservice root path + described path</span></span><br><span class="line">	Function RouteFunction</span><br><span class="line">	Filters  []FilterFunction</span><br><span class="line">	If       []RouteSelectionConditionFunction</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>go-restful</code> 内置的 <code>RouteSelector</code> 根据 Route 将客户端发出的 HTTP 请求路由到相应的 <code>Handler</code> 进行处理，<code>Handler</code> 具体也就是 <code>Route</code> 数据结构中的 <code>Function</code>，这个函数包含了用户的请求与返回给用户的响应。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RouteFunction <span class="function"><span class="keyword">func</span><span class="params">(*Request, *Response)</span></span></span><br></pre></td></tr></table></figure>
<h3 id="WebService"><a href="#WebService" class="headerlink" title="WebService"></a>WebService</h3><p>一个 <code>WebService</code> 由若干个 <code>Routes</code> 组成，并且 WebService 内的 Routes 拥有同一个 RootPath、输入输出格式、基本一致的请求数据类型等等一系列的通用属性。通常的，我们会根据需要将一组相关性非常强的 API 封装成为一个 WebServiice，继而将 Web Application 所拥有的全部 APIs 划分若干个 Group。</p>
<figure class="highlight go"><figcaption><span>go-restful/web_service.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebService holds a collection of Route values that bind a Http Method + URL Path to a function.</span></span><br><span class="line"><span class="keyword">type</span> WebService <span class="keyword">struct</span> &#123;</span><br><span class="line">	rootPath       <span class="keyword">string</span></span><br><span class="line">	pathExpr       *pathExpression <span class="comment">// cached compilation of rootPath as RegExp</span></span><br><span class="line">	routes         []Route</span><br><span class="line">	produces       []<span class="keyword">string</span></span><br><span class="line">	consumes       []<span class="keyword">string</span></span><br><span class="line">	pathParameters []*Parameter</span><br><span class="line">	filters        []FilterFunction</span><br><span class="line">	documentation  <span class="keyword">string</span></span><br><span class="line">	apiVersion     <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	typeNameHandleFunc TypeNameHandleFunction</span><br><span class="line"></span><br><span class="line">	dynamicRoutes <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// protects 'routes' if dynamic routes are enabled</span></span><br><span class="line">	routesLock sync.RWMutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Root-Path"><a href="#Root-Path" class="headerlink" title="Root Path"></a>Root Path</h4><p><code>WebService</code> 有一个 Root Path，通过 <code>ws.Path()</code> 方法设置，例如：<code>/users</code>，作为 Group 的 根。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ws := <span class="built_in">new</span>(restful.WebService)</span><br><span class="line">ws.</span><br><span class="line">	Path(<span class="string">"/users"</span>).</span><br><span class="line">	Consumes(restful.MIME_XML, restful.MIME_JSON).</span><br><span class="line">	Produces(restful.MIME_JSON, restful.MIME_XML) <span class="comment">// you can specify this per route as well</span></span><br></pre></td></tr></table></figure>
<p><code>Path</code> 的具体实现就是设置了 <code>rootPath</code> 字段，而上面的 <code>Consumes</code> 和 <code>Produces</code> 则设置了 <code>WebService</code> 所能接收和返回的 <code>MIME</code> 类型，你也可以对每个 <code>Route</code> 单独设置。</p>
<figure class="highlight go"><figcaption><span>go-restful/web_service.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *WebService)</span> <span class="title">Path</span><span class="params">(root <span class="keyword">string</span>)</span> *<span class="title">WebService</span></span> &#123;</span><br><span class="line">	w.rootPath = root</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(w.rootPath) == <span class="number">0</span> &#123;</span><br><span class="line">		w.rootPath = <span class="string">"/"</span></span><br><span class="line">	&#125;</span><br><span class="line">	w.compilePathExpression()</span><br><span class="line">	<span class="keyword">return</span> w</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Group 下属的 APIs 都是 <code>RootRoute</code>（RootPath）下属的 <code>SubRoute</code>（SubPath）。每个 Group 就是提供一项服务的 API 集合，每个 Group 会维护一个 Version。Group 的抽象是为了能够安全隔离的对各项服务进行敏捷迭代，当我们对一项服务进行升级时，只需要通过对特定版本号的更新来升级相关的 APIs，而不会影响到整个 <code>Web Server</code>。视实际情况而定，可能是若干个 APIs 分为一个 Group，也有可能一个 API 就是一个 Group。</p>
<h4 id="RouteBuilder"><a href="#RouteBuilder" class="headerlink" title="RouteBuilder"></a>RouteBuilder</h4><p>Route 包含了 Resource 的 <code>URL Path</code>、<code>HTTP Method</code>、<code>Handler</code> 三者之间的组合映射关系，为了在 <code>WebService</code> 能够注册到这种映射关系，用户需要调用 <code>Route()</code> 函数，这里的 <code>hello</code> 则是一个典型的 <code>RouteFunction</code>，其参数为 <code>Request</code> 和 <code>Response</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ws.Route(ws.GET(<span class="string">"/hello"</span>).To(hello))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">(req *restful.Request, resp *restful.Response)</span></span> &#123;</span><br><span class="line">	io.WriteString(resp, <span class="string">"world"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看看 <code>Route()</code> 函数的具体实现，其参数是 <code>RouteBuilder</code> 这种数据结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Route creates a new Route using the RouteBuilder and add to the ordered list of Routes.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *WebService)</span> <span class="title">Route</span><span class="params">(builder *RouteBuilder)</span> *<span class="title">WebService</span></span> &#123;</span><br><span class="line">	w.routesLock.Lock()</span><br><span class="line">	<span class="keyword">defer</span> w.routesLock.Unlock()</span><br><span class="line">	builder.copyDefaults(w.produces, w.consumes)</span><br><span class="line">	w.routes = <span class="built_in">append</span>(w.routes, builder.Build())</span><br><span class="line">	<span class="keyword">return</span> w</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是 <code>RouteBuilder</code> 的数据结构，很像 <code>Route</code> 的数据结构，主要是为了便于收集 <code>Route</code> 需要用到的各种信息。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RouteBuilder is a helper to construct Routes.</span></span><br><span class="line"><span class="keyword">type</span> RouteBuilder <span class="keyword">struct</span> &#123;</span><br><span class="line">	rootPath                         <span class="keyword">string</span></span><br><span class="line">	currentPath                      <span class="keyword">string</span></span><br><span class="line">	produces                         []<span class="keyword">string</span></span><br><span class="line">	consumes                         []<span class="keyword">string</span></span><br><span class="line">	httpMethod                       <span class="keyword">string</span>        <span class="comment">// required</span></span><br><span class="line">	function                         RouteFunction <span class="comment">// required</span></span><br><span class="line">	filters                          []FilterFunction</span><br><span class="line">	conditions                       []RouteSelectionConditionFunction</span><br><span class="line">	allowedMethodsWithoutContentType []<span class="keyword">string</span> <span class="comment">// see Route</span></span><br><span class="line"></span><br><span class="line">	typeNameHandleFunc TypeNameHandleFunction <span class="comment">// required</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比如首先通过 <code>GET</code> 注册了请求的路径，因为 <code>RouteBuilder</code> 的函数返回都是 <code>RouteBuilder</code> ，所以可以链式调用下去。在后面的 <code>To</code> 就指定了路由的 <code>Handler</code> 函数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET is a shortcut for .Method("GET").Path(subPath)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *WebService)</span> <span class="title">GET</span><span class="params">(subPath <span class="keyword">string</span>)</span> *<span class="title">RouteBuilder</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">new</span>(RouteBuilder).typeNameHandler(w.typeNameHandleFunc).servicePath(w.rootPath).Method(<span class="string">"GET"</span>).Path(subPath)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *RouteBuilder)</span> <span class="title">servicePath</span><span class="params">(path <span class="keyword">string</span>)</span> *<span class="title">RouteBuilder</span></span> &#123;</span><br><span class="line">	b.rootPath = path</span><br><span class="line">	<span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Method specifies what HTTP method to match. Required.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *RouteBuilder)</span> <span class="title">Method</span><span class="params">(method <span class="keyword">string</span>)</span> *<span class="title">RouteBuilder</span></span> &#123;</span><br><span class="line">	b.httpMethod = method</span><br><span class="line">	<span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Path specifies the relative (w.r.t WebService root path) URL path to match. Default is "/".</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *RouteBuilder)</span> <span class="title">Path</span><span class="params">(subPath <span class="keyword">string</span>)</span> *<span class="title">RouteBuilder</span></span> &#123;</span><br><span class="line">	b.currentPath = subPath</span><br><span class="line">	<span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// To bind the route to a function.</span></span><br><span class="line"><span class="comment">// If this route is matched with the incoming Http Request then call this function with the *Request,*Response pair. Required.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *RouteBuilder)</span> <span class="title">To</span><span class="params">(function RouteFunction)</span> *<span class="title">RouteBuilder</span></span> &#123;</span><br><span class="line">	b.function = function</span><br><span class="line">	<span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过这种链式调用之后，就通过 <code>builder.Build()</code> 函数构建了 <code>Route</code> 对象：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Build creates a new Route using the specification details collected by the RouteBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *RouteBuilder)</span> <span class="title">Build</span><span class="params">()</span> <span class="title">Route</span></span> &#123;</span><br><span class="line">	pathExpr, err := newPathExpression(b.currentPath)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">"Invalid path:%s because:%v"</span>, b.currentPath, err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> b.function == <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">"No function specified for route:"</span> + b.currentPath)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	operationName := b.operation</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(operationName) == <span class="number">0</span> &amp;&amp; b.function != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// extract from definition</span></span><br><span class="line">		operationName = nameOfFunction(b.function)</span><br><span class="line">	&#125;</span><br><span class="line">	route := Route&#123;</span><br><span class="line">		Method:                           b.httpMethod,</span><br><span class="line">		Path:                             concatPath(b.rootPath, b.currentPath),</span><br><span class="line">		Produces:                         b.produces,</span><br><span class="line">		Consumes:                         b.consumes,</span><br><span class="line">		Function:                         b.function,</span><br><span class="line">		Filters:                          b.filters,</span><br><span class="line">		If:                               b.conditions,</span><br><span class="line">		relativePath:                     b.currentPath,</span><br><span class="line">		pathExpr:                         pathExpr,</span><br><span class="line">		Doc:                              b.doc,</span><br><span class="line">	  <span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">	route.postBuild()</span><br><span class="line">	<span class="keyword">return</span> route</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><p>至此，结合上面的内容，我们就已经可以借助 <code>go-restful</code> 框架实现一个最简单的 <code>Hello World</code> 了：</p>
<figure class="highlight go"><figcaption><span>hello.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"io"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">	restful <span class="string">"github.com/emicklei/go-restful"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// This example shows the minimal code needed to get a restful.WebService working.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// GET http://localhost:8080/hello</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ws := <span class="built_in">new</span>(restful.WebService)</span><br><span class="line">	ws.Route(ws.GET(<span class="string">"/hello"</span>).To(hello))</span><br><span class="line">	restful.Add(ws)</span><br><span class="line">	log.Fatal(http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">(req *restful.Request, resp *restful.Response)</span></span> &#123;</span><br><span class="line">  io.WriteString(resp, <span class="string">"hello world from houmin\n"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码比较简单，包含一个 <code>hello</code> 的 <code>Handler</code>，通过 <code>ws.Route(ws.GET(&quot;/hello&quot;).To(hello))</code> 将其注册到 <code>WebService</code>，然后启动了一个 <code>WebServer</code>，就可以了通过 <code>GET</code> 方法访问了，如下所示：</p>
<p><img alt data-src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-12-05_go-restful-hello.png"></p>
<h3 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h3><p>上一小节虽然 Work 了，但是还是有一个问题，我们通过 Go 自带的 <code>net/http</code> 包启动的 <code>WebServer</code> 是如何和我们定义的 <code>WebService</code> 联系起来的呢？在解答这个问题之前，我们首先来了解下 <code>Container</code>。</p>
<p><code>Container</code> 表示一个 <code>Web Server</code>，由多个 <code>WebServices</code>组成，此外还包含了若干个 <code>Filters</code>、一个 <code>http.ServeMux</code>多路复用器以及一个 <code>dispatch</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Container holds a collection of WebServices and a http.ServeMux to dispatch http requests.</span></span><br><span class="line"><span class="comment">// The requests are further dispatched to routes of WebServices using a RouteSelector</span></span><br><span class="line"><span class="keyword">type</span> Container <span class="keyword">struct</span> &#123;</span><br><span class="line">	webServicesLock        sync.RWMutex</span><br><span class="line">	webServices            []*WebService</span><br><span class="line">	ServeMux               *http.ServeMux</span><br><span class="line">	isRegisteredOnRoot     <span class="keyword">bool</span></span><br><span class="line">	containerFilters       []FilterFunction</span><br><span class="line">	doNotRecover           <span class="keyword">bool</span> <span class="comment">// default is true</span></span><br><span class="line">	recoverHandleFunc      RecoverHandleFunction</span><br><span class="line">	serviceErrorHandleFunc ServiceErrorHandleFunction</span><br><span class="line">	router                 RouteSelector <span class="comment">// default is a CurlyRouter (RouterJSR311 is a slower alternative)</span></span><br><span class="line">	contentEncodingEnabled <span class="keyword">bool</span>          <span class="comment">// default is false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ServeMux"><a href="#ServeMux" class="headerlink" title="ServeMux"></a>ServeMux</h4><p>我们看到 <code>Container</code> 有一个 <code>ServeMux</code>，这就是利用 <code>net/http</code> 的标准多路复用器，它会将不同的请求路径注册上对应的 <code>Handler</code>：</p>
<figure class="highlight go"><figcaption><span>go/net/http/server.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HandleFunc registers the handler function for the given pattern.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mux *ServeMux)</span> <span class="title">HandleFunc</span><span class="params">(pattern <span class="keyword">string</span>, handler <span class="keyword">func</span>(ResponseWriter, *Request)</span>)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> handler == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"http: nil handler"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	mux.Handle(pattern, HandlerFunc(handler))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而 <code>Container</code> 会在 <code>addHandler</code>函数中，将不同的路径都分发到它自己的 <code>dispatch</code> 函数：</p>
<figure class="highlight go"><figcaption><span>go-restful/container.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// addHandler may set a new HandleFunc for the serveMux</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Container)</span> <span class="title">addHandler</span><span class="params">(service *WebService, serveMux *http.ServeMux)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> !alreadyMapped &#123;</span><br><span class="line">		serveMux.HandleFunc(pattern, c.dispatch)</span><br><span class="line">		<span class="keyword">if</span> !strings.HasSuffix(pattern, <span class="string">"/"</span>) &#123;</span><br><span class="line">			serveMux.HandleFunc(pattern+<span class="string">"/"</span>, c.dispatch)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么 <code>addHandler</code> 是在哪里被调用的呢？这就是我们的 <code>Add</code> 函数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add a WebService to the Container. It will detect duplicate root paths and exit in that case.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Container)</span> <span class="title">Add</span><span class="params">(service *WebService)</span> *<span class="title">Container</span></span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">	<span class="comment">// If not registered on root then add specific mapping</span></span><br><span class="line">	<span class="keyword">if</span> !c.isRegisteredOnRoot &#123;</span><br><span class="line">		c.isRegisteredOnRoot = c.addHandler(service, c.ServeMux)</span><br><span class="line">	&#125;</span><br><span class="line">	c.webServices = <span class="built_in">append</span>(c.webServices, service)</span><br><span class="line">	<span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，如果我们创建了自己的 <code>Container</code> 的话，需要将 <code>WebService</code> 关联到这个 <code>Container</code> 才能生效：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">container := restful.NewContainer()</span><br><span class="line">ws := <span class="built_in">new</span>(restful.WebService)</span><br><span class="line">ws.Route(ws.GET(<span class="string">"/hello"</span>).To(hello))</span><br><span class="line">container.Add(ws)</span><br><span class="line">server := &amp;http.Server&#123;Addr: <span class="string">":8080"</span>, Handler: container&#125;</span><br><span class="line">log.Fatal(server.ListenAndServe())</span><br></pre></td></tr></table></figure>
<p>因为这里的 <code>Container</code> 实现了 <code>ServeHTTP</code> 接口，所以就可以直接作为一个Handler传递给 <code>http.Server</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServeHTTP implements net/http.Handler therefore a Container can be a Handler in a http.Server</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Container)</span> <span class="title">ServeHTTP</span><span class="params">(httpWriter http.ResponseWriter, httpRequest *http.Request)</span></span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">	c.ServeMux.ServeHTTP(writer, httpRequest)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="DefaultContainer"><a href="#DefaultContainer" class="headerlink" title="DefaultContainer"></a>DefaultContainer</h4><p>还是回到 <code>Hello World</code> 的示例，我们并没有发现 <code>Container</code> 的创建啊，那是如何实现关联的呢？这就借助来 <code>net/http</code> 的 <code>DefaultServeMux</code> 和 <code>go-restful</code> 的 <code>DefaultContainer</code>：</p>
<figure class="highlight go"><figcaption><span>go-resetful/web_service_container.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DefaultContainer is a restful.Container that uses http.DefaultServeMux</span></span><br><span class="line"><span class="keyword">var</span> DefaultContainer *Container</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	DefaultContainer = NewContainer()</span><br><span class="line">	DefaultContainer.ServeMux = http.DefaultServeMux</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add registers a new WebService add it to the DefaultContainer.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add</span><span class="params">(service *WebService)</span></span> &#123;</span><br><span class="line">	DefaultContainer.Add(service)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，在 <code>go-restful</code>包初始化的时候，默认就会创建一个 <code>DefaultContainer</code>，并且将它的 <code>ServeMux</code> 设置为了 <code>http.DefaultServeMux</code>。我们通过 <code>restful.Add(ws)</code> 给 <code>DefaultServeMux</code> 注册了 <code>WebService</code>，也就是把 <code>dispatch</code> 函数注册给了 <code>WebServer</code>，这样就可以使用 <code>http.DefaultServeMux</code> 的机制调用它们了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">restful.Add(ws)</span><br><span class="line">log.Fatal(http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>))</span><br></pre></td></tr></table></figure>
<h4 id="Dispatch"><a href="#Dispatch" class="headerlink" title="Dispatch"></a>Dispatch</h4><p><code>dispatch</code> 是整个框架最关键的函数了，它作为 <code>Container</code> 这个 <code>WebServer</code> 的入口，通过 <code>SelectRouter</code> 将路由分发给各个 <code>WebService</code>，再由 <code>WebService</code> 分发给具体的 <code>Handler</code> 函数。找到对应的 <code>WebService</code> 和 <code>Route</code> 之后，就可以运行 <code>Filters</code> 和把 <code>Route</code> 的 Function 作为 <code>Handler</code> 了。关于 <code>SelectRouter</code> 的实现，将会在后面的 <a href="#路由分发">路由分发</a> 介绍。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatch the incoming Http Request to a matching WebService.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Container)</span> <span class="title">dispatch</span><span class="params">(httpWriter http.ResponseWriter, httpRequest *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="comment">// so we can assign a compressing one later</span></span><br><span class="line">	writer := httpWriter</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Find best match Route ; err is non nil if no match was found</span></span><br><span class="line">	<span class="keyword">var</span> webService *WebService</span><br><span class="line">	<span class="keyword">var</span> route *Route</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		c.webServicesLock.RLock()</span><br><span class="line">		<span class="keyword">defer</span> c.webServicesLock.RUnlock()</span><br><span class="line">		webService, route, err = c.router.SelectRoute(</span><br><span class="line">			c.webServices,</span><br><span class="line">			httpRequest)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">	<span class="comment">// pass through filters (if any)</span></span><br><span class="line">	<span class="keyword">if</span> size := <span class="built_in">len</span>(c.containerFilters) + <span class="built_in">len</span>(webService.filters) + <span class="built_in">len</span>(route.Filters); size &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// compose filter chain</span></span><br><span class="line">		allFilters := <span class="built_in">make</span>([]FilterFunction, <span class="number">0</span>, size)</span><br><span class="line">		allFilters = <span class="built_in">append</span>(allFilters, c.containerFilters...)</span><br><span class="line">		allFilters = <span class="built_in">append</span>(allFilters, webService.filters...)</span><br><span class="line">		allFilters = <span class="built_in">append</span>(allFilters, route.Filters...)</span><br><span class="line">		chain := FilterChain&#123;Filters: allFilters, Target: route.Function&#125;</span><br><span class="line">		chain.ProcessFilter(wrappedRequest, wrappedResponse)</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h4><p>经过上面的讲解，我们现在可以实现一个稍微复杂一点的 <code>RESTful API</code> 了：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">    restful <span class="string">"github.com/emicklei/go-restful"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// This example has the same service definition as restful-user-resource</span></span><br><span class="line"><span class="comment">// but uses a different router (CurlyRouter) that does not use regular expressions</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// POST http://localhost:8080/users</span></span><br><span class="line"><span class="comment">// &lt;User&gt;&lt;Id&gt;1&lt;/Id&gt;&lt;Name&gt;Melissa Raspberry&lt;/Name&gt;&lt;/User&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// GET http://localhost:8080/users/1</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// PUT http://localhost:8080/users/1</span></span><br><span class="line"><span class="comment">// &lt;User&gt;&lt;Id&gt;1&lt;/Id&gt;&lt;Name&gt;Melissa&lt;/Name&gt;&lt;/User&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// DELETE http://localhost:8080/users/1</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Id, Name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserResource <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// normally one would use DAO (data access object)</span></span><br><span class="line">    users <span class="keyword">map</span>[<span class="keyword">string</span>]User</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u UserResource)</span> <span class="title">Register</span><span class="params">(container *restful.Container)</span></span> &#123;</span><br><span class="line">    ws := <span class="built_in">new</span>(restful.WebService)</span><br><span class="line">    ws.</span><br><span class="line">        Path(<span class="string">"/users"</span>).</span><br><span class="line">        Consumes(restful.MIME_XML, restful.MIME_JSON).</span><br><span class="line">        Produces(restful.MIME_JSON, restful.MIME_XML) <span class="comment">// you can specify this per route as well</span></span><br><span class="line"></span><br><span class="line">    ws.Route(ws.GET(<span class="string">"/&#123;user-id&#125;"</span>).To(u.findUser))</span><br><span class="line">    ws.Route(ws.POST(<span class="string">""</span>).To(u.updateUser))</span><br><span class="line">    ws.Route(ws.PUT(<span class="string">"/&#123;user-id&#125;"</span>).To(u.createUser))</span><br><span class="line">    ws.Route(ws.DELETE(<span class="string">"/&#123;user-id&#125;"</span>).To(u.removeUser))</span><br><span class="line"></span><br><span class="line">    container.Add(ws)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET http://localhost:8080/users/1</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u UserResource)</span> <span class="title">findUser</span><span class="params">(request *restful.Request, response *restful.Response)</span></span> &#123;</span><br><span class="line">    id := request.PathParameter(<span class="string">"user-id"</span>)</span><br><span class="line">    usr, ok := u.users[id]</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        response.AddHeader(<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">        response.WriteErrorString(http.StatusNotFound, <span class="string">"User could not be found."</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        response.WriteEntity(usr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST http://localhost:8080/users</span></span><br><span class="line"><span class="comment">// &lt;User&gt;&lt;Id&gt;1&lt;/Id&gt;&lt;Name&gt;Melissa Raspberry&lt;/Name&gt;&lt;/User&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserResource)</span> <span class="title">updateUser</span><span class="params">(request *restful.Request, response *restful.Response)</span></span> &#123;</span><br><span class="line">    usr := <span class="built_in">new</span>(User)</span><br><span class="line">    err := request.ReadEntity(&amp;usr)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">        u.users[usr.Id] = *usr</span><br><span class="line">        response.WriteEntity(usr)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        response.AddHeader(<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">        response.WriteErrorString(http.StatusInternalServerError, err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PUT http://localhost:8080/users/1</span></span><br><span class="line"><span class="comment">// &lt;User&gt;&lt;Id&gt;1&lt;/Id&gt;&lt;Name&gt;Melissa&lt;/Name&gt;&lt;/User&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserResource)</span> <span class="title">createUser</span><span class="params">(request *restful.Request, response *restful.Response)</span></span> &#123;</span><br><span class="line">    usr := User&#123;Id: request.PathParameter(<span class="string">"user-id"</span>)&#125;</span><br><span class="line">    err := request.ReadEntity(&amp;usr)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">        u.users[usr.Id] = usr</span><br><span class="line">        response.WriteHeaderAndEntity(http.StatusCreated, usr)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        response.AddHeader(<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">        response.WriteErrorString(http.StatusInternalServerError, err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DELETE http://localhost:8080/users/1</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserResource)</span> <span class="title">removeUser</span><span class="params">(request *restful.Request, response *restful.Response)</span></span> &#123;</span><br><span class="line">    id := request.PathParameter(<span class="string">"user-id"</span>)</span><br><span class="line">    <span class="built_in">delete</span>(u.users, id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    wsContainer := restful.NewContainer()</span><br><span class="line">    wsContainer.Router(restful.CurlyRouter&#123;&#125;)</span><br><span class="line">    u := UserResource&#123;<span class="keyword">map</span>[<span class="keyword">string</span>]User&#123;&#125;&#125;</span><br><span class="line">    u.Register(wsContainer)</span><br><span class="line"></span><br><span class="line">    log.Printf(<span class="string">"start listening on localhost:8080"</span>)</span><br><span class="line">    server := &amp;http.Server&#123;Addr: <span class="string">":8080"</span>, Handler: wsContainer&#125;</span><br><span class="line">    log.Fatal(server.ListenAndServe())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译运行上面这个程序，发出请求如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># Window 1</span></span><br><span class="line">$ go run user.go</span><br><span class="line">2020/12/05 18:36:27 start listening on localhost:8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># Window 2</span></span><br><span class="line">$ curl -X POST -v -i http://127.0.0.1:8080/users \ </span><br><span class="line">-H <span class="string">'Content-type: application/json'</span> \</span><br><span class="line">-H <span class="string">'Accept: application/xml'</span> \</span><br><span class="line">-d <span class="string">'&#123;"Id": "1", "Name": "Houmin"&#125;'</span></span><br><span class="line"></span><br><span class="line">Note: Unnecessary use of -X or --request, POST is already inferred.</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 8080 (<span class="comment">#0)</span></span><br><span class="line">&gt; POST /users HTTP/1.1</span><br><span class="line">&gt; Host: 127.0.0.1:8080</span><br><span class="line">&gt; User-Agent: curl/7.64.1</span><br><span class="line">&gt; Content-type: application/json</span><br><span class="line">&gt; Accept: application/xml</span><br><span class="line">&gt; Content-Length: 29</span><br><span class="line">&gt;</span><br><span class="line">* upload completely sent off: 29 out of 29 bytes</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">&lt; Content-Type: application/xml</span><br><span class="line">Content-Type: application/xml</span><br><span class="line">&lt; Date: Sat, 05 Dec 2020 10:36:32 GMT</span><br><span class="line">Date: Sat, 05 Dec 2020 10:36:32 GMT</span><br><span class="line">&lt; Content-Length: 90</span><br><span class="line">Content-Length: 90</span><br><span class="line"></span><br><span class="line">&lt;</span><br><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line"> &lt;User&gt;</span><br><span class="line">  &lt;Id&gt;1&lt;/Id&gt;</span><br><span class="line">  &lt;Name&gt;Houmin&lt;/Name&gt;</span><br><span class="line">* Connection <span class="comment">#0 to host 127.0.0.1 left intact</span></span><br><span class="line"> &lt;/User&gt;* Closing connection 0</span><br><span class="line"> </span><br><span class="line">$ curl -X GET -v -i http://127.0.0.1:8080/users/1</span><br><span class="line">Note: Unnecessary use of -X or --request, GET is already inferred.</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 8080 (<span class="comment">#0)</span></span><br><span class="line">&gt; GET /users/1 HTTP/1.1</span><br><span class="line">&gt; Host: 127.0.0.1:8080</span><br><span class="line">&gt; User-Agent: curl/7.64.1</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">&lt; Content-Type: application/json</span><br><span class="line">Content-Type: application/json</span><br><span class="line">&lt; Date: Sat, 05 Dec 2020 10:39:53 GMT</span><br><span class="line">Date: Sat, 05 Dec 2020 10:39:53 GMT</span><br><span class="line">&lt; Content-Length: 33</span><br><span class="line">Content-Length: 33</span><br><span class="line"></span><br><span class="line">&lt;</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">"Id"</span>: <span class="string">"1"</span>,</span><br><span class="line"> <span class="string">"Name"</span>: <span class="string">"Houmin"</span></span><br><span class="line">* Connection <span class="comment">#0 to host 127.0.0.1 left intact</span></span><br><span class="line">&#125;* Closing connection 0</span><br></pre></td></tr></table></figure>
<h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><p>过滤器可以动态拦截请求和响应，以及转换或使用请求和响应中包含的信息。用户可以使用过滤器来执行常规的日志记录、测量、验证、重定向、设置响应头部Header等。restful包中有三个针对请求、响应流的钩子，还可以添加过滤器。每个过滤器必须定义一个FilterFunction：<code>go-restful</code> 支持服务级、路由级的请求或响应过滤。开发者可以使用 Filter 来执行常规的日志记录、计量、验证、重定向、设置响应头部等工作。<code>go-restful</code> 提供了 3 个针对请求、响应的钩子（Hooks），此外，还可以实现自定义的 Filter。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> FilterFunction <span class="function"><span class="keyword">func</span><span class="params">(*Request, *Response, *FilterChain)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> FilterChain <span class="keyword">struct</span> &#123;</span><br><span class="line">	Filters []FilterFunction <span class="comment">// ordered list of FilterFunction</span></span><br><span class="line">	Index   <span class="keyword">int</span>              <span class="comment">// index into filters that is currently in progress</span></span><br><span class="line">	Target  RouteFunction    <span class="comment">// function to call after passing all filters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用如下语句传递请求/响应对到下一个过滤器或RouteFunction：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chain.ProcessFilter(req, resp)</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FilterChain)</span> <span class="title">ProcessFilter</span><span class="params">(request *Request, response *Response)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> f.Index &lt; <span class="built_in">len</span>(f.Filters) &#123;</span><br><span class="line">		f.Index++</span><br><span class="line">		f.Filters[f.Index<span class="number">-1</span>](request, response, f)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		f.Target(request, response)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Container-Filter"><a href="#Container-Filter" class="headerlink" title="Container Filter"></a>Container Filter</h3><p>在注册 WebService 之前处理</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 安装一个全局的 Filter 到 Default Container</span></span><br><span class="line">restful.Filter(globalLogging)</span><br></pre></td></tr></table></figure>
<p>在 <code>Container</code> 的数据结构中，我们看到了有 <code>containerFilters</code> 这样一个 <code>FilterFunction</code> 切片，上面调用的 <code>Filter</code> 函数是实际上就是将对应的 <code>FulterFunction</code> 加入到这个切片中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Filter appends a container FilterFunction. These are called before dispatching</span></span><br><span class="line"><span class="comment">// a http.Request to a WebService from the container</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Container)</span> <span class="title">Filter</span><span class="params">(filter FilterFunction)</span></span> &#123;</span><br><span class="line">	c.containerFilters = <span class="built_in">append</span>(c.containerFilters, filter)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Container</code> 调用 <code>Filter</code> 函数就是通过 <code>FilterChain</code> 的 <code>ProcessFilter</code> 来实现的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Container)</span> <span class="title">dispatch</span><span class="params">(httpWriter http.ResponseWriter, httpRequest *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">	<span class="comment">// pass through filters (if any)</span></span><br><span class="line">	<span class="keyword">if</span> size := <span class="built_in">len</span>(c.containerFilters) + <span class="built_in">len</span>(webService.filters) + <span class="built_in">len</span>(route.Filters); size &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// compose filter chain</span></span><br><span class="line">		allFilters := <span class="built_in">make</span>([]FilterFunction, <span class="number">0</span>, size)</span><br><span class="line">		allFilters = <span class="built_in">append</span>(allFilters, c.containerFilters...)</span><br><span class="line">		allFilters = <span class="built_in">append</span>(allFilters, webService.filters...)</span><br><span class="line">		allFilters = <span class="built_in">append</span>(allFilters, route.Filters...)</span><br><span class="line">		chain := FilterChain&#123;Filters: allFilters, Target: route.Function&#125;</span><br><span class="line">		chain.ProcessFilter(wrappedRequest, wrappedResponse)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// no filters, handle request by route</span></span><br><span class="line">		route.Function(wrappedRequest, wrappedResponse)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有的 <code>Filter</code> 执行完，就去执行 <code>Target Route</code>  的 <code>Function</code>，也就是用户注册的 handler。</p>
<h3 id="WebService-Filter"><a href="#WebService-Filter" class="headerlink" title="WebService Filter"></a>WebService Filter</h3><p>路由 WebService 之前处理</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 安装一个 WebService Filter</span></span><br><span class="line">ws.Filter(webserviceLogging).Filter(measureTime)</span><br></pre></td></tr></table></figure>
<p>在 <code>WebService</code> 的数据结构中，我们看到了有 <code>filters</code> 这个 <code>FilterFunction</code> 切片，上面调用的 <code>Filter</code> 函数是实际上就是将对应的 <code>FulterFunction</code> 加入到这个切片中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Filter adds a filter function to the chain of filters applicable to all its Routes</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *WebService)</span> <span class="title">Filter</span><span class="params">(filter FilterFunction)</span> *<span class="title">WebService</span></span> &#123;</span><br><span class="line">	w.filters = <span class="built_in">append</span>(w.filters, filter)</span><br><span class="line">	<span class="keyword">return</span> w</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而对于 <code>WebService</code> 的 Filter 函数调用，就是在 <code>Container</code> 的 <code>dispatch</code> 中实现的，见上面的代码。</p>
<h3 id="Route-Filter"><a href="#Route-Filter" class="headerlink" title="Route Filter"></a>Route Filter</h3><p>在调用 Router 相关的函数之前处理。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 安装 2 个链式的 Route Filter</span></span><br><span class="line">ws.Route(ws.GET(<span class="string">"/&#123;user-id&#125;"</span>).Filter(routeLogging).Filter(NewCountFilter().routeCounter))</span><br></pre></td></tr></table></figure>
<p><code>Route</code> 的 <code>Filter</code> 安装是通过 <code>RouterBuilder</code> 来实现的，之后会在 <code>Build()</code> 函数中将 <code>filters</code> 传递给 <code>Route</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Filter appends a FilterFunction to the end of filters for this Route to build.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *RouteBuilder)</span> <span class="title">Filter</span><span class="params">(filter FilterFunction)</span> *<span class="title">RouteBuilder</span></span> &#123;</span><br><span class="line">	b.filters = <span class="built_in">append</span>(b.filters, filter)</span><br><span class="line">	<span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 <code>Route</code> 的 Filter 函数调用，也是在 <code>Container</code> 的 <code>dispatch</code> 中实现的，见 <code>Container</code> 的代码。</p>
<h2 id="路由分发"><a href="#路由分发" class="headerlink" title="路由分发"></a>路由分发</h2><p>go-restful 支持两种路由分发器：快速路由 <code>CurlyRouter</code> 和 <code>RouterJSR311</code>。实际上，<code>CurlyRoute</code> 也是基于 <code>RouterJSR311</code> 的，相比 <code>RouterJSR11</code>，还支持了正则表达式和动态参数，也更加轻量级，Kubernetes ApiServer 中使用的就是这种路由。</p>
<p><code>CurlyRouter</code> 的元素包括：请求路径（<code>URL Path</code>），请求参数（<code>Parameter</code>），输入、输出类型（<code>Writes/Reads Model</code>），处理函数（<code>Handler</code>），响应内容类型（<code>Accept</code>）等。</p>
<h2 id="Response-Encoding"><a href="#Response-Encoding" class="headerlink" title="Response Encoding"></a>Response Encoding</h2><p>如果 <code>HTTP Request</code> 包含了 <code>Accept-Encoding Header</code>，那么 <code>HTTP Response</code> 就必须使用指定的编码格式进行压缩。<code>go-restful</code> 目前支持 <code>gzip</code> 、<code>deflate</code> 这两种响应编码格式。</p>
<p>如果要为所有的响应启用它们：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">restful.DefaultContainer.EnableContentEncoding(<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<p>同时，也可以通过创建一个 Filter 来实现自定义的响应编码过滤器，并将其安装到每一个 WebService 和 Route 上。</p>
<h2 id="OPTIONS支持"><a href="#OPTIONS支持" class="headerlink" title="OPTIONS支持"></a>OPTIONS支持</h2><p>通过安装预定义的容器过滤器，你的 <code>WebService</code> 可以响应 <code>HTTP OPTIONS</code> 请求。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Filter(OPTIONSFilter())</span><br></pre></td></tr></table></figure>
<h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h2><p>通过安装 <code>CrossOriginResourceSharing</code> 过滤器，使 WebService 可以响应 CORS 请求。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cors := CrossOriginResourceSharing&#123;</span><br><span class="line">    ExposeHeaders: []<span class="keyword">string</span>&#123;<span class="string">"X-My-Header"</span>&#125;,</span><br><span class="line">    CookiesAllowed: <span class="literal">false</span>,</span><br><span class="line">    Container: DefaultContainer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Filter(cors.Filter)</span><br></pre></td></tr></table></figure>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>意想不到的事情发生。如果因为故障而不能处理请求，服务端需要通过响应告诉客户端发生了什么和为什么。因此使用HTTP状态码，更重要的是要正确的使用状态码。</p>
<ul>
<li>400: Bad Request</li>
</ul>
<p>如果路径或查询参数无效（内容或类型），那么使用http.StatusBadRequest。</p>
<ul>
<li>404: Not Found</li>
</ul>
<p>尽管URI有效，但请求的资源可能不可用。</p>
<ul>
<li>500: Internal Server Error</li>
</ul>
<p>如果应用程序逻辑无法处理请求（或编写响应），则使用http.StatusInternalServerError。</p>
<ul>
<li>405: Method Not Allowed</li>
</ul>
<p>请求的URL是有效的，但请求使用的HTTP方法（GET，PUT，POST，…）是不允许的。</p>
<ul>
<li>406: Not Acceptable</li>
</ul>
<p>请求的头部没有或设置了未知Accept Header。</p>
<ul>
<li>415: Unsupported Media Type</li>
</ul>
<p>请求的头部没有或设置了未知的Content-Type报头。</p>
<h2 id="ServiceError"><a href="#ServiceError" class="headerlink" title="ServiceError"></a>ServiceError</h2><p>除了设置HTTP状态码，还应该为响应选择写适当的ServiceError消息。</p>
<h2 id="Performance-Options"><a href="#Performance-Options" class="headerlink" title="Performance Options"></a>Performance Options</h2><p>这个包有几个选项，它们可能会影响服务的性能。重要的是要理解这些选项，正确地设置它们。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">restful</span><span class="selector-class">.DefaultContainer</span><span class="selector-class">.DoNotRecover</span>(<span class="selector-tag">false</span>)</span><br></pre></td></tr></table></figure>
<p>DoNotRecover控制是否因返回HTTP 500状态码而（恐慌）停止服务。如果设置为false，那么容器Container会恢复服务。默认值为true。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">restful.SetCompressorProvider(NewBoundedCachedCompressors(<span class="number">20</span>, <span class="number">20</span>))</span><br></pre></td></tr></table></figure>
<p>如果启用了内容编码，那么获得新gzip/zlib输出器（writer）和读入器（reader）的默认策略是使用sync.Pool。由于输出器writer是昂贵的结构，当使用预加载缓存时性能提高非常明显。你也可以注入自己的实现。</p>
<h2 id="Trouble-shooting"><a href="#Trouble-shooting" class="headerlink" title="Trouble shooting"></a>Trouble shooting</h2><p>这个包可以对完整的Http请求的匹配过程和过滤器调用产生详细的日志记录。启用此功能需要你设置 <code>restful.StdLogger</code>的实现，例如 <code>log.Logger</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">restful.TraceLogger(log.New(os.Stdout, <span class="string">"[restful] "</span>, log.LstdFlags|logs.Lshortfile))</span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><p><a href="http://ernestmicklei.com/2012/11/go-restful-first-working-example/" target="_blank" rel="external nofollow noopener noreferrer">go-restful first working example</a></p>
</li>
<li><p><a href="http://ernestmicklei.com/2012/11/go-restful-api-design/" target="_blank" rel="external nofollow noopener noreferrer">go-restful desgin</a></p>
</li>
</ul>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章推荐</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/4dea1165/" rel="bookmark">【Go语言设计与实现】Test</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/cb5a5d4d/" rel="bookmark">【Go语言设计与实现】代码即文档</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/171a4821/" rel="bookmark">【Awesome Go】Cobra</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/b9b1d0f7/" rel="bookmark">【Go语言设计与实现】Array</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/251346e5/" rel="bookmark">【Go语言设计与实现】Slice</a></div>
    </li>
  </ul>

      
        <div class="reward-container">
  <div></div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/wechatpay.png" alt="Houmin 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/alipay.jpg" alt="Houmin 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Houmin
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://houmin.cc/posts/e3978252/" title="【Awesome Go】Go RESTful">http://houmin.cc/posts/e3978252/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Go/" rel="tag"><i class="fa fa-tag"></i> Go</a>
              <a href="/tags/REST/" rel="tag"><i class="fa fa-tag"></i> REST</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/posts/45b76dc5/" rel="next" title="RESTful API">
                  <i class="fa fa-chevron-left"></i> RESTful API
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/posts/c2f57f16/" rel="prev" title="得意忘形">
                  得意忘形 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="comments"></div>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#基本概念"><span class="nav-number">1.</span> <span class="nav-text">基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Route"><span class="nav-number">1.1.</span> <span class="nav-text">Route</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WebService"><span class="nav-number">1.2.</span> <span class="nav-text">WebService</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Root-Path"><span class="nav-number">1.2.1.</span> <span class="nav-text">Root Path</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RouteBuilder"><span class="nav-number">1.2.2.</span> <span class="nav-text">RouteBuilder</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Example"><span class="nav-number">1.2.3.</span> <span class="nav-text">Example</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Container"><span class="nav-number">1.3.</span> <span class="nav-text">Container</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ServeMux"><span class="nav-number">1.3.1.</span> <span class="nav-text">ServeMux</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DefaultContainer"><span class="nav-number">1.3.2.</span> <span class="nav-text">DefaultContainer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Dispatch"><span class="nav-number">1.3.3.</span> <span class="nav-text">Dispatch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Example-1"><span class="nav-number">1.3.4.</span> <span class="nav-text">Example</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#过滤器"><span class="nav-number">2.</span> <span class="nav-text">过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Container-Filter"><span class="nav-number">2.1.</span> <span class="nav-text">Container Filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WebService-Filter"><span class="nav-number">2.2.</span> <span class="nav-text">WebService Filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Route-Filter"><span class="nav-number">2.3.</span> <span class="nav-text">Route Filter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由分发"><span class="nav-number">3.</span> <span class="nav-text">路由分发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Response-Encoding"><span class="nav-number">4.</span> <span class="nav-text">Response Encoding</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OPTIONS支持"><span class="nav-number">5.</span> <span class="nav-text">OPTIONS支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CORS"><span class="nav-number">6.</span> <span class="nav-text">CORS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#异常处理"><span class="nav-number">7.</span> <span class="nav-text">异常处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ServiceError"><span class="nav-number">8.</span> <span class="nav-text">ServiceError</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Options"><span class="nav-number">9.</span> <span class="nav-text">Performance Options</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Trouble-shooting"><span class="nav-number">10.</span> <span class="nav-text">Trouble shooting</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">11.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Houmin" src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/avatar.png">
  <p class="site-author-name" itemprop="name">Houmin</p>
  <div class="site-description" itemprop="description">丈夫拥书万卷，何假南面百城</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">145</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">206</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/SimpCosm" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;SimpCosm" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weihoumin@gmail.com" title="E-Mail &amp;rarr; mailto:weihoumin@gmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="hitokoto">
    <!-- hitokoto -->
    <div id="hito-expression">:D 获取中...</div>

    <script src="https://cdn.jsdelivr.net/npm/bluebird@3/js/browser/bluebird.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@2.0.3/fetch.min.js"></script>
    <script>
      fetch('https://v1.hitokoto.cn')
        .then(function (res){
          return res.json();
        })
        .then(function (data) {
          var hitokoto = document.getElementById('hito-expression');
          hitokoto.innerText = data.hitokoto + '——【' + data.from + '】';
        })
        .catch(function (err) {
          console.error(err);
        })
    </script>
  </div>

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heartbeat"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Houmin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">1.5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">44:43</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>



  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.1.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  




  <script src="/js/local-search.js"></script>








<script>
if (document.querySelectorAll('div.pdf').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/pdfobject@2/pdfobject.min.js', () => {
    document.querySelectorAll('div.pdf').forEach(element => {
      PDFObject.embed(element.getAttribute('target'), element, {
        pdfOpenParams: {
          navpanes: 0,
          toolbar: 0,
          statusbar: 0,
          pagemode: 'thumbs',
          view: 'FitH'
        },
        PDFJS_URL: '/lib/pdf/web/viewer.html',
        height: element.getAttribute('height') || '800px'
      });
    });
  }, window.PDFObject);
}
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>



  

  

  


<script>
NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'iEBFuhVyk4tuhVYctQ265uid-gzGzoHsz',
    appKey: 'KGjOktrtgSEWK1v9DYA3T3Az',
    placeholder: "Just go go",
    avatar: 'retro',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: 'zh-cn' || 'zh-cn',
    path: location.pathname,
    recordIP: true,
    serverURLs: ''
  });
}, window.Valine);
</script>

</body>
</html>
