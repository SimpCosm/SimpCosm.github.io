<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="icon" type="image/png" sizes="32x32" href="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="Houmin" type="application/atom+xml">
  <meta name="google-site-verification" content="zdGhdEF7jHoJW58lsdN6l9JrQFjJFwakCIc7TbbosV0">
  <meta name="msvalidate.01" content="2F527B379ED5537861D0D38C2C754C2B">
  <meta name="baidu-site-verification" content="xAag2PqzKE">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css">
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":true},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: true,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="KVM 是必须依赖硬件虚拟化技术辅助（例如 Intel VT-x、AMD-V）的 Hypervisor：  CPU：有 VMX root 和 non-root 模式的支持，其运行效率是比较高的 内存：有 Intel EPT&#x2F;AMD NPT 的支持，内存虚拟化的效率也比较高 I&#x2F;O：KVM 客户机的 I&#x2F;O 操作需要VM-Exit到用户态由 QEMU 进行模拟。传统的方式是使用纯软件的方式来模拟 I">
<meta name="keywords" content="虚拟化,网络">
<meta property="og:type" content="article">
<meta property="og:title" content="半虚拟化 I&#x2F;O 框架 virtio">
<meta property="og:url" content="http://houmin.cc/posts/3675eff/index.html">
<meta property="og:site_name" content="Houmin">
<meta property="og:description" content="KVM 是必须依赖硬件虚拟化技术辅助（例如 Intel VT-x、AMD-V）的 Hypervisor：  CPU：有 VMX root 和 non-root 模式的支持，其运行效率是比较高的 内存：有 Intel EPT&#x2F;AMD NPT 的支持，内存虚拟化的效率也比较高 I&#x2F;O：KVM 客户机的 I&#x2F;O 操作需要VM-Exit到用户态由 QEMU 进行模拟。传统的方式是使用纯软件的方式来模拟 I">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/qemu-soft-io.jpg">
<meta property="og:image" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/virtio-overview.jpg">
<meta property="og:image" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/architecture.gif">
<meta property="og:image" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/virtio-layer.png">
<meta property="og:image" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/virtio-data-structure.gif">
<meta property="og:updated_time" content="2021-01-26T03:22:21.010Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/qemu-soft-io.jpg">

<link rel="canonical" href="http://houmin.cc/posts/3675eff/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>半虚拟化 I/O 框架 virtio | Houmin</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


  <script src="/js/photoswipe.min.js?v="></script>
  <script src="/js/photoswipe-ui-default.min.js?v="></script>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Houmin</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">Yesterday You Said Tomorrow</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-album">

    <a href="/album" rel="section"><i class="fa fa-fw fa-camera"></i>相册</a>

  </li>
        <li class="menu-item menu-item-movies">

    <a href="/movies/" rel="section"><i class="fa fa-fw fa-film"></i>观影</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="/books/" rel="section"><i class="fa fa-fw fa-book"></i>阅读</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://houmin.cc/posts/3675eff/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/avatar.png">
      <meta itemprop="name" content="Houmin">
      <meta itemprop="description" content="丈夫拥书万卷，何假南面百城">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Houmin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          半虚拟化 I/O 框架 virtio
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-14 22:49:16" itemprop="dateCreated datePublished" datetime="2020-04-14T22:49:16+08:00">2020-04-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9C%AF%E4%B8%9A%E4%B8%93%E6%94%BB/" itemprop="url" rel="index">
                    <span itemprop="name">术业专攻</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/posts/3675eff/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/posts/3675eff/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>28 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>KVM</strong> 是必须依赖<strong>硬件虚拟化技术</strong>辅助（例如 Intel VT-x、AMD-V）的 Hypervisor：</p>
<ul>
<li><strong>CPU</strong>：有 <strong>VMX root</strong> 和 <strong>non-root 模式</strong>的支持，其运行效率是比较高的</li>
<li><strong>内存</strong>：有 <strong>Intel EPT/AMD NPT</strong> 的支持，内存虚拟化的效率也比较高</li>
<li><strong>I/O</strong>：KVM 客户机的 I/O 操作需要<code>VM-Exit</code>到用户态由 QEMU 进行模拟。传统的方式是使用纯软件的方式来模拟 I/O 设备，效率并不高</li>
</ul>
<blockquote>
<p>为了解决 I/O 虚拟化效率低下的问题，可以在客户机中使用<strong>半虚拟化驱动</strong>（Paravirtualized Drivers，PV Drivers）来提高客户机的 I/O 性能。目前，KVM 中实现半虚拟化驱动的方式就是采用了<code>virtio</code>这个 Linux 下的设备驱动标准框架。</p>
</blockquote>
<p><strong>virtio</strong> 是 Linux 平台下一种 <strong>I/O 半虚拟化框架</strong>，由澳大利亚程序员 Rusty Russell 开发。他当时的目的是支持自己的虚拟化解决方案 Lguest，而在 KVM 中也广泛使用了 Virtio 作为半虚拟化 I/O 框架。</p>
<a id="more"></a>
<h2 id="软件方式模拟-I-O-设备"><a href="#软件方式模拟-I-O-设备" class="headerlink" title="软件方式模拟 I/O 设备"></a>软件方式模拟 I/O 设备</h2><h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><p>下图是 QEMU 以<strong>纯软件方式模拟 I/O 设备</strong>的示意图：</p>
<p><img alt="img" data-src="https://abelsu7.top/2019/09/02/virtio-in-kvm/qemu-soft-io.jpg"></p>
<ul>
<li>当 Guest 中的设备驱动程序<strong>发起 I/O 操作请求</strong>时，KVM 模块中的 <strong>I/O Trap Code 会拦截这次 I/O 请求</strong>，经过处理后将本次 I/O 请求的信息存放到 <strong>I/O sharing page</strong> 中，并通知用户空间的 QEMU</li>
<li>QEMU 从 I/O sharing page 中获得 I/O 操作的具体信息后，交由<strong>硬件模拟代码（QEMU I/O Emulation Code）</strong>来模拟本次 I/O 操作</li>
<li>模拟代码负责<strong>和实际的设备驱动进行交互，模拟此次 I/O 操作</strong>，获取返回结果并将其放回 I/O Sharing Page 中</li>
<li>最后，KVM 中的 I/O Trap Code 负责读取 I/O Sharing Page 中的操作结果，并<strong>将结果返回到客户机中</strong></li>
</ul>
<p>需要注意的是：</p>
<ul>
<li><strong>客户机</strong>作为一个QEMU 进程，在<strong>等待 I/O 时也可能被阻塞</strong></li>
<li>当<strong>客户机通过 DMA 方式访问大块 I/O</strong> 时，QEMU 不会把 I/O 操作结果放到 I/O 共享页中，而是通过<strong>内存映射</strong>的方式将结果直接写进客户机的内存中，然后通过 KVM 模块告诉客户机 DMA 操作已经完成</li>
</ul>
<h3 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3><ul>
<li>优点：可以通过软件模拟出各类硬件设备，而<strong>无需修改客户机操作系统</strong></li>
<li>缺点：每次 <strong>I/O 操作的路径较长</strong>，有较多的<code>VM-Entry</code>、<code>VM-Exit</code>发生，需要<strong>多次上下文切换</strong>，也需要<strong>多次数据复制</strong>，因此性能较差</li>
</ul>
<h2 id="半虚拟化-I-O-框架-virtio"><a href="#半虚拟化-I-O-框架-virtio" class="headerlink" title="半虚拟化 I/O 框架 virtio"></a>半虚拟化 I/O 框架 virtio</h2><h3 id="基本原理-1"><a href="#基本原理-1" class="headerlink" title="基本原理"></a>基本原理</h3><p><img alt="img" data-src="https://abelsu7.top/2019/09/02/virtio-in-kvm/virtio-overview.jpg"></p>
<p>如图所示，virtio 分为了<strong>前端驱动</strong>和<strong>后端驱动</strong>：</p>
<ul>
<li><strong>前端驱动 frontend</strong>：如<code>virtio_blk</code>、<code>virtio_net</code>等，是在客户机中存在的<strong>驱动程序模块</strong></li>
<li><strong>后端驱动 backend</strong>：在 QEMU 中实现</li>
</ul>
<p>在前后端驱动之间，还定义了两层来支持客户机和 QEMU 之间的通信：</p>
<ul>
<li><strong>virtio 层</strong>：<strong>虚拟队列接口</strong>，它在概念上将前端驱动程序附加到后端处理程序。<strong><em>一个前端驱动程序可以使用 0 个或多个队列\</em></strong>，具体数量取决于需求</li>
</ul>
<blockquote>
<p>例如：<code>virtio_net</code>网络驱动程序使用<strong>两个虚拟队列（接收/发送）</strong>，而<code>virtio_blk</code>驱动仅使用<strong>一个虚拟队列</strong>。<br>虚拟队列实际上被实现为客户机操作系统和 Hypervisor 之间的衔接点，但它可以通过任意方式实现，前提是客户机操作系统和 virtio 后端程序都遵循一定的标准，以相互匹配的方式实现它。</p>
</blockquote>
<ul>
<li><strong>virtio-ring 层</strong>：实现了<strong>环形缓冲区（ring buffer）</strong>，用于保存前端驱动和后端处理程序执行的信息，并且它可以<strong>一次性保存前端驱动的多次 I/O 请求，再交由后端驱动批量处理</strong>，最后实际调用宿主机中的设备驱动来完成物理层面上的 I/O 操作。</li>
</ul>
<blockquote>
<p>这样做就可以根据约定实现<strong>批量处理</strong>而不是客户机中每次 I/O 请求都需要处理一次，从而<strong>提高了客户机与 Hypervisor 之间信息交换的效率</strong></p>
</blockquote>
<h3 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h3><ul>
<li>优点：可获得很好的 I/O 性能，接近 Native。所以在使用 KVM 时，如果宿主机和客户机都支持 Virtio，一般都推荐使用 Virtio 以达到更高的 I/O 性能</li>
<li>缺点：必须在客户机中安装前端驱动，且按照 Virtio 的规定格式进行数据传输</li>
</ul>
<h2 id="virtio-的架构"><a href="#virtio-的架构" class="headerlink" title="virtio 的架构"></a>virtio 的架构</h2><p><strong>virtio</strong> 是半虚拟化的解决方案，是<strong>半虚拟化 Hypervisor</strong> 的一组<strong>通用 I/O 设备的抽象</strong>。它提供了一套上层应用与各 Hypervisor 虚拟化设备（KVM、Xen、VMware 等）之间的通信框架和编程接口，减少了跨平台所带来的兼容性问题。<strong>客户机需要知道自己运行在虚拟化环境中</strong>，进而根据 Virtio 标准和 Hypervisor 协作，从而提高 I/O 性能。</p>
<p><img alt="img" data-src="https://abelsu7.top/2019/09/02/virtio-in-kvm/architecture.gif"></p>
<ul>
<li><strong>前端驱动</strong>：Frontend Driver，是位于<strong>客户机内核</strong>中的<strong>驱动程序模块</strong></li>
<li><strong>后端驱动</strong>：Backend Driver，在<strong>宿主机用户空间</strong>的 <strong>QEMU</strong> 中实现</li>
</ul>
<blockquote>
<p>virtio 是半虚拟化驱动框架，可以提供接近 Native 的 I/O 性能，但是客户机中必须安装特定的 virtio 驱动，并按照 virtio 的规定格式进行数据传输</p>
</blockquote>
<h3 id="版本要求"><a href="#版本要求" class="headerlink" title="版本要求"></a>版本要求</h3><p><code>Kernel &gt;= 2.6.25</code>的内核都支持 virtio。由于 virtio 的后端处理程序是在位于用户空间中的 QEMU 中实现的，所以<strong>宿主机只需要比较新的内核即可</strong>，不需要特别编译 virtio 相关驱动。而<strong>客户机需要有特定 virtio 驱动程序的支持</strong>，以便客户机处理 I/O 操作请求时调用前端驱动。</p>
<p><strong>客户机内核</strong>中关于 virtio 的部分配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要启用的选项</span></span><br><span class="line">CONFIG_VIRTIO_PCI=m</span><br><span class="line">CONFIG_VIRTIO_BALLOON=m</span><br><span class="line">CONFIG_VIRTIO_BLK=m</span><br><span class="line">CONFIG_VIRTIO_NET=m</span><br><span class="line">CONFIG_VIRTIO=m</span><br><span class="line">CONFIG_VIRTIO_RING=y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他相关的选项</span></span><br><span class="line">CONFIG_VIRTIO_VSOCKETS=m</span><br><span class="line">CONFIG_VIRTIO_VSOCKETS_COMMON=m</span><br><span class="line">CONFIG_SCSI_VIRTIO=m</span><br><span class="line">CONFIG_VIRTIO_CONSOLE=m</span><br><span class="line">CONFIG_HW_RANDOM_VIRTIO=m</span><br><span class="line">CONFIG_DRM_VIRTIO_GPU=m</span><br><span class="line">CONFIG_VIRTIO_PCI_LEGACY=y</span><br><span class="line">CONFIG_VIRTIO_INPUT=m</span><br><span class="line"><span class="comment"># CONFIG_VIRTIO_MMIO is not set</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在子机中查看 VIRTIO 相关内核模块</span></span><br><span class="line">&gt; lsmod | grep virtio</span><br><span class="line">virtio_balloon         18015  0 </span><br><span class="line">virtio_net             28063  0 </span><br><span class="line">virtio_blk             18166  2 </span><br><span class="line">virtio_pci             22934  0 </span><br><span class="line">virtio_ring            22746  4 virtio_blk,virtio_net,virtio_pci,virtio_balloon</span><br><span class="line">virtio                 14959  4 virtio_blk,virtio_net,virtio_pci,virtio_balloon</span><br></pre></td></tr></table></figure>
<h3 id="层次结构"><a href="#层次结构" class="headerlink" title="层次结构"></a>层次结构</h3><p><img alt="img" data-src="https://abelsu7.top/2019/09/02/virtio-in-kvm/virtio-layer.png"></p>
<p>如图所示，virtio 大致分为三个层次：<strong>前端驱动</strong>（位于客户机）、<strong>后端驱动</strong>（位于 QEMU）以及中间的<strong>传输层</strong>。</p>
<p>每一个 virtio 设备（块设备、网卡等）在系统层面看来，都是一个 <strong>PCI 设备</strong>。这些设备之间有共性部分，也有差异部分。</p>
<p><strong>共性部分</strong>：</p>
<ol>
<li>都需要<strong>挂接相应的 buffer 队列操作 virtqueue_ops</strong></li>
<li>都需要<strong>申请若干个 buffer 队列</strong>，当执行 I/O 输出时，需要<strong>向队列写入数据</strong></li>
<li>都需要<strong>执行 pci_iomap 将设备配置寄存器区间映射到内存区间</strong></li>
<li>都需要<strong>设置中断处理</strong></li>
<li>等中断来了，都需要<strong>从队列读出数据</strong>，并<strong>通知客户机系统，数据已入队</strong></li>
</ol>
<p><strong>差异部分</strong>：</p>
<ul>
<li>与设备相关联的系统、业务、队列中<strong>写入的数据含义各不相同</strong></li>
<li>例如，网卡在内核中是一个<code>net_device</code>，与协议栈系统关联起来。同时，向队列中写入什么数据、数据的含义如何，各个设备也不相同。队列中来了什么数据，是什么含义，如何处理，各个设备也不相同</li>
</ul>
<blockquote>
<p>如果每个 virtio 设备都完整的实现自己的功能，就会造成不必要的代码冗余。针对这个问题，virtio 又设计了<code>virtio_pci</code>模块，以处理所有 virtio 设备的共性部分。这样一来<strong>所有的 virtio 设备在系统看来都是一个 PCI 设备，其设备驱动都是</strong><code>virtio_pci</code></p>
</blockquote>
<p>但是，<code>virtio_pci</code>并不能完整的驱动任何一个设备。因此，<code>virtio_pci</code>在调用<code>probe()</code>接管每一个设备时，会<strong>根据其</strong><code>virtio_device_id</code><strong>来识别出具体是哪一种设备</strong>，然后相应的<strong>向内核注册一个 virtio 类型的设备</strong>。</p>
<p>在注册设备之前，<code>virtio_pci</code>驱动已经为该设备做了许多<strong>共性操作</strong>，同时还为该设备提供了各种操作的<strong>适配接口</strong>，这些都通过<code>virtio_config_ops</code>来适配。</p>
<h3 id="前端代码层次结构"><a href="#前端代码层次结构" class="headerlink" title="前端代码层次结构"></a>前端代码层次结构</h3><h4 id="相关源码文件"><a href="#相关源码文件" class="headerlink" title="相关源码文件"></a>相关源码文件</h4><p><code>Kernel 3.10.0</code>中关于 virito 的<strong>重要源码文件</strong>如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">drivers/block/virtio_blk.c</span><br><span class="line">drivers/<span class="keyword">char</span>/hw_random/virtio_rng.c</span><br><span class="line">drivers/<span class="keyword">char</span>/virtio_console.c</span><br><span class="line">drivers/net/virtio_net.c</span><br><span class="line">drivers/scsi/virtio_scsi.c</span><br><span class="line">drivers/virtio/virtio_balloon.c</span><br><span class="line">drivers/virtio/virtio_mmio.c</span><br><span class="line">drivers/virtio/virtio_pci.c</span><br><span class="line">drivers/virtio/virtio_ring.c</span><br><span class="line">drivers/virtio/virtio.c</span><br><span class="line"></span><br><span class="line">include/linux/virtio_caif.h</span><br><span class="line">include/linux/virtio_config.h</span><br><span class="line">include/linux/virtio_console.h</span><br><span class="line">include/linux/virtio_mmio.h</span><br><span class="line">include/linux/virtio_ring.h</span><br><span class="line">include/linux/virtio_scsi.h</span><br><span class="line">include/linux/virtio.h</span><br><span class="line">include/linux/vring.h</span><br><span class="line"></span><br><span class="line">include/uapi/linux/virtio_9p.h</span><br><span class="line">include/uapi/linux/virtio_balloon.h</span><br><span class="line">include/uapi/linux/virtio_blk.h</span><br><span class="line">include/uapi/linux/virtio_config.h</span><br><span class="line">include/uapi/linux/virtio_console.h</span><br><span class="line">include/uapi/linux/virtio_ids.h</span><br><span class="line">include/uapi/linux/virtio_net.h</span><br><span class="line">include/uapi/linux/virtio_pci.h</span><br><span class="line">include/uapi/linux/virtio_ring.h</span><br><span class="line">include/uapi/linux/virtio_rng.h</span><br><span class="line"></span><br><span class="line">tools/virtio/linux/virtio_config.h</span><br><span class="line">tools/virtio/linux/virtio_ring.h</span><br><span class="line">tools/virtio/linux/virtio.h</span><br><span class="line">tools/virtio/linux/vring.h</span><br><span class="line">tools/virtio/vitrio_test.c</span><br><span class="line">tools/virtio/vringh_test.c</span><br><span class="line"></span><br><span class="line">linux<span class="number">-3.10</span></span><br><span class="line"> ├─ drivers</span><br><span class="line"> |   ├─ block</span><br><span class="line"> |   |   └─ virtio_blk.c</span><br><span class="line"> |   |</span><br><span class="line"> |   ├─ <span class="keyword">char</span></span><br><span class="line"> |   |   ├─ hw_random</span><br><span class="line"> |   |   |   └─ virtio_rng.c</span><br><span class="line"> |   |   |</span><br><span class="line"> |   |   └─ virtio_console.c</span><br><span class="line"> |   |</span><br><span class="line"> |   ├─ net</span><br><span class="line"> |   |   └─ virtio_net.c</span><br><span class="line"> |   |</span><br><span class="line"> |   ├─ scsi</span><br><span class="line"> |   |   └─ virtio_scsi.c</span><br><span class="line"> |   |   </span><br><span class="line"> |   └─ virtio</span><br><span class="line"> |       ├─ virtio_balloon.c</span><br><span class="line"> |       ├─ virtio_mmio.c</span><br><span class="line"> |       ├─ virtio_pci.c</span><br><span class="line"> |       ├─ virtio_ring.c</span><br><span class="line"> |       └─ virtio.c </span><br><span class="line"> |</span><br><span class="line"> ├─ include</span><br><span class="line"> |   ├─ linux</span><br><span class="line"> |   |   ├─ virtio_caif.h</span><br><span class="line"> |   |   ├─ virtio_config.h</span><br><span class="line"> |   |   ├─ virtio_console.h</span><br><span class="line"> |   |   ├─ virtio_mmio.h</span><br><span class="line"> |   |   ├─ virtio_ring.h</span><br><span class="line"> |   |   ├─ virtio_scsi.h</span><br><span class="line"> |   |   ├─ virtio.h</span><br><span class="line"> |   |   └─ vring.h</span><br><span class="line"> |   |</span><br><span class="line"> |   └─ uapi</span><br><span class="line"> |       └─ linux</span><br><span class="line"> |           ├─ virtio_9p.h</span><br><span class="line"> |           ├─ virtio_balloon.h</span><br><span class="line"> |           ├─ virtio_blk.h</span><br><span class="line"> |           ├─ virtio_config.h</span><br><span class="line"> |           ├─ virtio_console.h</span><br><span class="line"> |           ├─ virtio_ids.h</span><br><span class="line"> |           ├─ virtio_net.h</span><br><span class="line"> |           ├─ virtio_pci.h    </span><br><span class="line"> |           ├─ virtio_ring.h</span><br><span class="line"> |           └─ virtio_rng.h</span><br><span class="line"> |</span><br><span class="line"> └─ tools</span><br><span class="line">     └─ virtio</span><br><span class="line">         ├─ linux</span><br><span class="line">         |   ├─ virtio_config.h</span><br><span class="line">         |   ├─ virtio_ring.h</span><br><span class="line">         |   ├─ virtio.h</span><br><span class="line">         |   └─ vring.h</span><br><span class="line">         |</span><br><span class="line">         ├─ virtio_test.c</span><br><span class="line">         └─ vringh_test.c</span><br></pre></td></tr></table></figure>
<h4 id="类结构层次"><a href="#类结构层次" class="headerlink" title="类结构层次"></a>类结构层次</h4><p>在 <strong>virtio 前端驱动</strong>即<strong>客户机内核</strong>中，virtio 的<strong>类层次结构</strong>如下图所示：</p>
<p><img alt="img" data-src="https://abelsu7.top/2019/09/02/virtio-in-kvm/virtio-data-structure.gif"></p>
<h4 id="virtio-driver"><a href="#virtio-driver" class="headerlink" title="virtio_driver"></a>virtio_driver</h4><p>最顶级的是<code>virtio_driver</code>，在客户机 OS 中表示<strong>前端驱动程序</strong>，在<code>include/linux/virtio.h</code>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * virtio_driver - operations for a virtio I/O driver</span></span><br><span class="line"><span class="comment"> * @driver: underlying device driver (populate name and owner).</span></span><br><span class="line"><span class="comment"> * @id_table: the ids serviced by this driver.</span></span><br><span class="line"><span class="comment"> * @feature_table: an array of feature numbers supported by this driver.</span></span><br><span class="line"><span class="comment"> * @feature_table_size: number of entries in the feature table array.</span></span><br><span class="line"><span class="comment"> * @probe: the function to call when a device is found.  Returns 0 or -errno.</span></span><br><span class="line"><span class="comment"> * @remove: the function to call when a device is removed.</span></span><br><span class="line"><span class="comment"> * @config_changed: optional function to call when the device configuration</span></span><br><span class="line"><span class="comment"> *    changes; may be called in interrupt context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtio_driver</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span> <span class="title">driver</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">virtio_device_id</span> *<span class="title">id_table</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *feature_table;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> feature_table_size;</span><br><span class="line">    <span class="keyword">int</span> (*probe)(struct virtio_device *dev);</span><br><span class="line">    <span class="keyword">void</span> (*scan)(struct virtio_device *dev);</span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">remove</span>)(struct virtio_device *dev);</span><br><span class="line">    <span class="keyword">void</span> (*config_changed)(struct virtio_device *dev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PM</span></span><br><span class="line">    <span class="keyword">int</span> (*freeze)(struct virtio_device *dev);</span><br><span class="line">    <span class="keyword">int</span> (*restore)(struct virtio_device *dev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="virtio-device-id"><a href="#virtio-device-id" class="headerlink" title="virtio_device_id"></a>virtio_device_id</h4><p>每个 virtio 设备都有其对应的<code>virtio_device_id</code>，该结构体在<code>include/linux/mod_devicetable.h</code>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtio_device_id</span> &#123;</span></span><br><span class="line">    __u32 device;</span><br><span class="line">    __u32 vendor;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VIRTIO_DEV_ANY_ID    0xffffffff</span></span><br></pre></td></tr></table></figure>
<h4 id="virtio-device"><a href="#virtio-device" class="headerlink" title="virtio_device"></a>virtio_device</h4><p>与驱动程序匹配的设备由<code>virtio_device</code>封装，它表示<strong>在客户机 OS 中的设备</strong>，在<code>include/linux/virtio.h</code>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * virtio_device - representation of a device using virtio</span></span><br><span class="line"><span class="comment"> * @index: unique position on the virtio bus</span></span><br><span class="line"><span class="comment"> * @dev: underlying device.</span></span><br><span class="line"><span class="comment"> * @id: the device type identification (used to match it with a driver).</span></span><br><span class="line"><span class="comment"> * @config: the configuration ops for this device.</span></span><br><span class="line"><span class="comment"> * @vringh_config: configuration ops for host vrings.</span></span><br><span class="line"><span class="comment"> * @vqs: the list of virtqueues for this device.</span></span><br><span class="line"><span class="comment"> * @features: the features supported by both driver and device.</span></span><br><span class="line"><span class="comment"> * @priv: private pointer for the driver's use.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtio_device</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">virtio_device_id</span> <span class="title">id</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">virtio_config_ops</span> *<span class="title">config</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vringh_config_ops</span> *<span class="title">vringh_config</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">vqs</span>;</span></span><br><span class="line">    <span class="comment">/* Note that this is a Linux set_bit-style bitmap. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> features[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">void</span> *priv;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="virtio-config-ops"><a href="#virtio-config-ops" class="headerlink" title="virtio_config_ops"></a>virtio_config_ops</h4><p>每一个<code>virtio_device</code>都有一个<code>virtio_config_ops</code>类型的指针<code>*config</code>，它定义了<strong>配置 virtio 设备的操作</strong>，该结构体在<code>include/linux/virtio_config.h</code>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * virtio_config_ops - operations for configuring a virtio device</span></span><br><span class="line"><span class="comment"> * @get: read the value of a configuration field</span></span><br><span class="line"><span class="comment"> * @set: write the value of a configuration field</span></span><br><span class="line"><span class="comment"> * @get_status: read the status byte</span></span><br><span class="line"><span class="comment"> * @set_status: write the status byte</span></span><br><span class="line"><span class="comment"> * @reset: reset the device</span></span><br><span class="line"><span class="comment"> * @find_vqs: find virtqueues and instantiate them.</span></span><br><span class="line"><span class="comment"> * @del_vqs: free virtqueues found by find_vqs().</span></span><br><span class="line"><span class="comment"> * @get_features: get the array of feature bits for this device.</span></span><br><span class="line"><span class="comment"> * @finalize_features: confirm what device features we'll be using.</span></span><br><span class="line"><span class="comment"> * @bus_name: return the bus name associated with the device</span></span><br><span class="line"><span class="comment"> * @set_vq_affinity: set the affinity for a virtqueue.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtio_config_ops</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">get</span>)(struct virtio_device *vdev, <span class="keyword">unsigned</span> offset,</span><br><span class="line">            <span class="keyword">void</span> *buf, <span class="keyword">unsigned</span> len);</span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">set</span>)(struct virtio_device *vdev, <span class="keyword">unsigned</span> offset,</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">unsigned</span> len);</span><br><span class="line">    u8 (*get_status)(struct virtio_device *vdev);</span><br><span class="line">    <span class="keyword">void</span> (*set_status)(struct virtio_device *vdev, u8 status);</span><br><span class="line">    <span class="keyword">void</span> (*reset)(struct virtio_device *vdev);</span><br><span class="line">    <span class="keyword">int</span> (*find_vqs)(struct virtio_device *, <span class="keyword">unsigned</span> nvqs,</span><br><span class="line">            struct virtqueue *vqs[],</span><br><span class="line">            <span class="keyword">vq_callback_t</span> *callbacks[],</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *names[]);</span><br><span class="line">    <span class="keyword">void</span> (*del_vqs)(struct virtio_device *);</span><br><span class="line">    u32 (*get_features)(struct virtio_device *vdev);</span><br><span class="line">    <span class="keyword">void</span> (*finalize_features)(struct virtio_device *vdev);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *(*bus_name)(struct virtio_device *vdev);</span><br><span class="line">    <span class="keyword">int</span> (*set_vq_affinity)(struct virtqueue *vq, <span class="keyword">int</span> cpu);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="virtqueue"><a href="#virtqueue" class="headerlink" title="virtqueue"></a>virtqueue</h4><p>每一个<code>virtqueue</code>包含了对应的<code>virtio_device</code>以及对应的<strong>队列操作回调函数</strong>，它在<code>include/linux/virtio.h</code>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * virtqueue - a queue to register buffers for sending or receiving.</span></span><br><span class="line"><span class="comment"> * @list: the chain of virtqueues for this device</span></span><br><span class="line"><span class="comment"> * @callback: the function to call when buffers are consumed (can be NULL).</span></span><br><span class="line"><span class="comment"> * @name: the name of this virtqueue (mainly for debugging)</span></span><br><span class="line"><span class="comment"> * @vdev: the virtio device this queue was created for.</span></span><br><span class="line"><span class="comment"> * @priv: a pointer for the virtqueue implementation to use.</span></span><br><span class="line"><span class="comment"> * @index: the zero-based ordinal number for this queue.</span></span><br><span class="line"><span class="comment"> * @num_free: number of elements we expect to be able to fit.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A note on @num_free: with indirect buffers, each buffer needs one</span></span><br><span class="line"><span class="comment"> * element in the queue, otherwise a buffer will need one element per</span></span><br><span class="line"><span class="comment"> * sg element.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtqueue</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="keyword">void</span> (*callback)(struct virtqueue *vq);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">virtio_device</span> *<span class="title">vdev</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> num_free;</span><br><span class="line">    <span class="keyword">void</span> *priv;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="相关数据结构"><a href="#相关数据结构" class="headerlink" title="相关数据结构"></a>相关数据结构</h2><h3 id="前端-Kernel"><a href="#前端-Kernel" class="headerlink" title="前端 Kernel"></a>前端 Kernel</h3><h4 id="virtio-driver-1"><a href="#virtio-driver-1" class="headerlink" title="virtio_driver"></a>virtio_driver</h4><p>在<code>include/linux/virtio.h</code>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * virtio_driver - operations for a virtio I/O driver</span></span><br><span class="line"><span class="comment"> * @driver: underlying device driver (populate name and owner).</span></span><br><span class="line"><span class="comment"> * @id_table: the ids serviced by this driver.</span></span><br><span class="line"><span class="comment"> * @feature_table: an array of feature numbers supported by this driver.</span></span><br><span class="line"><span class="comment"> * @feature_table_size: number of entries in the feature table array.</span></span><br><span class="line"><span class="comment"> * @probe: the function to call when a device is found.  Returns 0 or -errno.</span></span><br><span class="line"><span class="comment"> * @remove: the function to call when a device is removed.</span></span><br><span class="line"><span class="comment"> * @config_changed: optional function to call when the device configuration</span></span><br><span class="line"><span class="comment"> *    changes; may be called in interrupt context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtio_driver</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span> <span class="title">driver</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">virtio_device_id</span> *<span class="title">id_table</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *feature_table;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> feature_table_size;</span><br><span class="line">    <span class="keyword">int</span> (*probe)(struct virtio_device *dev);</span><br><span class="line">    <span class="keyword">void</span> (*scan)(struct virtio_device *dev);</span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">remove</span>)(struct virtio_device *dev);</span><br><span class="line">    <span class="keyword">void</span> (*config_changed)(struct virtio_device *dev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PM</span></span><br><span class="line">    <span class="keyword">int</span> (*freeze)(struct virtio_device *dev);</span><br><span class="line">    <span class="keyword">int</span> (*restore)(struct virtio_device *dev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>C</p>
<p>这里的<code>virtio_device_id</code>有两个字段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtio_device_id</span> &#123;</span></span><br><span class="line">    __u32 device;</span><br><span class="line">    __u32 vendor;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VIRTIO_DEV_ANY_ID    0xffffffff</span></span><br></pre></td></tr></table></figure>
<p>C</p>
<p>Copy</p>
<h4 id="virtio-device-1"><a href="#virtio-device-1" class="headerlink" title="virtio_device"></a>virtio_device</h4><p>在<code>include/linux/virtio.h</code>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * virtio_device - representation of a device using virtio</span></span><br><span class="line"><span class="comment"> * @index: unique position on the virtio bus</span></span><br><span class="line"><span class="comment"> * @dev: underlying device.</span></span><br><span class="line"><span class="comment"> * @id: the device type identification (used to match it with a driver).</span></span><br><span class="line"><span class="comment"> * @config: the configuration ops for this device.</span></span><br><span class="line"><span class="comment"> * @vringh_config: configuration ops for host vrings.</span></span><br><span class="line"><span class="comment"> * @vqs: the list of virtqueues for this device.</span></span><br><span class="line"><span class="comment"> * @features: the features supported by both driver and device.</span></span><br><span class="line"><span class="comment"> * @priv: private pointer for the driver's use.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtio_device</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">virtio_device_id</span> <span class="title">id</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">virtio_config_ops</span> *<span class="title">config</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vringh_config_ops</span> *<span class="title">vringh_config</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">vqs</span>;</span></span><br><span class="line">    <span class="comment">/* Note that this is a Linux set_bit-style bitmap. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> features[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">void</span> *priv;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>C</p>
<p>Copy</p>
<h4 id="virtio-config-ops-1"><a href="#virtio-config-ops-1" class="headerlink" title="virtio_config_ops"></a>virtio_config_ops</h4><p>在<code>include/linux/virtio_config.h</code>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * virtio_config_ops - operations for configuring a virtio device</span></span><br><span class="line"><span class="comment"> * @get: read the value of a configuration field</span></span><br><span class="line"><span class="comment"> *    vdev: the virtio_device</span></span><br><span class="line"><span class="comment"> *    offset: the offset of the configuration field</span></span><br><span class="line"><span class="comment"> *    buf: the buffer to write the field value into.</span></span><br><span class="line"><span class="comment"> *    len: the length of the buffer</span></span><br><span class="line"><span class="comment"> * @set: write the value of a configuration field</span></span><br><span class="line"><span class="comment"> *    vdev: the virtio_device</span></span><br><span class="line"><span class="comment"> *    offset: the offset of the configuration field</span></span><br><span class="line"><span class="comment"> *    buf: the buffer to read the field value from.</span></span><br><span class="line"><span class="comment"> *    len: the length of the buffer</span></span><br><span class="line"><span class="comment"> * @get_status: read the status byte</span></span><br><span class="line"><span class="comment"> *    vdev: the virtio_device</span></span><br><span class="line"><span class="comment"> *    Returns the status byte</span></span><br><span class="line"><span class="comment"> * @set_status: write the status byte</span></span><br><span class="line"><span class="comment"> *    vdev: the virtio_device</span></span><br><span class="line"><span class="comment"> *    status: the new status byte</span></span><br><span class="line"><span class="comment"> * @reset: reset the device</span></span><br><span class="line"><span class="comment"> *    vdev: the virtio device</span></span><br><span class="line"><span class="comment"> *    After this, status and feature negotiation must be done again</span></span><br><span class="line"><span class="comment"> *    Device must not be reset from its vq/config callbacks, or in</span></span><br><span class="line"><span class="comment"> *    parallel with being added/removed.</span></span><br><span class="line"><span class="comment"> * @find_vqs: find virtqueues and instantiate them.</span></span><br><span class="line"><span class="comment"> *    vdev: the virtio_device</span></span><br><span class="line"><span class="comment"> *    nvqs: the number of virtqueues to find</span></span><br><span class="line"><span class="comment"> *    vqs: on success, includes new virtqueues</span></span><br><span class="line"><span class="comment"> *    callbacks: array of callbacks, for each virtqueue</span></span><br><span class="line"><span class="comment"> *        include a NULL entry for vqs that do not need a callback</span></span><br><span class="line"><span class="comment"> *    names: array of virtqueue names (mainly for debugging)</span></span><br><span class="line"><span class="comment"> *        include a NULL entry for vqs unused by driver</span></span><br><span class="line"><span class="comment"> *    Returns 0 on success or error status</span></span><br><span class="line"><span class="comment"> * @del_vqs: free virtqueues found by find_vqs().</span></span><br><span class="line"><span class="comment"> * @get_features: get the array of feature bits for this device.</span></span><br><span class="line"><span class="comment"> *    vdev: the virtio_device</span></span><br><span class="line"><span class="comment"> *    Returns the first 32 feature bits (all we currently need).</span></span><br><span class="line"><span class="comment"> * @finalize_features: confirm what device features we'll be using.</span></span><br><span class="line"><span class="comment"> *    vdev: the virtio_device</span></span><br><span class="line"><span class="comment"> *    This gives the final feature bits for the device: it can change</span></span><br><span class="line"><span class="comment"> *    the dev-&gt;feature bits if it wants.</span></span><br><span class="line"><span class="comment"> * @bus_name: return the bus name associated with the device</span></span><br><span class="line"><span class="comment"> *    vdev: the virtio_device</span></span><br><span class="line"><span class="comment"> *      This returns a pointer to the bus name a la pci_name from which</span></span><br><span class="line"><span class="comment"> *      the caller can then copy.</span></span><br><span class="line"><span class="comment"> * @set_vq_affinity: set the affinity for a virtqueue.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="keyword">void</span> <span class="title">vq_callback_t</span><span class="params">(struct virtqueue *)</span></span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtio_config_ops</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">get</span>)(struct virtio_device *vdev, <span class="keyword">unsigned</span> offset,</span><br><span class="line">            <span class="keyword">void</span> *buf, <span class="keyword">unsigned</span> len);</span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">set</span>)(struct virtio_device *vdev, <span class="keyword">unsigned</span> offset,</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">unsigned</span> len);</span><br><span class="line">    u8 (*get_status)(struct virtio_device *vdev);</span><br><span class="line">    <span class="keyword">void</span> (*set_status)(struct virtio_device *vdev, u8 status);</span><br><span class="line">    <span class="keyword">void</span> (*reset)(struct virtio_device *vdev);</span><br><span class="line">    <span class="keyword">int</span> (*find_vqs)(struct virtio_device *, <span class="keyword">unsigned</span> nvqs,</span><br><span class="line">            struct virtqueue *vqs[],</span><br><span class="line">            <span class="keyword">vq_callback_t</span> *callbacks[],</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *names[]);</span><br><span class="line">    <span class="keyword">void</span> (*del_vqs)(struct virtio_device *);</span><br><span class="line">    u32 (*get_features)(struct virtio_device *vdev);</span><br><span class="line">    <span class="keyword">void</span> (*finalize_features)(struct virtio_device *vdev);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *(*bus_name)(struct virtio_device *vdev);</span><br><span class="line">    <span class="keyword">int</span> (*set_vq_affinity)(struct virtqueue *vq, <span class="keyword">int</span> cpu);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>C</p>
<p>Copy</p>
<h4 id="virtqueue-1"><a href="#virtqueue-1" class="headerlink" title="virtqueue"></a>virtqueue</h4><p>在<code>include/linux/virtio.h</code>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * virtqueue - a queue to register buffers for sending or receiving.</span></span><br><span class="line"><span class="comment"> * @list: the chain of virtqueues for this device</span></span><br><span class="line"><span class="comment"> * @callback: the function to call when buffers are consumed (can be NULL).</span></span><br><span class="line"><span class="comment"> * @name: the name of this virtqueue (mainly for debugging)</span></span><br><span class="line"><span class="comment"> * @vdev: the virtio device this queue was created for.</span></span><br><span class="line"><span class="comment"> * @priv: a pointer for the virtqueue implementation to use.</span></span><br><span class="line"><span class="comment"> * @index: the zero-based ordinal number for this queue.</span></span><br><span class="line"><span class="comment"> * @num_free: number of elements we expect to be able to fit.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A note on @num_free: with indirect buffers, each buffer needs one</span></span><br><span class="line"><span class="comment"> * element in the queue, otherwise a buffer will need one element per</span></span><br><span class="line"><span class="comment"> * sg element.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtqueue</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="keyword">void</span> (*callback)(struct virtqueue *vq);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">virtio_device</span> *<span class="title">vdev</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> num_free;</span><br><span class="line">    <span class="keyword">void</span> *priv;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>C</p>
<p>Copy</p>
<h3 id="后端-QEMU"><a href="#后端-QEMU" class="headerlink" title="后端 QEMU"></a>后端 QEMU</h3><h4 id="VirtQueue"><a href="#VirtQueue" class="headerlink" title="VirtQueue"></a>VirtQueue</h4><p>在<code>hw/virtio/virtio.c</code>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VirtQueue</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    VRing vring;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Next head to pop */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> last_avail_idx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Last avail_idx read from VQ. */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> shadow_avail_idx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> used_idx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Last used index value we have sjjignalled on */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> signalled_used;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Last used index value we have signalled on */</span></span><br><span class="line">    <span class="keyword">bool</span> signalled_used_valid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Notification enabled? */</span></span><br><span class="line">    <span class="keyword">bool</span> notification;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> queue_index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> inuse;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> <span class="built_in">vector</span>;</span><br><span class="line">    <span class="keyword">void</span> (*handle_output)(VirtIODevice *vdev, VirtQueue *vq);</span><br><span class="line">    <span class="keyword">void</span> (*handle_aio_output)(VirtIODevice *vdev, VirtQueue *vq);</span><br><span class="line">    VirtIODevice *vdev;</span><br><span class="line">    EventNotifier guest_notifier;</span><br><span class="line">    EventNotifier host_notifier;</span><br><span class="line">    QLIST_ENTRY(VirtQueue) node;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="VRing"><a href="#VRing" class="headerlink" title="VRing"></a>VRing</h4><p>在<code>hw/virtio/virtio.c</code>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">VRing</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> num;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> num_default;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> align;</span><br><span class="line">    hwaddr desc;</span><br><span class="line">    hwaddr avail;</span><br><span class="line">    hwaddr used;</span><br><span class="line">&#125; VRing;</span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://abelsu7.top/2019/09/02/virtio-in-kvm" target="_blank" rel="external nofollow noopener noreferrer">https://abelsu7.top/2019/09/02/virtio-in-kvm</a></li>
</ul>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章推荐</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/f07e2cff/" rel="bookmark">网络虚拟化</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/ccdd2b68/" rel="bookmark">macOS 使用 Vagrant 管理虚拟机</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/65866329/" rel="bookmark">虚拟化技术概览</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/6e1a1f6e/" rel="bookmark">【异构计算】GPU 虚拟化</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/4e8612ed/" rel="bookmark">【异构计算】NVIDIA GPU MIG</a></div>
    </li>
  </ul>

      
        <div class="reward-container">
  <div></div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/wechatpay.png" alt="Houmin 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/alipay.jpg" alt="Houmin 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Houmin
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://houmin.cc/posts/3675eff/" title="半虚拟化 I&#x2F;O 框架 virtio">http://houmin.cc/posts/3675eff/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/" rel="tag"><i class="fa fa-tag"></i> 虚拟化</a>
              <a href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag"><i class="fa fa-tag"></i> 网络</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/posts/9ca050a2/" rel="next" title="Docker 容器网络模型">
                  <i class="fa fa-chevron-left"></i> Docker 容器网络模型
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/posts/c835f157/" rel="prev" title="程序员王小波">
                  程序员王小波 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="comments"></div>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#软件方式模拟-I-O-设备"><span class="nav-number">1.</span> <span class="nav-text">软件方式模拟 I/O 设备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本原理"><span class="nav-number">1.1.</span> <span class="nav-text">基本原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优缺点"><span class="nav-number">1.2.</span> <span class="nav-text">优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#半虚拟化-I-O-框架-virtio"><span class="nav-number">2.</span> <span class="nav-text">半虚拟化 I/O 框架 virtio</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本原理-1"><span class="nav-number">2.1.</span> <span class="nav-text">基本原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优缺点-1"><span class="nav-number">2.2.</span> <span class="nav-text">优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#virtio-的架构"><span class="nav-number">3.</span> <span class="nav-text">virtio 的架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#版本要求"><span class="nav-number">3.1.</span> <span class="nav-text">版本要求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#层次结构"><span class="nav-number">3.2.</span> <span class="nav-text">层次结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前端代码层次结构"><span class="nav-number">3.3.</span> <span class="nav-text">前端代码层次结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#相关源码文件"><span class="nav-number">3.3.1.</span> <span class="nav-text">相关源码文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#类结构层次"><span class="nav-number">3.3.2.</span> <span class="nav-text">类结构层次</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtio-driver"><span class="nav-number">3.3.3.</span> <span class="nav-text">virtio_driver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtio-device-id"><span class="nav-number">3.3.4.</span> <span class="nav-text">virtio_device_id</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtio-device"><span class="nav-number">3.3.5.</span> <span class="nav-text">virtio_device</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtio-config-ops"><span class="nav-number">3.3.6.</span> <span class="nav-text">virtio_config_ops</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtqueue"><span class="nav-number">3.3.7.</span> <span class="nav-text">virtqueue</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关数据结构"><span class="nav-number">4.</span> <span class="nav-text">相关数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#前端-Kernel"><span class="nav-number">4.1.</span> <span class="nav-text">前端 Kernel</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#virtio-driver-1"><span class="nav-number">4.1.1.</span> <span class="nav-text">virtio_driver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtio-device-1"><span class="nav-number">4.1.2.</span> <span class="nav-text">virtio_device</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtio-config-ops-1"><span class="nav-number">4.1.3.</span> <span class="nav-text">virtio_config_ops</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtqueue-1"><span class="nav-number">4.1.4.</span> <span class="nav-text">virtqueue</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#后端-QEMU"><span class="nav-number">4.2.</span> <span class="nav-text">后端 QEMU</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#VirtQueue"><span class="nav-number">4.2.1.</span> <span class="nav-text">VirtQueue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#VRing"><span class="nav-number">4.2.2.</span> <span class="nav-text">VRing</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">5.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Houmin" src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/avatar.png">
  <p class="site-author-name" itemprop="name">Houmin</p>
  <div class="site-description" itemprop="description">丈夫拥书万卷，何假南面百城</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">159</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">223</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/SimpCosm" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;SimpCosm" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weihoumin@gmail.com" title="E-Mail &amp;rarr; mailto:weihoumin@gmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="hitokoto">
    <!-- hitokoto -->
    <div id="hito-expression">:D 获取中...</div>

    <script src="https://cdn.jsdelivr.net/npm/bluebird@3/js/browser/bluebird.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@2.0.3/fetch.min.js"></script>
    <script>
      fetch('https://v1.hitokoto.cn')
        .then(function (res){
          return res.json();
        })
        .then(function (data) {
          var hitokoto = document.getElementById('hito-expression');
          hitokoto.innerText = data.hitokoto + '——【' + data.from + '】';
        })
        .catch(function (err) {
          console.error(err);
        })
    </script>
  </div>

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heartbeat"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Houmin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">59:37</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>



  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.1.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  




  <script src="/js/local-search.js"></script>








<script>
if (document.querySelectorAll('div.pdf').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/pdfobject@2/pdfobject.min.js', () => {
    document.querySelectorAll('div.pdf').forEach(element => {
      PDFObject.embed(element.getAttribute('target'), element, {
        pdfOpenParams: {
          navpanes: 0,
          toolbar: 0,
          statusbar: 0,
          pagemode: 'thumbs',
          view: 'FitH'
        },
        PDFJS_URL: '/lib/pdf/web/viewer.html',
        height: element.getAttribute('height') || '800px'
      });
    });
  }, window.PDFObject);
}
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>



  

  

  


<script>
NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'iEBFuhVyk4tuhVYctQ265uid-gzGzoHsz',
    appKey: 'KGjOktrtgSEWK1v9DYA3T3Az',
    placeholder: "Just go go",
    avatar: 'retro',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: 'zh-cn' || 'zh-cn',
    path: location.pathname,
    recordIP: true,
    serverURLs: ''
  });
}, window.Valine);
</script>

</body>
</html>
