<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="icon" type="image/png" sizes="32x32" href="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="Houmin" type="application/atom+xml">
  <meta name="google-site-verification" content="zdGhdEF7jHoJW58lsdN6l9JrQFjJFwakCIc7TbbosV0">
  <meta name="msvalidate.01" content="2F527B379ED5537861D0D38C2C754C2B">
  <meta name="baidu-site-verification" content="xAag2PqzKE">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css">
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":true},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: true,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="在 Kubernetes 系列的开篇 中我们提到 Kubernetes 是 REST API 为中心的系统，系统内的所有操作都通过向 ApiServer提交 API Requests 来实现。ApiServer 作为 Kubernetes 控制面的核心组件，提供给用户、集群内部组件、集群外组件了 REST API 接口，使得他们可以通过标准的 HTTP API 来创建、更新、删除、查询集群中的 O">
<meta name="keywords" content="Go,api,k8s,apiserver,crd">
<meta property="og:type" content="article">
<meta property="og:title" content="【Kubernetes】API Centric">
<meta property="og:url" content="http://houmin.cc/posts/3bc1a603/index.html">
<meta property="og:site_name" content="Houmin">
<meta property="og:description" content="在 Kubernetes 系列的开篇 中我们提到 Kubernetes 是 REST API 为中心的系统，系统内的所有操作都通过向 ApiServer提交 API Requests 来实现。ApiServer 作为 Kubernetes 控制面的核心组件，提供给用户、集群内部组件、集群外组件了 REST API 接口，使得他们可以通过标准的 HTTP API 来创建、更新、删除、查询集群中的 O">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-11-25_k8s-api-space.png">
<meta property="og:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-11-25_k8s-api-gvr.png">
<meta property="og:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-12-02_k8s-apiserver.png">
<meta property="og:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-12-02_k8s-api.png">
<meta property="og:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-12-02_k8s-api-scheme-restmapper.png">
<meta property="og:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-12-02_k8s-objects.png">
<meta property="og:updated_time" content="2020-12-03T08:02:45.585Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-11-25_k8s-api-space.png">

<link rel="canonical" href="http://houmin.cc/posts/3bc1a603/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>【Kubernetes】API Centric | Houmin</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


  <script src="/js/photoswipe.min.js?v="></script>
  <script src="/js/photoswipe-ui-default.min.js?v="></script>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Houmin</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">Yesterday You Said Tomorrow</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-album">

    <a href="/album" rel="section"><i class="fa fa-fw fa-camera"></i>相册</a>

  </li>
        <li class="menu-item menu-item-movies">

    <a href="/movies/" rel="section"><i class="fa fa-fw fa-film"></i>观影</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="/books/" rel="section"><i class="fa fa-fw fa-book"></i>阅读</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://houmin.cc/posts/3bc1a603/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/avatar.png">
      <meta itemprop="name" content="Houmin">
      <meta itemprop="description" content="丈夫拥书万卷，何假南面百城">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Houmin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          【Kubernetes】API Centric
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-11 20:46:14" itemprop="dateCreated datePublished" datetime="2020-08-11T20:46:14+08:00">2020-08-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9C%AF%E4%B8%9A%E4%B8%93%E6%94%BB/" itemprop="url" rel="index">
                    <span itemprop="name">术业专攻</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/posts/3bc1a603/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/posts/3bc1a603/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>40 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>在 <a href="../d8b96fe4/">Kubernetes 系列的开篇</a> 中我们提到 Kubernetes 是 <code>REST API</code> 为中心的系统，系统内的所有操作都通过向 <code>ApiServer</code>提交 <code>API Requests</code> 来实现。<code>ApiServer</code> 作为 Kubernetes 控制面的核心组件，提供给用户、集群内部组件、集群外组件了 <code>REST API</code> 接口，使得他们可以通过标准的 <code>HTTP API</code> 来创建、更新、删除、查询集群中的 <code>Object</code>。作为介绍 <code>ApiServer</code> 的第一篇，本文将从 API 入手，介绍 <code>ApiServer</code> 的设计与实现。</p>
<a id="more"></a>
<h2 id="Access-API"><a href="#Access-API" class="headerlink" title="Access API"></a>Access API</h2><p>我们最常访问 <code>Kubernetes API</code> 的方式是通过 <code>kubectl</code>，如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deployment</span><br><span class="line">NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment   2/2     2            2           57m</span><br></pre></td></tr></table></figure>
<p><code>kubectl</code> 会将我们的操作转换成 <code>REST API</code> 访问，提供一种更加方便的访问集群的方式。实际上，我们也可以直接访问 <code>REST API</code>，向 <code>ApiServer</code> 发出 HTTP 请求。这种情况下，你需要知道集群的地址，并且拥有访问的凭证，可以通过以下命知道集群地址及凭证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config view</span><br></pre></td></tr></table></figure>
<p>下面演示了通过 <code>curl</code> 访问 <code>ApiServer</code>的方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ APISERVER=$(kubectl config view --minify -o jsonpath=<span class="string">'&#123;.clusters[0].cluster.server&#125;'</span>)</span><br><span class="line">$ TOKEN=$(kubectl get secret $(kubectl get serviceaccount default -o jsonpath=<span class="string">'&#123;.secrets[0].name&#125;'</span>) -o jsonpath=<span class="string">'&#123;.data.token&#125;'</span> | base64 --decode )</span><br><span class="line">$ curl <span class="variable">$APISERVER</span>/api --header <span class="string">"Authorization: Bearer <span class="variable">$TOKEN</span>"</span> --insecure</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"APIVersions"</span>,</span><br><span class="line">  <span class="string">"versions"</span>: [</span><br><span class="line">    <span class="string">"v1"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"serverAddressByClientCIDRs"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"clientCIDR"</span>: <span class="string">"0.0.0.0/0"</span>,</span><br><span class="line">      <span class="string">"serverAddress"</span>: <span class="string">"cls-edhzbzbn.ccs.tencent-cloud.com:60002"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每次需要指定 <code>TOKEN</code> 很麻烦，可以通过使用 <code>kubectl</code> 代理的方式访问 <code>ApiServer</code>，如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl proxy --port=8080 &amp;</span><br><span class="line">$ curl http://localhost:8080/api/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"APIVersions"</span>,</span><br><span class="line">  <span class="string">"versions"</span>: [</span><br><span class="line">    <span class="string">"v1"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"serverAddressByClientCIDRs"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"clientCIDR"</span>: <span class="string">"0.0.0.0/0"</span>,</span><br><span class="line">      <span class="string">"serverAddress"</span>: <span class="string">"cls-edhzbzbn.ccs.tencent-cloud.com:60002"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以通过这种 <code>GET</code> 方式访问 <code>Pods</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://localhost:8080/api/v1/namespaces/default/pods <span class="comment"># 访问default namespace的Pod</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"PodList"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"v1"</span>,</span><br><span class="line">  <span class="string">"metadata"</span>: &#123;</span><br><span class="line">    <span class="string">"selfLink"</span>: <span class="string">"/api/v1/namespaces/default/pods"</span>,</span><br><span class="line">    <span class="string">"resourceVersion"</span>: <span class="string">"1155810077"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"items"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"nginx-deployment-6b474476c4-6gwr2"</span>,</span><br><span class="line">        <span class="string">"generateName"</span>: <span class="string">"nginx-deployment-6b474476c4-"</span>,</span><br><span class="line">        <span class="string">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="string">"selfLink"</span>: <span class="string">"/api/v1/namespaces/default/pods/nginx-deployment-6b474476c4-6gwr2"</span>,</span><br><span class="line">        <span class="string">"uid"</span>: <span class="string">"0e6cfbe8-3e5c-4023-93ab-024a325fdbbe"</span>,</span><br><span class="line">        <span class="string">"resourceVersion"</span>: <span class="string">"1153961309"</span>,</span><br><span class="line">        ...</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"spec"</span>: &#123;</span><br><span class="line">        <span class="string">"volumes"</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"default-token-kjmg9"</span>,</span><br><span class="line">            <span class="string">"secret"</span>: &#123;</span><br><span class="line">              <span class="string">"secretName"</span>: <span class="string">"default-token-kjmg9"</span>,</span><br><span class="line">              <span class="string">"defaultMode"</span>: 420</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        ...</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="string">"status"</span>: &#123;</span><br><span class="line">        <span class="string">"phase"</span>: <span class="string">"Running"</span>,</span><br><span class="line">        ...</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通常情况下，我们可以通过 <code>yaml</code> 格式的 manifest 创建 Kubernetes 集群中的对象，比如新建一个 <code>Nginx</code> 的 <code>Pod</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ngnix-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">   <span class="attr">containers:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngnix</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">nginx:1.14.2</span></span><br><span class="line">     <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>对于 <code>ApiServer</code>而言，他们接收的API 请求数据和返回的数据一般是 <code>JSON</code> 格式，比如上面的Pod资源可以描述为以下：</p>
<figure class="highlight json"><figcaption><span>pod.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"apiVersion"</span>:<span class="string">"v1"</span>,</span><br><span class="line">  <span class="attr">"kind"</span>:<span class="string">"Pod"</span>,</span><br><span class="line">  <span class="attr">"metadata"</span>:&#123;</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"nginx-pod"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"spec"</span>:&#123;</span><br><span class="line">    <span class="attr">"containers"</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"name"</span>:<span class="string">"ngnix"</span>,</span><br><span class="line">        <span class="attr">"image"</span>:<span class="string">"nginx:1.14.2"</span>,</span><br><span class="line">        <span class="attr">"ports"</span>:[</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"containerPort"</span>: <span class="number">80</span> </span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>curl</code> 发出 <code>POST</code> 请求如下，可以看到 <code>Pod</code> 成功创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">$ curl -vvv -X POST \</span><br><span class="line">  http://localhost:8080/api/v1/namespaces/default/pods \</span><br><span class="line">  -H <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">  -d @pod.json</span><br><span class="line">&gt; POST /api/v1/namespaces/default/pods HTTP/1.1</span><br><span class="line">&gt; User-Agent: curl/7.29.0</span><br><span class="line">&gt; Host: localhost:8080</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; Content-Type: application/json</span><br><span class="line">&gt; Content-Length: 351</span><br><span class="line">&gt;</span><br><span class="line">* upload completely sent off: 351 out of 351 bytes</span><br><span class="line">&lt; HTTP/1.1 201 Created</span><br><span class="line">&lt; Cache-Control: no-cache, private</span><br><span class="line">&lt; Content-Length: 2526</span><br><span class="line">&lt; Content-Type: application/json</span><br><span class="line">&lt; Date: Fri, 27 Nov 2020 10:54:11 GMT</span><br><span class="line">&lt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"Pod"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"v1"</span>,</span><br><span class="line">  <span class="string">"metadata"</span>: &#123;</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"nginx-pod"</span>,</span><br><span class="line">    <span class="string">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"selfLink"</span>: <span class="string">"/api/v1/namespaces/default/pods/nginx-pod"</span>,</span><br><span class="line">    <span class="string">"uid"</span>: <span class="string">"bf20eefc-f98f-4ed2-9ccb-c707698851ea"</span>,</span><br><span class="line">    <span class="string">"resourceVersion"</span>: <span class="string">"1157202534"</span>,</span><br><span class="line">    <span class="string">"creationTimestamp"</span>: <span class="string">"2020-11-27T10:54:11Z"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"spec"</span>: &#123;</span><br><span class="line">    <span class="string">"containers"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"ngnix"</span>,</span><br><span class="line">        <span class="string">"image"</span>: <span class="string">"nginx:1.14.2"</span>,</span><br><span class="line">        <span class="string">"ports"</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">"containerPort"</span>: 80,</span><br><span class="line">            <span class="string">"protocol"</span>: <span class="string">"TCP"</span></span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"imagePullPolicy"</span>: <span class="string">"IfNotPresent"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"status"</span>: &#123;</span><br><span class="line">    <span class="string">"phase"</span>: <span class="string">"Pending"</span>,</span><br><span class="line">    <span class="string">"qosClass"</span>: <span class="string">"BestEffort"</span></span><br><span class="line">  &#125;</span><br><span class="line">* Connection <span class="comment">#0 to host localhost left intact</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样，我们也可以通过 <code>DELETE</code> 删除 <code>Pod</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl -vvv -X DELETE \</span><br><span class="line">  http://localhost:8080/api/v1/namespaces/default/pods/nginx-pod</span><br></pre></td></tr></table></figure>
<p>通过上面的示例，我们可以看到，通过向 <code>ApiServer</code> 直接发送 <code>REST API</code> 请求是可以查询和操作集群中的资源对象的。对于不同类型的资源对象，Kubernetes 定义了一系列的 <code>API Path</code>，可以方便资源对象的管理。下图是 <code>HTTP API</code> 空间的一部分：</p>
<p><img alt data-src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-11-25_k8s-api-space.png"></p>
<p>可以看到，其 API 可以分为三种类型：</p>
<ul>
<li><code>core group</code>：路径为 <code>/api/v1</code> </li>
<li><code>named groups</code>：路径为 <code>/apis/$ApiGroup/$Version</code></li>
<li>暴露系统状态的API：比如 <code>/metrics</code>、<code>/healthz</code>等</li>
</ul>
<p>在 Kubernetes 中，要定位一个资源对象，需要指定 <code>GVR</code>，也就是<code>Group</code>、<code>Version</code>、<code>Resource</code>。以下面的 <code>DaemonSet</code> 为例，声明了 <code>apiVersion</code> 是 <code>apps/v1</code>，其实就是隐含了 <code>Group</code> 是 <code>apps</code>，<code>Version</code> 是<code>v1</code>，<code>Kind</code> 就是定义的 <code>DaemonSet</code>，而 kubectl 接收到这个声明之后，就可以根据这个声明去调用 API Server 对应的 URL 去获取信息，例如这个就是 <code>/api/apps/v1/daemonsets</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br></pre></td></tr></table></figure>
<p>等等，不是 <code>GVR</code>吗，怎么这里变成了 <code>GVK</code> 呢？实质上 <code>Reource</code> 和 <code>Kind</code> 基本上都是一个概念，只是 <code>Kind</code> 表示一个种类，在实际中它是首字母大写的； <code>Resource</code> 表示资源，在实际中它是全部小写的，并且有单数和复数之分。我们可以把 <code>Kind</code>和 <code>Resource</code>的关系理解成面向对象编程中类与对象的关系，<code>Kind</code>其实就是一个类，用于描述对象的；而 <code>Resource</code> 就是具体的 <code>Kind</code>，可以理解成类已经实例化的对象。如果要定位某个 <code>Namespace</code> 下的 资源对象，则请求路径如下：</p>
<p><img alt data-src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-11-25_k8s-api-gvr.png"></p>
<p><code>Kubernetes</code> 的不同 <code>API Group</code> 都在按照自己的节奏在向前演进，那么如何知道当前 <code>Kubernetes</code> 版本支持哪些 <code>API Group</code>、哪些 <code>Version</code>和 哪些 <code>Kind</code> 呢，我们可以在<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/" target="_blank" rel="external nofollow noopener noreferrer">Kubernetes API Reference v1.19</a> 这里查阅到不同版本支持的 <code>GVK</code>。</p>
<h2 id="API-Convention"><a href="#API-Convention" class="headerlink" title="API Convention"></a>API Convention</h2><blockquote>
<p>Kubernetes is not just API-driven, but is <strong><em>API-centric</em></strong>.</p>
</blockquote>
<p>如前面所说，ApiServer 是 k8s 控制面的中心，不论是 <code>user client</code> 还是 <code>controllers</code> 都直接和 <code>ApiServer</code> 通过 REST API 交互，系统的状态通过 <code>etcd</code> 来实现持久化。</p>
<p><img alt data-src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-12-02_k8s-apiserver.png"></p>
<p>前面提到，对于不同的资源类型，k8s 按照 <code>ApiGroup</code> 定义了不同类型的 API，如下图所示：</p>
<p><img alt data-src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-12-02_k8s-api.png"></p>
<p>这些 API 的定义在 <code>k8s.io/api</code> 仓库中，你可以在 <a href="https://github.com/kubernetes/api" target="_blank" rel="external nofollow noopener noreferrer">这里</a> 找到它们，和前面所说的一样它们按照 <code>ApiGroup</code> 组织在一起，并且维护了不同的版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">╭─ ~/go/src/k8s.io/kubernetes/staging/src/k8s.io/api &gt; release-1.18 $</span><br><span class="line">╰─ tree -L 2</span><br><span class="line">.</span><br><span class="line">├── BUILD</span><br><span class="line">├── CONTRIBUTING.md</span><br><span class="line">├── Godeps</span><br><span class="line">│   ├── OWNERS</span><br><span class="line">│   └── Readme</span><br><span class="line">├── LICENSE</span><br><span class="line">├── OWNERS</span><br><span class="line">├── README.md</span><br><span class="line">├── SECURITY_CONTACTS</span><br><span class="line">├── ...</span><br><span class="line">├── apps</span><br><span class="line">│   ├── OWNERS</span><br><span class="line">│   ├── v1</span><br><span class="line">│   ├── v1beta1</span><br><span class="line">│   └── v1beta2</span><br><span class="line">├── ...</span><br><span class="line">├── batch</span><br><span class="line">│   ├── OWNERS</span><br><span class="line">│   ├── v1</span><br><span class="line">│   ├── v1beta1</span><br><span class="line">│   └── v2alpha1</span><br><span class="line">├── ...</span><br><span class="line">├── core</span><br><span class="line">│   └── v1</span><br><span class="line">├── ...</span><br><span class="line">├── rbac</span><br><span class="line">│   ├── OWNERS</span><br><span class="line">│   ├── v1</span><br><span class="line">│   ├── v1alpha1</span><br><span class="line">│   └── v1beta1</span><br><span class="line">└── ...</span><br></pre></td></tr></table></figure>
<p>以 <code>Batch</code> 为例，我们可以看看它具体是如何实现的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">╭─ ~/go/src/k8s.io/kubernetes/staging/src/k8s.io/api/batch/v1 &gt; release-1.18 $</span><br><span class="line">╰─ tree</span><br><span class="line">.</span><br><span class="line">├── BUILD</span><br><span class="line">├── doc.go</span><br><span class="line">├── generated.pb.go</span><br><span class="line">├── generated.proto</span><br><span class="line">├── register.go</span><br><span class="line">├── types.go</span><br><span class="line">├── types_swagger_doc_generated.go</span><br><span class="line">└── zz_generated.deepcopy.go</span><br></pre></td></tr></table></figure>
<p>对于每个 <code>ApiGroup</code>，其中各个类型的 API 被定义在 <code>types.go</code> 中，下面是 <code>Job</code> 类型 和 <code>JobList</code> 的定义：</p>
<figure class="highlight go"><figcaption><span>k8s.io/api/batch/v1/types.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Job represents the configuration of a single job.</span></span><br><span class="line"><span class="keyword">type</span> Job <span class="keyword">struct</span> &#123;</span><br><span class="line">  metav1.TypeMeta <span class="string">`json:",inline"`</span></span><br><span class="line">  metav1.ObjectMeta <span class="string">`json:"metadata,omitempty" protobuf:"bytes,1,opt,name=metadata"`</span></span><br><span class="line">  </span><br><span class="line">  Spec JobSpec <span class="string">`json:"spec,omitempty" protobuf:"bytes,2,opt,name=spec"`</span></span><br><span class="line">  Status JobStatus <span class="string">`json:"status,omitempty" protobuf:"bytes,3,opt,name=status"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JobList is a collection of jobs.</span></span><br><span class="line"><span class="keyword">type</span> JobList <span class="keyword">struct</span> &#123;</span><br><span class="line">  metav1.TypeMeta <span class="string">`json:",inline"`</span></span><br><span class="line">  metav1.ListMeta <span class="string">`json:"metadata,omitempty" protobuf:"bytes,1,opt,name=metadata"`</span></span><br><span class="line"></span><br><span class="line">  Items []Job <span class="string">`json:"items" protobuf:"bytes,2,rep,name=items"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Job</code> 和 <code>JobList</code> 分别对应了 k8s 中两种不同种类的 <code>Kind</code>：</p>
<ul>
<li><code>Objects</code>：代表了系统中的 <code>persistent entity</code>，client可以通过 <code>create</code>、<code>update</code>、 <code>delelte</code>、 <code>get</code> 等动作来操作Object，典型的代表有：<code>Pods</code> 、<code>Service</code>、<code>Namespace</code>、<code>Node</code>、<code>ReplicationController</code> 等</li>
<li><code>Lists</code>：通常是某种类型的 resource 集合，一个list kind必须以 <code>List</code> 命名结尾，它们都有 <code>items</code> 字段来返回 objects 的数组，典型的代表有：<code>PodLists</code>、<code>ServiceLists</code>、<code>NodeLists</code>等</li>
</ul>
<p>除了 <code>types.go</code>，另外一个关键的文件是 <code>register.go</code>，下面是 <code>batch/v1</code> 的 <code>register.go</code>，内容比较简单：</p>
<figure class="highlight go"><figcaption><span>k8s.io/api/batch/v1/register.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GroupName is the group name use in this package</span></span><br><span class="line"><span class="keyword">const</span> GroupName = <span class="string">"batch"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SchemeGroupVersion is group version used to register these objects</span></span><br><span class="line"><span class="keyword">var</span> SchemeGroupVersion = schema.GroupVersion&#123;Group: GroupName, Version: <span class="string">"v1"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Resource takes an unqualified resource and returns a Group qualified GroupResource</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Resource</span><span class="params">(resource <span class="keyword">string</span>)</span> <span class="title">schema</span>.<span class="title">GroupResource</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> SchemeGroupVersion.WithResource(resource).GroupResource()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  SchemeBuilder      = runtime.NewSchemeBuilder(addKnownTypes)</span><br><span class="line">  localSchemeBuilder = &amp;SchemeBuilder</span><br><span class="line">  AddToScheme        = localSchemeBuilder.AddToScheme</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Adds the list of known types to the given scheme.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addKnownTypes</span><span class="params">(scheme *runtime.Scheme)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  scheme.AddKnownTypes(SchemeGroupVersion,</span><br><span class="line">    &amp;Job&#123;&#125;,</span><br><span class="line">    &amp;JobList&#123;&#125;,</span><br><span class="line">  )</span><br><span class="line">  metav1.AddToGroupVersion(scheme, SchemeGroupVersion)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里定义了 <code>batch/v1</code> 这个 <code>ApiGroup</code>，并且通过 <code>scheme.AddKnownTypes</code> 将 <code>Job</code> 和 <code>JobList</code> 两种类型注册到 <code>runtime.Scheme</code> 中（<code>runtime.Scheme</code>是什么东西？这里暂时跳过，将在下一节详述）。在 API 的定义中，剩下的除了 <code>doc.go</code> 外都是自动生成的代码了，所以关键想了解每种类型的 API 的话，看 <code>types.go</code> 中的具体定义就好。</p>
<p>在 <code>Job</code> 定义中，我们看到了四个关键字段 <code>TypeMeta</code> 和 <code>ObjectMeta</code>，以及 <code>Spec</code> 和 <code>Status</code>，这些字段对于每一种 Object 都广泛存在，比如下面的 <code>Pod</code> 定义，下面我们会依次解析其含义。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pod is a collection of containers that can run on a host. This resource is created</span></span><br><span class="line"><span class="comment">// by clients and scheduled onto hosts.</span></span><br><span class="line"><span class="keyword">type</span> Pod <span class="keyword">struct</span> &#123;</span><br><span class="line">  metav1.TypeMeta <span class="string">`json:",inline"`</span></span><br><span class="line">  metav1.ObjectMeta <span class="string">`json:"metadata,omitempty" protobuf:"bytes,1,opt,name=metadata"`</span></span><br><span class="line"></span><br><span class="line">  Spec PodSpec <span class="string">`json:"spec,omitempty" protobuf:"bytes,2,opt,name=spec"`</span></span><br><span class="line">  Status PodStatus <span class="string">`json:"status,omitempty" protobuf:"bytes,3,opt,name=status"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在此之前，我们先回顾一下 <code>Pod</code> 的 <code>manifest</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">production</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br></pre></td></tr></table></figure>
<h3 id="TypeMeta"><a href="#TypeMeta" class="headerlink" title="TypeMeta"></a>TypeMeta</h3><p><code>TypeMeta</code> 用于表明该 <code>Object</code>的 <code>Kind</code> 和对应的 <code>APIVersion</code>，其定义如下：</p>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/apis/meta/v1/types.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TypeMeta <span class="keyword">struct</span> &#123;</span><br><span class="line">  Kind <span class="keyword">string</span> <span class="string">`json:"kind,omitempty" protobuf:"bytes,1,opt,name=kind"`</span></span><br><span class="line">  APIVersion <span class="keyword">string</span> <span class="string">`json:"apiVersion,omitempty" protobuf:"bytes,2,opt,name=apiVersion"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这正好对应于上面 <code>manifest</code>中的前两个字段：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br></pre></td></tr></table></figure>
<p><code>metav1.TypeMeta</code> 实现了 <code>schema.ObjectKind</code> 的 <code>interface</code>。</p>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/apis/meta/v1/meta.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(obj *TypeMeta)</span> <span class="title">GetObjectKind</span><span class="params">()</span> <span class="title">schema</span>.<span class="title">ObjectKind</span></span> &#123; <span class="keyword">return</span> obj &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetGroupVersionKind satisfies the ObjectKind interface for all objects that embed TypeMeta</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(obj *TypeMeta)</span> <span class="title">SetGroupVersionKind</span><span class="params">(gvk schema.GroupVersionKind)</span></span> &#123;</span><br><span class="line">  obj.APIVersion, obj.Kind = gvk.ToAPIVersionAndKind()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GroupVersionKind satisfies the ObjectKind interface for all objects that embed TypeMeta</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(obj *TypeMeta)</span> <span class="title">GroupVersionKind</span><span class="params">()</span> <span class="title">schema</span>.<span class="title">GroupVersionKind</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> schema.FromAPIVersionAndKind(obj.APIVersion, obj.Kind)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那 <code>schema.ObjectKind</code>又是干什么的呢？</p>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/runtime/schema/interfaces.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ObjectKind <span class="keyword">interface</span> &#123;</span><br><span class="line">  SetGroupVersionKind(kind GroupVersionKind)</span><br><span class="line">  GroupVersionKind() GroupVersionKind</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>GroupVersionKind</code> 才是 k8s 的API 对象类型真身，包括Kind、Version和Group，<code>schema.ObjectKind</code> 提供了对应的 <code>setter/getter</code> 函数。</p>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/runtime/schema/group_version.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GroupVersionKind <span class="keyword">struct</span> &#123;</span><br><span class="line">  Group   <span class="keyword">string</span></span><br><span class="line">  Version <span class="keyword">string</span></span><br><span class="line">  Kind    <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ObjectMeta"><a href="#ObjectMeta" class="headerlink" title="ObjectMeta"></a>ObjectMeta</h3><p>每一个 <code>Object</code> 都必须有一个 <code>metadata</code> 字段， <code>metadata</code> 包含一些用于唯一识别对象的数据，包括 <code>Object</code> 所在的 <code>namespace</code> ，它在当前 <code>namespace</code>中能够唯一确定本对象的 <code>name</code> 字段，用于组织和分类的 <code>labels</code> 以及用于扩展功能的注解 <code>annotations</code>等。</p>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/apis/meta/v1/types.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ObjectMeta <span class="keyword">struct</span> &#123;</span><br><span class="line">  Name <span class="keyword">string</span></span><br><span class="line">  Namespace <span class="keyword">string</span></span><br><span class="line">  Labels <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">  Annotations <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">  OwnerReferences []OwnerReference</span><br><span class="line">  UID types.UID</span><br><span class="line">  SelfLink <span class="keyword">string</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述的结构体嵌入在 Kubernetes 的每一个对象中，为所有的对象提供类似命名、命名空间、标签和注解等最基本的支持，让开发者能够更好地管理 Kubernetes 集群。</p>
<p><code>ObjectMeta</code> 的具体实现提供了 <code>metav1.Object</code>的 <code>interface</code>，其中定义了一系列的 Getter/Setter 接口：</p>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/apis/meta/v1/meta.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Object <span class="keyword">interface</span> &#123;</span><br><span class="line">  GetNamespace() <span class="keyword">string</span></span><br><span class="line">  SetNamespace(namespace <span class="keyword">string</span>)</span><br><span class="line">  GetName() <span class="keyword">string</span></span><br><span class="line">  SetName(name <span class="keyword">string</span>)</span><br><span class="line">  GetUID() types.UID</span><br><span class="line">  SetUID(uid types.UID)</span><br><span class="line">  GetLabels() <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">  SetLabels(labels <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">  GetAnnotations() <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">  SetAnnotations(annotations <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这些 Getter/Setter 接口获取的字段基本都是 <code>ObjectMeta</code> 结构体中定义的一些字段，这也是为什么 Kubernetes 对象都需要嵌入一个 <code>ObjectMeta</code> 结构体。</p>
<h3 id="ListMeta"><a href="#ListMeta" class="headerlink" title="ListMeta"></a>ListMeta</h3><p><code>ListMeta</code> 描述了复合资源的metadata，一个 <code>Resource</code> 要么只能有 <code>ListMeta</code> 要么只能有 <code>ObjectMeta</code>。</p>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/apis/meta/v1/types.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ListMeta <span class="keyword">struct</span> &#123;</span><br><span class="line">  ResourceVersion <span class="keyword">string</span> <span class="string">`json:"resourceVersion,omitempty" protobuf:"bytes,2,opt,name=resourceVersion"`</span></span><br><span class="line">  Continue <span class="keyword">string</span> <span class="string">`json:"continue,omitempty" protobuf:"bytes,3,opt,name=continue"`</span></span><br><span class="line">  RemainingItemCount *<span class="keyword">int64</span> <span class="string">`json:"remainingItemCount,omitempty" protobuf:"bytes,4,opt,name=remainingItemCount"`</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ListMeta</code> 的具体实现提供了<code>metav1.ListInterface</code>的 <code>interface</code>，其中定义了一系列的 Getter/Setter 接口：</p>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/apis/meta/v1/meta.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ListInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">  GetResourceVersion() <span class="keyword">string</span></span><br><span class="line">  SetResourceVersion(version <span class="keyword">string</span>)</span><br><span class="line">  GetSelfLink() <span class="keyword">string</span></span><br><span class="line">  SetSelfLink(selfLink <span class="keyword">string</span>)</span><br><span class="line">  GetContinue() <span class="keyword">string</span></span><br><span class="line">  SetContinue(c <span class="keyword">string</span>)</span><br><span class="line">  GetRemainingItemCount() *<span class="keyword">int64</span></span><br><span class="line">  SetRemainingItemCount(c *<span class="keyword">int64</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Spec"><a href="#Spec" class="headerlink" title="Spec"></a>Spec</h3><p><code>Spec</code> 描述了我们期待 <code>Object</code> 在集群中的 <code>desired state</code>，集群中的 <code>controllers</code> 会一直运转，使得 <code>object</code> 的状态到达 <code>Spec</code> 所描述的那样。系统会根据 <code>API Spec</code> 的最新状态来驱动，也就是说，如果 <code>Spec</code> 中的一个值通过 <code>PUT</code> 操作从2更新到5，然后又通过另一个 <code>PUT</code> 操作从5更新到3，这个过程中 <code>controller</code> 并不要求 <code>Status</code> 一定需要经历 3 这个状态。也就是说，系统是 <code>level-based</code> 而不是 <code>edge-based</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PodSpec is a description of a pod.</span></span><br><span class="line"><span class="keyword">type</span> PodSpec <span class="keyword">struct</span> &#123;</span><br><span class="line">  Volumes []Volume <span class="string">`json:"volumes,omitempty" patchStrategy:"merge,retainKeys" patchMergeKey:"name" protobuf:"bytes,1,rep,name=volumes"`</span></span><br><span class="line">  InitContainers []Container <span class="string">`json:"initContainers,omitempty" patchStrategy:"merge" patchMergeKey:"name" protobuf:"bytes,20,rep,name=initContainers"`</span></span><br><span class="line">  Containers []Container <span class="string">`json:"containers" patchStrategy:"merge" patchMergeKey:"name" protobuf:"bytes,2,rep,name=containers"`</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Status"><a href="#Status" class="headerlink" title="Status"></a>Status</h3><p>如果说 <code>Spec</code> 对应了我们期待该对象在集群中的 <code>desired state</code>，那么 <code>Status</code> 就是对象在集群中的 <code>observed state</code>。下面是 <code>PodStatus</code> 的示例，描述了 <code>Pod</code> 当前的状态：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PodStatus <span class="keyword">struct</span> &#123;</span><br><span class="line">  Phase PodPhase <span class="string">`json:"phase,omitempty" protobuf:"bytes,1,opt,name=phase,casttype=PodPhase"`</span></span><br><span class="line">  Conditions []PodCondition <span class="string">`json:"conditions,omitempty" patchStrategy:"merge" patchMergeKey:"type" protobuf:"bytes,2,rep,name=conditions"`</span></span><br><span class="line">  Message <span class="keyword">string</span> <span class="string">`json:"message,omitempty" protobuf:"bytes,3,opt,name=message"`</span></span><br><span class="line">  Reason <span class="keyword">string</span> <span class="string">`json:"reason,omitempty" protobuf:"bytes,4,opt,name=reason"`</span></span><br><span class="line">  InitContainerStatuses []ContainerStatus <span class="string">`json:"initContainerStatuses,omitempty" protobuf:"bytes,10,rep,name=initContainerStatuses"`</span></span><br><span class="line">  ContainerStatuses []ContainerStatus <span class="string">`json:"containerStatuses,omitempty" protobuf:"bytes,8,rep,name=containerStatuses"`</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Resource-Kind-Type-Mapping"><a href="#Resource-Kind-Type-Mapping" class="headerlink" title="Resource/Kind/Type Mapping"></a>Resource/Kind/Type Mapping</h2><p>前面提到，要定位一个API资源，需要指定其 <code>GVR</code> 或者 <code>GVK</code>，这两种本质相同，是同一个资源在不同场景的表现形式，在上一小节中我们也展示了每种API资源在 <code>types.go</code> 中数据结构的定义。那么问题来了，k8s 是如何从一个 <code>REST HTTP Request Path</code> 转化成对应的 <code>GVR</code> 和 <code>GVK</code> 的呢？</p>
<p><img alt data-src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-12-02_k8s-api-scheme-restmapper.png"></p>
<p>每个 GVR 对应一个http 路径（kind 不会），用于标识 Kubernetes API的 REST 接口。<code>runtime.Scheme</code> 将 golang object 映射为可能的GVK。一个GVK 到一个GVR 的映射被称为 <code>REST mapping</code>，RESTMapper interface/ RESTMapping struct 来完成转换。</p>
<h3 id="Objects"><a href="#Objects" class="headerlink" title="Objects"></a>Objects</h3><p>在上一小节中我们提到了 <code>metav1.TypeMeta</code>、<code>metav1.ObjectMeta</code> 和 <code>metav1.ListMeta</code>，<code>Pod</code> 直接继承自 <code>metav1.TypeMeta</code> 和 <code>metav1.ObjectMeta</code>，<code>PodList</code> 继承自 <code>metav1.TypeMeta</code> 和 <code>metav1.ListMeta</code>。而 <code>metav1.TypeMeta</code> 继承自 <code>schema.ObjectKind interface</code>，提供了对于 <code>GroupVersionKind</code> 的 <code>setter/getter</code> 方法，<code>metav1.ObjectMeta</code> 继承自 <code>metav1.Object interface</code> ，提供了对于 <code>Namespace</code>、<code>Label</code>、<code>Annotation</code> 等一系列的 <code>setter/getter</code> 方法。</p>
<p><img alt data-src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-12-02_k8s-objects.png"></p>
<p>为了通过一个 API 对象来访问 Scheme 中所有的 API 对象，k8s 设计实现了 <code>runtime.Object interface</code>，作为 <code>schema.ObjectKind</code> 和  <code>metav1.Object</code> 的统一基类。</p>
<blockquote>
<p><strong>Object interface must be supported by all API types registered with Scheme</strong>. Since objects in a scheme are expected to be serialized to the wire, the interface an Object must provide to the Scheme allows serializers to set the kind, version, and group the object is represented as.</p>
</blockquote>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/runtime/interfaces.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Object <span class="keyword">interface</span> &#123;</span><br><span class="line">  GetObjectKind() schema.ObjectKind</span><br><span class="line">  DeepCopyObject() Object</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Scheme"><a href="#Scheme" class="headerlink" title="Scheme"></a>Scheme</h3><p>前面提到，对于不同 <code>ApiGroup</code> 中不同类型的API资源，我们在 <code>k8s.io/api/&lt;apiGroup&gt;/&lt;version&gt;</code>目录下：</p>
<ul>
<li><code>types.go</code> 中定义了不同类型的API的数据结构</li>
<li><code>register.go</code> 负责将 <code>types.go</code>中定义的数据结构注册到 <code>runtime.Scheme</code>中</li>
</ul>
<p>这里的 <code>runtime.Scheme</code> 是什么东西？每个不同类型的API资源到底是如何注册的呢？在上面的介绍过程中我们看到，在 <code>k8s.io/api</code> 这个仓库中可以找到所有类型的API资源的定义，其中也包括各种 <code>Spec</code> 和 <code>Status</code> 的定义。但是 <code>TypeMeta</code> 和 <code>ObjectMeta</code> 这种数据结构，却都存在于 <code>k8s.io/apimachinery</code> 仓库中。</p>
<p>与 <code>k8s.io/api</code> 相比，<code>k8s.io/apimachinery</code> 显得复杂得多，包含各种 <code>conversion</code>、<code>labels</code>、<code>codec</code> 和 这里的 <code>runtime.Scheme</code>，这些到底又都是做何用处呢？我们将在后续的文章依次解析。</p>
<p>现在，我们首先来看其中最最基础的 <code>runtime.Scheme</code>，<code>runtime.Scheme</code> 只是实现了一个序列化与类型转换的框架API，提供了注册资源数据类型与转换函数的功能，是实现多版本API和多版本配置的基础。</p>
<blockquote>
<p>Scheme defines methods for serializing and deserializing API objects, a <strong>type registry</strong> for converting group, version, and kind information to and from Go schemas, and <strong>mappings between Go schemas of different versions.</strong></p>
</blockquote>
<p>在 <code>Scheme</code> 中，对应于 <code>GVK</code> 有以下定义：</p>
<ul>
<li>a <strong>Type</strong> is a particular <strong>Go struct</strong></li>
<li>a <strong>Version</strong> is a point-in-time identifier for a particular representation of that Type (typically backwards compatible)</li>
<li>a <strong>Kind</strong> is the unique name for that Type within the Version</li>
<li>a <strong>Group</strong> identifies a set of Versions, Kinds, and Types that evolve over time</li>
<li>An <strong>Unversioned Type</strong> is one that is <strong>not yet formally bound to a type</strong> and is promised to be backwards compatible </li>
</ul>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/runtime/scheme.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Scheme <span class="keyword">struct</span> &#123;</span><br><span class="line">    gvkToType <span class="keyword">map</span>[schema.GroupVersionKind]reflect.Type</span><br><span class="line">    typeToGVK <span class="keyword">map</span>[reflect.Type][]schema.GroupVersionKind</span><br><span class="line">    unversionedTypes <span class="keyword">map</span>[reflect.Type]schema.GroupVersionKind</span><br><span class="line">    unversionedKinds <span class="keyword">map</span>[<span class="keyword">string</span>]reflect.Type</span><br><span class="line">    fieldLabelConversionFuncs <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">string</span>]FieldLabelConversionFunc</span><br><span class="line">    defaulterFuncs <span class="keyword">map</span>[reflect.Type]<span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line">    converter *conversion.Converter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析 <code>Scheme</code> 的各个字段：</p>
<ul>
<li><code>gvkToType</code> 实现从 <code>GroupVersionKind</code> 到 <code>go type</code> 的映射</li>
<li><code>typeToGVK</code> 实现从<code>go type</code> 到 <code>GroupVersionKind</code> 的映射，允许通过 <code>go object</code> 找到其 <code>metadata</code></li>
<li><code>unversionedTypes</code>are transformed without conversion in ConvertToVersion</li>
<li><code>unversionedKind</code>用于映射哪些能够在任意group和version情况下的类型，key是一个string，也就是kind</li>
<li><code>fieldLabelConversionFuncs</code>：用于解决数据对象的属性名称的兼容性转换和检验，比如讲需要兼容Pod的spec.Host属性改为spec.nodeName的情况</li>
<li><code>defaulterFuncs</code> 包含了所有 <code>defaulting</code> 相关的函数</li>
<li><code>converter</code> 包含了所有转换函数，负责不同版本的数据对象转换问题</li>
</ul>
<p>前文提到， <code>Job</code> 和 <code>JobList</code> 在 <code>types.go</code> 中定义之后，通过在 <code>register.go</code> 中注册到 <code>runtime.Scheme</code>，其中调用了 <code>AddKnownTypes</code> 这个函数：</p>
<figure class="highlight go"><figcaption><span>k8s.io/api/batch/v1/register.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Adds the list of known types to the given scheme.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addKnownTypes</span><span class="params">(scheme *runtime.Scheme)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  scheme.AddKnownTypes(SchemeGroupVersion,</span><br><span class="line">    &amp;Job&#123;&#125;,</span><br><span class="line">    &amp;JobList&#123;&#125;,</span><br><span class="line">  )</span><br><span class="line">  metav1.AddToGroupVersion(scheme, SchemeGroupVersion)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看起具体实现，通过传入 <code>GroupVersion</code> 和 要注册的 <code>Type</code>，调用了 <code>AddKnownTypeWithName</code>：</p>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/runtime/scheme.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddKnownTypes</span><span class="params">(gv schema.GroupVersion, types ...Object)</span></span> &#123;</span><br><span class="line">  s.addObservedVersion(gv)</span><br><span class="line">  <span class="keyword">for</span> _, obj := <span class="keyword">range</span> types &#123;</span><br><span class="line">    t := reflect.TypeOf(obj)</span><br><span class="line">    <span class="keyword">if</span> t.Kind() != reflect.Ptr &#123;</span><br><span class="line">      <span class="built_in">panic</span>(<span class="string">"All types must be pointers to structs."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    t = t.Elem()</span><br><span class="line">    s.AddKnownTypeWithName(gv.WithKind(t.Name()), obj)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>AddKnownTypeWithName</code> 中，实际上是将 <code>Type</code> 和 <code>GVK</code> 注册到 <code>runtime.Scheme</code> 的 <code>gvkToType</code> 和 <code>typeToGVK</code> 中。</p>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/runtime/scheme.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">AddKnownTypeWithName</span><span class="params">(gvk schema.GroupVersionKind, obj Object)</span></span> &#123;</span><br><span class="line">  s.addObservedVersion(gvk.GroupVersion())</span><br><span class="line">  t := reflect.TypeOf(obj)</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(gvk.Version) == <span class="number">0</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"version is required on all types: %s %v"</span>, gvk, t))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> t.Kind() != reflect.Ptr &#123;</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">"All types must be pointers to structs."</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  t = t.Elem()</span><br><span class="line">  <span class="keyword">if</span> t.Kind() != reflect.Struct &#123;</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">"All types must be pointers to structs."</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> oldT, found := s.gvkToType[gvk]; found &amp;&amp; oldT != t &#123;</span><br><span class="line">    <span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"Double registration of different types for %v: old=%v.%v, new=%v.%v in scheme %q"</span>, gvk, oldT.PkgPath(), oldT.Name(), t.PkgPath(), t.Name(), s.schemeName))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  s.gvkToType[gvk] = t</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> _, existingGvk := <span class="keyword">range</span> s.typeToGVK[t] &#123;</span><br><span class="line">    <span class="keyword">if</span> existingGvk == gvk &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  s.typeToGVK[t] = <span class="built_in">append</span>(s.typeToGVK[t], gvk)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Kubernetes这个设计思路简单方便地建解决多版本的序列化和数据转换问题，下面是 <code>runtime.Scheme</code> 里序列化、反序列化的核心方法New()的代码：通过查找 <code>gkvToType</code> 里匹配的类型，以反射方法生成一个空的数据对象：</p>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/runtime/scheme.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// New returns a new API object of the given version and name, or an error if it hasn't</span></span><br><span class="line"><span class="comment">// been registered. The version and kind fields must be specified.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scheme)</span> <span class="title">New</span><span class="params">(kind schema.GroupVersionKind)</span> <span class="params">(Object, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> t, exists := s.gvkToType[kind]; exists &#123;</span><br><span class="line">        <span class="keyword">return</span> reflect.New(t).Interface().(Object), <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> t, exists := s.unversionedKinds[kind.Kind]; exists &#123;</span><br><span class="line">        <span class="keyword">return</span> reflect.New(t).Interface().(Object), <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, NewNotRegisteredErrForKind(kind)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们继续看 <code>k8s.io/api/batch/v1/register.go</code>，它通过<code>SchemeBuilder</code> 结构传入了注册 <code>Job</code> 和 <code>JobList</code> 的方法，并且声明了一个 <code>AddToScheme</code> 的全局变量：</p>
<figure class="highlight go"><figcaption><span>k8s.io/api/batch/v1/register.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  SchemeBuilder      = runtime.NewSchemeBuilder(addKnownTypes)</span><br><span class="line">  localSchemeBuilder = &amp;SchemeBuilder</span><br><span class="line">  AddToScheme        = localSchemeBuilder.AddToScheme</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>那么 <code>SchemeBuilder</code> 是什么呢？其本质上就是一个函数数组，通过 <code>NewSchemeBuilder</code> 将要执行的函数传入，并通过调用 <code>AddToScheme</code> 真正执行。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SchemeBuilder []<span class="function"><span class="keyword">func</span><span class="params">(*Scheme)</span> <span class="title">error</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSchemeBuilder</span><span class="params">(funcs ...<span class="keyword">func</span>(*Scheme)</span> <span class="title">error</span>) <span class="title">SchemeBuilder</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> sb SchemeBuilder</span><br><span class="line">  sb.Register(funcs...)</span><br><span class="line">  <span class="keyword">return</span> sb</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sb *SchemeBuilder)</span> <span class="title">Register</span><span class="params">(funcs ...<span class="keyword">func</span>(*Scheme)</span> <span class="title">error</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> _, f := <span class="keyword">range</span> funcs &#123;</span><br><span class="line">    *sb = <span class="built_in">append</span>(*sb, f)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sb *SchemeBuilder)</span> <span class="title">AddToScheme</span><span class="params">(s *Scheme)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> _, f := <span class="keyword">range</span> *sb &#123;</span><br><span class="line">    <span class="keyword">if</span> err := f(s); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到在 <code>register.go</code> 中只是声明了 <code>AddToScheme</code> 的注册方法，并没有真正执行注册的过程。那么到底是在哪里执行注册的呢？答案是在 <code>client-go</code> 中，查看 <code>k8s.io/client-go/kubernetes/scheme/register.go</code> ，可以看到这里引用了所有 <code>ApiGroup</code> 各个版本的 <code>AddToScheme</code> ，创建了一个全局 <code>AddToScheme</code>，在 <code>init</code> 方法初始化的时候就会被调用。</p>
<figure class="highlight go"><figcaption><span>k8s.io/client-go/kubernetes/scheme/register.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Scheme = runtime.NewScheme()</span><br><span class="line"><span class="keyword">var</span> Codecs = serializer.NewCodecFactory(Scheme)</span><br><span class="line"><span class="keyword">var</span> ParameterCodec = runtime.NewParameterCodec(Scheme)</span><br><span class="line"><span class="keyword">var</span> localSchemeBuilder = runtime.SchemeBuilder&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  batchv1.AddToScheme,</span><br><span class="line">  batchv1beta1.AddToScheme,</span><br><span class="line">  batchv2alpha1.AddToScheme,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  corev1.AddToScheme,</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  storagev1beta1.AddToScheme,</span><br><span class="line">  storagev1.AddToScheme,</span><br><span class="line">  storagev1alpha1.AddToScheme,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> AddToScheme = localSchemeBuilder.AddToScheme</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">  v1.AddToGroupVersion(Scheme, schema.GroupVersion&#123;Version: <span class="string">"v1"</span>&#125;)</span><br><span class="line">  utilruntime.Must(AddToScheme(Scheme))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RESTMapper"><a href="#RESTMapper" class="headerlink" title="RESTMapper"></a>RESTMapper</h3><p>前面提到，<code>RESTMapper</code> 实现了从 <code>GVR</code> 到 <code>GVK</code> 的映射，下面显示了其提供的方法，听可以通过 <code>GVK</code> 生成一个 <code>RESTMapping</code>。</p>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/api/meta/interface.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RESTMapper <span class="keyword">interface</span> &#123;</span><br><span class="line">   KindFor(resource schema.GroupVersionResource) (schema.GroupVersionKind, error)</span><br><span class="line">   KindsFor(resource schema.GroupVersionResource) ([]schema.GroupVersionKind, error)</span><br><span class="line">   ResourceFor(input schema.GroupVersionResource) (schema.GroupVersionResource, error)</span><br><span class="line">   ResourcesFor(input schema.GroupVersionResource) ([]schema.GroupVersionResource, error)</span><br><span class="line"></span><br><span class="line">   RESTMapping(gk schema.GroupKind, versions ...<span class="keyword">string</span>) (*RESTMapping, error)</span><br><span class="line">   RESTMappings(gk schema.GroupKind, versions ...<span class="keyword">string</span>) ([]*RESTMapping, error)</span><br><span class="line"></span><br><span class="line">   ResourceSingularizer(resource <span class="keyword">string</span>) (singular <span class="keyword">string</span>, err error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>RESTMapping</code> 是什么呢？<code>RSETMapping</code> 结构包含有 <code>GVR</code> 和 <code>GVK</code>，还有一个 <code>Scope</code> 标明资源是否为 root 或者 <code>namespaced</code>。</p>
<figure class="highlight go"><figcaption><span>k8s.io/apimachinery/pkg/api/meta/interface.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RESTMapping <span class="keyword">struct</span> &#123;</span><br><span class="line">	Resource schema.GroupVersionResource</span><br><span class="line">	GroupVersionKind schema.GroupVersionKind</span><br><span class="line">	Scope RESTScope</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RESTScope <span class="keyword">interface</span> &#123;</span><br><span class="line">	Name() RESTScopeName</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RESTScopeName <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	RESTScopeNameNamespace RESTScopeName = <span class="string">"namespace"</span></span><br><span class="line">	RESTScopeNameRoot      RESTScopeName = <span class="string">"root"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>那么 <code>RESTMapping</code> 该如何使用呢？后续在 API 的安装介绍中将会看到，将会使用 <code>RESTMapping</code> 中的 Scope 来生成合适的 URL，这里暂时埋下一个种子。</p>
<p><code>DefaultRESTMapper</code> 实现了 <code>RESTMapper interface</code>，可以看到这里通过几个 <code>map</code> 保存了 <code>GVK</code> 和 <code>GVR</code> 之间的映射关系。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DefaultRESTMapper <span class="keyword">struct</span> &#123;</span><br><span class="line">	defaultGroupVersions []schema.GroupVersion</span><br><span class="line"></span><br><span class="line">	resourceToKind       <span class="keyword">map</span>[schema.GroupVersionResource]schema.GroupVersionKind</span><br><span class="line">	kindToPluralResource <span class="keyword">map</span>[schema.GroupVersionKind]schema.GroupVersionResource</span><br><span class="line">	kindToScope          <span class="keyword">map</span>[schema.GroupVersionKind]RESTScope</span><br><span class="line">	singularToPlural     <span class="keyword">map</span>[schema.GroupVersionResource]schema.GroupVersionResource</span><br><span class="line">	pluralToSingular     <span class="keyword">map</span>[schema.GroupVersionResource]schema.GroupVersionResource</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Summarize"><a href="#Summarize" class="headerlink" title="Summarize"></a>Summarize</h2><p>本文首先介绍了通过 <code>REST API</code> 访问集群的方法，引入了 <code>GVK</code>、<code>GVR</code> 等概念，接下来基于 <code>API Convention</code> 介绍了每个 API 实现过程中对应的数据结构。最后介绍了 <code>runtime.Scheme</code> 和 <code>RESTMapper</code>，了解了 API 对象从 <code>HTTP Path</code> 到 <code>GVR</code> 再到 <code>GVK</code> 之间的转换。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://kubernetes.io/docs/reference/using-api/api-concepts/" target="_blank" rel="external nofollow noopener noreferrer">Kubernetes API Concepts</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md" target="_blank" rel="external nofollow noopener noreferrer">Kubernetes API Conventions</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/" target="_blank" rel="external nofollow noopener noreferrer">Kubernetes API Reference v1.19</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/architecture/resource-management.md" target="_blank" rel="external nofollow noopener noreferrer">Kubernetes Resource Model</a></li>
<li><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/kubernetes-objects/" target="_blank" rel="external nofollow noopener noreferrer">Understanding Kubernetes Objects</a></li>
<li><a href="https://www.slideshare.net/sttts/extending-the-kube-api" target="_blank" rel="external nofollow noopener noreferrer">Extending the Kube API</a></li>
<li><a href="https://www.slideshare.net/sttts/kubernetes-api-codebase-tour" target="_blank" rel="external nofollow noopener noreferrer">Kubernetes API code-base tour Slides</a></li>
<li><a href="https://www.youtube.com/watch?v=e9Wnhoh0Fy0" target="_blank" rel="external nofollow noopener noreferrer">Kubernetes API code-base tour Video</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1519826" target="_blank" rel="external nofollow noopener noreferrer">https://cloud.tencent.com/developer/article/1519826</a></li>
</ul>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章推荐</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/b0614056/" rel="bookmark">【Kubernetes】API Install</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/d8b96fe4/" rel="bookmark">【Kubernetes】开篇</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/76a404e7/" rel="bookmark">【Kubernetes】Controller Manager</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/83a17de0/" rel="bookmark">【Kubernetes】Scheduling Framework</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/d3e0e7a2/" rel="bookmark">【Kubernetes】Scheduler</a></div>
    </li>
  </ul>

      
        <div class="reward-container">
  <div></div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/wechatpay.png" alt="Houmin 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/alipay.jpg" alt="Houmin 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Houmin
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://houmin.cc/posts/3bc1a603/" title="【Kubernetes】API Centric">http://houmin.cc/posts/3bc1a603/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Go/" rel="tag"><i class="fa fa-tag"></i> Go</a>
              <a href="/tags/api/" rel="tag"><i class="fa fa-tag"></i> api</a>
              <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
              <a href="/tags/apiserver/" rel="tag"><i class="fa fa-tag"></i> apiserver</a>
              <a href="/tags/crd/" rel="tag"><i class="fa fa-tag"></i> crd</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/posts/d8b96fe4/" rel="next" title="【Kubernetes】开篇">
                  <i class="fa fa-chevron-left"></i> 【Kubernetes】开篇
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/posts/b0614056/" rel="prev" title="【Kubernetes】API Install">
                  【Kubernetes】API Install <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="comments"></div>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Access-API"><span class="nav-number">1.</span> <span class="nav-text">Access API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API-Convention"><span class="nav-number">2.</span> <span class="nav-text">API Convention</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TypeMeta"><span class="nav-number">2.1.</span> <span class="nav-text">TypeMeta</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ObjectMeta"><span class="nav-number">2.2.</span> <span class="nav-text">ObjectMeta</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ListMeta"><span class="nav-number">2.3.</span> <span class="nav-text">ListMeta</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spec"><span class="nav-number">2.4.</span> <span class="nav-text">Spec</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Status"><span class="nav-number">2.5.</span> <span class="nav-text">Status</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Resource-Kind-Type-Mapping"><span class="nav-number">3.</span> <span class="nav-text">Resource/Kind/Type Mapping</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Objects"><span class="nav-number">3.1.</span> <span class="nav-text">Objects</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Scheme"><span class="nav-number">3.2.</span> <span class="nav-text">Scheme</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RESTMapper"><span class="nav-number">3.3.</span> <span class="nav-text">RESTMapper</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summarize"><span class="nav-number">4.</span> <span class="nav-text">Summarize</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">5.</span> <span class="nav-text">References</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Houmin" src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/avatar.png">
  <p class="site-author-name" itemprop="name">Houmin</p>
  <div class="site-description" itemprop="description">丈夫拥书万卷，何假南面百城</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">146</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">207</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/SimpCosm" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;SimpCosm" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weihoumin@gmail.com" title="E-Mail &amp;rarr; mailto:weihoumin@gmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="hitokoto">
    <!-- hitokoto -->
    <div id="hito-expression">:D 获取中...</div>

    <script src="https://cdn.jsdelivr.net/npm/bluebird@3/js/browser/bluebird.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@2.0.3/fetch.min.js"></script>
    <script>
      fetch('https://v1.hitokoto.cn')
        .then(function (res){
          return res.json();
        })
        .then(function (data) {
          var hitokoto = document.getElementById('hito-expression');
          hitokoto.innerText = data.hitokoto + '——【' + data.from + '】';
        })
        .catch(function (err) {
          console.error(err);
        })
    </script>
  </div>

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heartbeat"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Houmin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">1.5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">46:02</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>



  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.1.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  




  <script src="/js/local-search.js"></script>








<script>
if (document.querySelectorAll('div.pdf').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/pdfobject@2/pdfobject.min.js', () => {
    document.querySelectorAll('div.pdf').forEach(element => {
      PDFObject.embed(element.getAttribute('target'), element, {
        pdfOpenParams: {
          navpanes: 0,
          toolbar: 0,
          statusbar: 0,
          pagemode: 'thumbs',
          view: 'FitH'
        },
        PDFJS_URL: '/lib/pdf/web/viewer.html',
        height: element.getAttribute('height') || '800px'
      });
    });
  }, window.PDFObject);
}
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>



  

  

  


<script>
NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'iEBFuhVyk4tuhVYctQ265uid-gzGzoHsz',
    appKey: 'KGjOktrtgSEWK1v9DYA3T3Az',
    placeholder: "Just go go",
    avatar: 'retro',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: 'zh-cn' || 'zh-cn',
    path: location.pathname,
    recordIP: true,
    serverURLs: ''
  });
}, window.Valine);
</script>

</body>
</html>
