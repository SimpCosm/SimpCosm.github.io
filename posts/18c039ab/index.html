<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="icon" type="image/png" sizes="32x32" href="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="Houmin" type="application/atom+xml">
  <meta name="google-site-verification" content="zdGhdEF7jHoJW58lsdN6l9JrQFjJFwakCIc7TbbosV0">
  <meta name="msvalidate.01" content="2F527B379ED5537861D0D38C2C754C2B">
  <meta name="baidu-site-verification" content="xAag2PqzKE">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css">
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":true},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: true,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Prometheus是一套开源的完整监控解决方案，对传统监控系统的测试和告警模型进行了彻底的颠覆，形成了基于中央化的规则计算、统一分析和告警的新模型。 Prometheus 采用 Pull 模型通过 HTTP 协议去采集指标，只要应用能够提供 HTTP 接口就可以接入到监控系统，相比于私有协议或二进制协议来说开发、简单。本文总结梳理了在使用 Prometheus 时候的关键概念和用法，关于 Pro">
<meta name="keywords" content="监控,可观测性,prometheus">
<meta property="og:type" content="article">
<meta property="og:title" content="【系统监控】Prometheus">
<meta property="og:url" content="http://houmin.cc/posts/18c039ab/index.html">
<meta property="og:site_name" content="Houmin">
<meta property="og:description" content="Prometheus是一套开源的完整监控解决方案，对传统监控系统的测试和告警模型进行了彻底的颠覆，形成了基于中央化的规则计算、统一分析和告警的新模型。 Prometheus 采用 Pull 模型通过 HTTP 协议去采集指标，只要应用能够提供 HTTP 接口就可以接入到监控系统，相比于私有协议或二进制协议来说开发、简单。本文总结梳理了在使用 Prometheus 时候的关键概念和用法，关于 Pro">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-09-16_prometheus-architecture.png">
<meta property="og:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-09-16_prometheus-cadvisor-network.png">
<meta property="og:image" content="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LVT4hCAm7HWaP8rOjeF%2F-LPS8MxTnlks9MW9afcf%2Fcounter-to-rate.png">
<meta property="og:image" content="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LVT4hCAm7HWaP8rOjeF%2F-LPS8MxYOMNuHXOylcUA%2Fhistogram_quantile.png?alt=media">
<meta property="og:image" content="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LVSqkQub5oDFvoLr1P2%2F-LVSr9O9L372kPUgr25X%2Fprometheus-sd.png?alt=media">
<meta property="og:image" content="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LPui3iWsSYuoIaPTZtS%2F-LPui6XS6SgDzCvoGrMw%2Fprometheus_file_target_metadata.png">
<meta property="og:image" content="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LVSsqoyc3erej7bf3vS%2F-LPui6XUJUk0y4kPPia0%2Fwhen-relabel-work.png">
<meta property="og:image" content="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LPui3iWsSYuoIaPTZtS%2F-LPui6XS6SgDzCvoGrMw%2Fprometheus_file_target_metadata.png">
<meta property="og:image" content="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LVMF4RtPS-2rjW9R-hG%2F-LPS9QhUbi37E1ZK8mXF%2Fprometheus-alert-artich.png?alt=media">
<meta property="og:image" content="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LVMF4RtPS-2rjW9R-hG%2F-LPS9QhWQUhAIdLAiEfH%2Falertmanager-features.png?alt=media">
<meta property="og:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-09-17_prometheus-rules.png">
<meta property="og:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-09-17_prometheus-alerts.png">
<meta property="og:updated_time" content="2021-01-22T03:39:34.080Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-09-16_prometheus-architecture.png">

<link rel="canonical" href="http://houmin.cc/posts/18c039ab/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>【系统监控】Prometheus | Houmin</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


  <script src="/js/photoswipe.min.js?v="></script>
  <script src="/js/photoswipe-ui-default.min.js?v="></script>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Houmin</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">Yesterday You Said Tomorrow</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-album">

    <a href="/album" rel="section"><i class="fa fa-fw fa-camera"></i>相册</a>

  </li>
        <li class="menu-item menu-item-movies">

    <a href="/movies/" rel="section"><i class="fa fa-fw fa-film"></i>观影</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="/books/" rel="section"><i class="fa fa-fw fa-book"></i>阅读</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://houmin.cc/posts/18c039ab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/avatar.png">
      <meta itemprop="name" content="Houmin">
      <meta itemprop="description" content="丈夫拥书万卷，何假南面百城">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Houmin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          【系统监控】Prometheus
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-15 15:53:18" itemprop="dateCreated datePublished" datetime="2020-09-15T15:53:18+08:00">2020-09-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9C%AF%E4%B8%9A%E4%B8%93%E6%94%BB/" itemprop="url" rel="index">
                    <span itemprop="name">术业专攻</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/posts/18c039ab/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/posts/18c039ab/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>55k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:40</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Prometheus是一套开源的完整监控解决方案，对传统监控系统的测试和告警模型进行了彻底的颠覆，形成了基于中央化的规则计算、统一分析和告警的新模型。 Prometheus 采用 Pull 模型通过 HTTP 协议去采集指标，只要应用能够提供 HTTP 接口就可以接入到监控系统，相比于私有协议或二进制协议来说开发、简单。本文总结梳理了在使用 Prometheus 时候的关键概念和用法，关于 Prometheus Exporter 编写方法可以参考 <a href="http://houmin.cc/posts/">这篇文章</a> 。</p>
<a id="more"></a>
<p>相比于传统监控系统， <code>Prometheus</code> 具有以下优点：</p>
<ul>
<li><strong>易于管理</strong>：只有一个单独的二进制文件，不存在任何的第三方依赖，采用Pull的方式拉取数据</li>
<li><strong>强大的数据模型</strong>：每一条时间序列由指标名称(Metrics Name)以及一组标签(Labels)唯一标识</li>
<li><strong>强大的查询语言PromQL</strong>：内置了一个强大的数据查询语言PromQL，可以实现多种查询、聚合</li>
<li><strong>高性能</strong>：单实例可以处理数以百万的监控指标、每秒处理数十万的数据点</li>
<li><strong>易扩展</strong>：支持sharding和联邦集群，实现多数据中心</li>
<li><strong>易集成</strong>：支持多种语言的SDK进行应用程序数据埋点，社区有丰富插件</li>
<li><strong>可视化</strong>：自带Prometheus UI，可以进行查询与展示，Grafana也完整支持Prometheus。</li>
<li><strong>开放性</strong>：使用sdk采集的数据可以被其他监控系统使用，不一定非要用Prometheus</li>
</ul>
<h2 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h2><p>Prometheus 可以采用 Pull 模型从 Exporter 拉取数据，或者间接从 Push Gateway 拉取数据，然后通过一定规则进行清理和整理数据，并把得到的结果存储到新的时间序列中。采集到的数据有两个去向，一个是报警，另一个是可视化。PromQL和其他API可视化地展示收集的数据，并通过Alertmanager提供报警能力。</p>
<p><img alt data-src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-09-16_prometheus-architecture.png"></p>
<p>注意，Prometheus 一般是通过 Pull 模型拉取数据，这里的 PushGateway 主要是面向 <code>Short-lived jobs</code>，由于这类 jobs 存在时间较短，可能在 Prometheus 来 Pull 之前就消失了。因此，这种 jobs 可以直接向 PushGateway 端推送它们的 metrics，然后 Prometheus 再从 PushGateway 拉取数据。</p>
<h2 id="部署使用"><a href="#部署使用" class="headerlink" title="部署使用"></a>部署使用</h2><h3 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h3><p>为了能够容 Prometheus Server 能够从 Node Exporter 等 Exporter 获取到监控数据，需要修改 Prometheus 配置文件，添加 <code>scrape_configs</code> 配置抓取的数据：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">global:</span></span><br><span class="line">      <span class="attr">scrape_interval:</span>     <span class="string">15s</span> </span><br><span class="line">      <span class="attr">evaluation_interval:</span> <span class="string">15s</span></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'prometheus'</span></span><br><span class="line">        <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9090']</span></span><br><span class="line">     <span class="comment"># 采集node exporter监控数据</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'node'</span></span><br><span class="line">       <span class="attr">static_configs:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9100']</span></span><br></pre></td></tr></table></figure>
<p>Prometheus 配置文件主要分为以下几个部分，在本文的后面会详细介绍其中的关键部分配置，更多内容可以参考 <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration" target="_blank" rel="external nofollow noopener noreferrer">官方文档</a> 。其中 <code>scrape_config</code> 部分指定了一系列需要抓取的Target和参数，一般来说，一个scrape配置指定了一个Job，这部分多个<code>scrape_config</code> 以一个列表的形式呈现。Target可以通过 <code>static_configs</code> 来静态配置，也可以通过Prometheus支持的各种服务发现机制来动态配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="comment"># How frequently to scrape targets by default.</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">scrape_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># How long until a scrape request times out.</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">scrape_timeout:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">10s</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># How frequently to evaluate rules.</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">evaluation_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The labels to add to any time series or alerts when communicating with</span></span><br><span class="line">  <span class="comment"># external systems (federation, remote storage, Alertmanager).</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    <span class="string">[</span> <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;labelvalue&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># File to which PromQL queries are logged.</span></span><br><span class="line">  <span class="comment"># Reloading the configuration will reopen the file.</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">query_log_file:</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Rule files specifies a list of globs. Rules and alerts are read from</span></span><br><span class="line"><span class="comment"># all matching files.</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;filepath_glob&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A list of scrape configurations.</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;scrape_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Alerting specifies settings related to the Alertmanager.</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alert_relabel_configs:</span></span><br><span class="line">    <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;relabel_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;alertmanager_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Settings related to the remote write feature.</span></span><br><span class="line"><span class="attr">remote_write:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;remote_write&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Settings related to the remote read feature.</span></span><br><span class="line"><span class="attr">remote_read:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;remote_read&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>当ConfigMap资源创建成功后，我们就可以通过Volume挂载的方式，将Prometheus的配置文件挂载到容器中。 这里我们通过Deployment部署Prometheus Server实例，创建 <code>prometheus-deployment.yml</code>文件，并写入以下内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/prometheus:v2.19.0</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/bin/prometheus</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--config.file=/etc/config/prometheus.yml</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br></pre></td></tr></table></figure>
<p>注意，这里通过命令行配置的 <code>--config.file=/etc/config/prometheus.yml</code>指定了 Prometheus 的配置文件，也就是我们在上面创建的 ConfigMap。</p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9090</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br></pre></td></tr></table></figure>
<h3 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h3><p>由于之前配置了 <code>Traefik</code>，所以这里的 Prometheus 服务不使用 <code>NodePort</code> 方式暴露，在本地设置好 <code>prometheus.houmin</code> 的 host之后，在浏览器中访问：<code>http://prometheus.houmin:&lt;TraefikPort&gt;/</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">traefik</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">prometheus.houmin</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="string">prometheus</span></span><br></pre></td></tr></table></figure>
<h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h2><p>通过Node Exporter暴露的HTTP服务，Prometheus可以采集到当前主机所有监控指标的样本数据。例如：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># HELP node_cpu Seconds the cpus spent in each mode.</span></span><br><span class="line"><span class="meta"># TYPE node_cpu counter</span></span><br><span class="line">node_cpu&#123;cpu=<span class="string">"cpu0"</span>,mode=<span class="string">"idle"</span>&#125; <span class="number">362812.7890625</span></span><br><span class="line"><span class="meta"># HELP node_load1 1m load average.</span></span><br><span class="line"><span class="meta"># TYPE node_load1 gauge</span></span><br><span class="line">node_load1 <span class="number">3.0703125</span></span><br></pre></td></tr></table></figure>
<p>其中非#开头的每一行表示当前Node Exporter采集到的一个监控样本：node_cpu和node_load1表明了当前指标的名称、大括号中的标签则反映了当前样本的一些特征和维度、浮点数则是该监控样本的具体值。</p>
<h3 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h3><p>Prometheus 会将所有采集到的样本数据以时间序列（time-series）的方式保存在内存数据库中，并且定时保存到硬盘上。<code>time-series</code> 是按照时间戳和值的序列顺序存放的，我们称之为 <code>vector</code>。 每条time-series通过指标名称(metrics name)和一组标签集(labelset)命名。如下所示，可以将time-series理解为一个以时间为Y轴的数字矩阵：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">^</span></span><br><span class="line"><span class="string">│</span>   <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span>   <span class="string">.</span> <span class="string">.</span>   <span class="string">node_cpu&#123;cpu="cpu0",mode="idle"&#125;</span></span><br><span class="line"><span class="string">│</span>     <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span>   <span class="string">node_cpu&#123;cpu="cpu0",mode="system"&#125;</span></span><br><span class="line"><span class="string">│</span>     <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span>   <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span>   <span class="string">node_load1&#123;&#125;</span></span><br><span class="line"><span class="string">│</span>     <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span>   <span class="string">.</span> <span class="string">.</span>  </span><br><span class="line"><span class="string">v</span></span><br><span class="line">  <span class="string">&lt;------------------</span> <span class="string">时间</span> <span class="string">----------------&gt;</span></span><br></pre></td></tr></table></figure>
<p>在 <code>time-series</code> 中的每一个点称为一个 <code>sample</code>，<code>sample</code> 由以下三部分组成：</p>
<ul>
<li><code>metric</code>：metric name和描述当前样本特征的labelsets</li>
<li><code>timestamp</code>：一个精确到毫秒的时间戳</li>
<li><code>value</code>： 一个float64的浮点型数据表示当前样本的值</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;---------------</span> <span class="string">metric</span> <span class="string">---------------------&gt;&lt;-timestamp</span> <span class="string">-&gt;&lt;-value-&gt;</span></span><br><span class="line"><span class="string">http_request_total&#123;status="200",</span> <span class="string">method="GET"&#125;@1434417560938</span> <span class="string">=&gt;</span> <span class="number">94355</span></span><br><span class="line"><span class="string">http_request_total&#123;status="200",</span> <span class="string">method="GET"&#125;@1434417561287</span> <span class="string">=&gt;</span> <span class="number">94334</span></span><br><span class="line"></span><br><span class="line"><span class="string">http_request_total&#123;status="404",</span> <span class="string">method="GET"&#125;@1434417560938</span> <span class="string">=&gt;</span> <span class="number">38473</span></span><br><span class="line"><span class="string">http_request_total&#123;status="404",</span> <span class="string">method="GET"&#125;@1434417561287</span> <span class="string">=&gt;</span> <span class="number">38544</span></span><br><span class="line"></span><br><span class="line"><span class="string">http_request_total&#123;status="200",</span> <span class="string">method="POST"&#125;@1434417560938</span> <span class="string">=&gt;</span> <span class="number">4748</span></span><br><span class="line"><span class="string">http_request_total&#123;status="200",</span> <span class="string">method="POST"&#125;@1434417561287</span> <span class="string">=&gt;</span> <span class="number">4785</span></span><br></pre></td></tr></table></figure>
<h3 id="Metric"><a href="#Metric" class="headerlink" title="Metric"></a>Metric</h3><p>在形式上，所有的 Metric 都通过如下格式标示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;metric</span> <span class="string">name&gt;&#123;&lt;label</span> <span class="string">name&gt;=&lt;label</span> <span class="string">value&gt;,</span> <span class="string">...&#125;</span></span><br></pre></td></tr></table></figure>
<p>其在 Prometheus 源码种表示的数据结构如下：</p>
<figure class="highlight go"><figcaption><span>github.com/prometheus/common/model</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Metric LabelSet</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LabelSet <span class="keyword">map</span>[LabelName]LabelValue</span><br><span class="line"><span class="keyword">type</span> LabelName <span class="keyword">string</span></span><br><span class="line"><span class="keyword">type</span> LabelValue <span class="keyword">string</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>Metric Name</code> 可以反映被监控样本的含义，比如，<code>http_request_total</code> - 表示当前系统接收到的HTTP请求总量</p>
</li>
<li><p><code>Label</code>反映了当前样本的特征维度，通过这些维度Prometheus可以对样本数据进行过滤，聚合等。</p>
<ul>
<li><p>其中以<code>__</code>作为前缀的标签，是系统保留的关键字，只能在系统内部使用。标签的值则可以包含任何Unicode编码的字符。在Prometheus的底层实现中指标名称实际上是以<code>__name__=&lt;metric name&gt;</code>的形式保存在数据库中的，因此以下两种方式均表示的同一条time-series：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">api_http_requests_total&#123;method="POST", handler="/messages"&#125;</span><br></pre></td></tr></table></figure>
<p>等同于：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;__name__="api_http_requests_total"，method="POST", handler="/messages"&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>Prometheus定义了4中不同的指标类型：</p>
<h4 id="Counter-只增不减的计数器"><a href="#Counter-只增不减的计数器" class="headerlink" title="Counter 只增不减的计数器"></a>Counter 只增不减的计数器</h4><p>计数器，如 <code>http_requests_total</code>请求总数</p>
<h4 id="Gauge-可增可减的仪表盘"><a href="#Gauge-可增可减的仪表盘" class="headerlink" title="Gauge 可增可减的仪表盘"></a>Gauge 可增可减的仪表盘</h4><p>当前状态，如 <code>kube_pod_status_ready</code>当前pod可用数</p>
<h4 id="Histogram-直方图"><a href="#Histogram-直方图" class="headerlink" title="Histogram 直方图"></a>Histogram 直方图</h4><p>在大多数情况下人们都倾向于使用某些量化指标的平均值，例如CPU的平均使用率、页面的平均响应时间。这种方式的问题很明显，以系统API调用的平均响应时间为例：如果大多数API请求都维持在100ms的响应时间范围内，而个别请求的响应时间需要5s，那么就会导致某些WEB页面的响应时间落到中位数的情况，而这种现象被称为 <strong>长尾问题</strong>。</p>
<p>为了区分是平均的慢还是长尾的慢，最简单的方式就是按照请求延迟的范围进行分组。例如，统计延迟在0~10ms之间的请求数有多少而10~20ms之间的请求数又有多少。通过这种方式可以快速分析系统慢的原因。Histogram 和Summary都是为了能够解决这样问题的存在，通过Histogram和Summary类型的监控指标，我们可以快速了解监控样本的分布情况。</p>
<p>Histogram 由下面四个部分组成，主要用于表示一段时间范围内对数据进行采样（通常是请求持续时间或响应大小），并能够对其指定区间以及总数进行统计，通常它采集的数据展示为直方图。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- &lt;basename&gt;_bucket&#123;le="&lt;upper inclusive bound&gt;"&#125;</span><br><span class="line">- &lt;basename&gt;_bucket&#123;le="+Inf"&#125;</span><br><span class="line">- &lt;basename&gt;_sum</span><br><span class="line">- &lt;basename&gt;_count</span><br></pre></td></tr></table></figure></p>
<p>在Prometheus Server自身返回的样本数据中，我们还能找到类型为Histogram的监控指标 <code>prometheus_tsdb_compaction_chunk_range_bucket</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP prometheus_tsdb_compaction_chunk_range Final time range of chunks on their first compaction</span></span><br><span class="line"><span class="comment"># TYPE prometheus_tsdb_compaction_chunk_range histogram</span></span><br><span class="line"><span class="string">prometheus_tsdb_compaction_chunk_range_bucket&#123;le="100"&#125;</span> <span class="number">0</span></span><br><span class="line"><span class="string">prometheus_tsdb_compaction_chunk_range_bucket&#123;le="400"&#125;</span> <span class="number">0</span></span><br><span class="line"><span class="string">prometheus_tsdb_compaction_chunk_range_bucket&#123;le="1600"&#125;</span> <span class="number">0</span></span><br><span class="line"><span class="string">prometheus_tsdb_compaction_chunk_range_bucket&#123;le="6400"&#125;</span> <span class="number">0</span></span><br><span class="line"><span class="string">prometheus_tsdb_compaction_chunk_range_bucket&#123;le="25600"&#125;</span> <span class="number">0</span></span><br><span class="line"><span class="string">prometheus_tsdb_compaction_chunk_range_bucket&#123;le="102400"&#125;</span> <span class="number">0</span></span><br><span class="line"><span class="string">prometheus_tsdb_compaction_chunk_range_bucket&#123;le="409600"&#125;</span> <span class="number">0</span></span><br><span class="line"><span class="string">prometheus_tsdb_compaction_chunk_range_bucket&#123;le="1.6384e+06"&#125;</span> <span class="number">260</span></span><br><span class="line"><span class="string">prometheus_tsdb_compaction_chunk_range_bucket&#123;le="6.5536e+06"&#125;</span> <span class="number">780</span></span><br><span class="line"><span class="string">prometheus_tsdb_compaction_chunk_range_bucket&#123;le="2.62144e+07"&#125;</span> <span class="number">780</span></span><br><span class="line"><span class="string">prometheus_tsdb_compaction_chunk_range_bucket&#123;le="+Inf"&#125;</span> <span class="number">780</span></span><br><span class="line"><span class="string">prometheus_tsdb_compaction_chunk_range_sum</span> <span class="number">1.1540798e+09</span></span><br><span class="line"><span class="string">prometheus_tsdb_compaction_chunk_range_count</span> <span class="number">780</span></span><br></pre></td></tr></table></figure>
<h4 id="Summary-摘要"><a href="#Summary-摘要" class="headerlink" title="Summary 摘要"></a>Summary 摘要</h4><p>Summary 和 Histogram 类似，由下面3个部分组成，主要用于表示一段时间内数据采样结果（通常是请求持续时间或响应大小），它直接存储了 quantile 分位值 数据，而不是像 Histogram 需要根据统计区间计算分位值：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- <span class="tag">&lt;<span class="name">basename</span>&gt;</span>&#123;quantile="<span class="tag">&lt;<span class="name">φ</span>&gt;</span>"&#125;</span><br><span class="line">- <span class="tag">&lt;<span class="name">basename</span>&gt;</span>_sum</span><br><span class="line">- <span class="tag">&lt;<span class="name">basename</span>&gt;</span>_count</span><br></pre></td></tr></table></figure></p>
<p>例如，指标 <code>prometheus_tsdb_wal_fsync_duration_seconds</code> 的指标类型为Summary。 它记录了Prometheus Server中 <code>wal_fsync</code> 处理的处理时间，通过访问 <code>Prometheus Server</code> 的 <code>/metrics</code> 地址，可以获取到以下监控样本数据：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP prometheus_tsdb_wal_fsync_duration_seconds Duration of WAL fsync.</span></span><br><span class="line"><span class="comment"># TYPE prometheus_tsdb_wal_fsync_duration_seconds summary</span></span><br><span class="line"><span class="string">prometheus_tsdb_wal_fsync_duration_seconds&#123;quantile="0.5"&#125;</span> <span class="number">0.012352463</span></span><br><span class="line"><span class="string">prometheus_tsdb_wal_fsync_duration_seconds&#123;quantile="0.9"&#125;</span> <span class="number">0.014458005</span></span><br><span class="line"><span class="string">prometheus_tsdb_wal_fsync_duration_seconds&#123;quantile="0.99"&#125;</span> <span class="number">0.017316173</span></span><br><span class="line"><span class="string">prometheus_tsdb_wal_fsync_duration_seconds_sum</span> <span class="number">2.888716127000002</span></span><br><span class="line"><span class="string">prometheus_tsdb_wal_fsync_duration_seconds_count</span> <span class="number">216</span></span><br></pre></td></tr></table></figure>
<p>从上面的样本中可以得知当前Prometheus Server进行wal_fsync操作的总次数为216次，耗时2.888716127000002s。其中中位数（quantile=0.5）的耗时为0.012352463，9分位数（quantile=0.9）的耗时为0.014458005s。</p>
<h2 id="PromQL查询"><a href="#PromQL查询" class="headerlink" title="PromQL查询"></a>PromQL查询</h2><p>PromQL是Prometheus内置的数据查询语言，其提供对时间序列数据丰富的查询，聚合以及逻辑运算能力的支持。并且被广泛应用在Prometheus的日常应用当中，包括对数据查询、可视化、告警处理当中。表达式的结果可以在浏览器中显示为图形，也可以显示为表格数据，或者由外部系统通过 HTTP API 调用。通过PromQL用户可以非常方便地查询监控数据，或者利用表达式进行告警配置。比如集群中网络使用：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum by (<span class="name">name</span>) (<span class="name">rate</span>(<span class="name">container_network_receive_bytes_total</span>&#123;image!=<span class="string">""</span>&#125;[<span class="number">1</span>m]))</span><br></pre></td></tr></table></figure>
<p><img alt data-src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-09-16_prometheus-cadvisor-network.png"></p>
<p>下面将介绍 PromQL 的具体语法和使用。</p>
<h3 id="查询时间序列"><a href="#查询时间序列" class="headerlink" title="查询时间序列"></a>查询时间序列</h3><p>当我们直接使用监控指标名称查询时，可以查询该指标下的所有时间序列。如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">http_requests_total</span></span><br></pre></td></tr></table></figure>
<p>等同于：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">http_requests_total</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>该表达式会返回指标名称为http_requests_total的所有时间序列：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;code="200",handler="alerts",instance="localhost:9090",job="prometheus",method="get"&#125;=(20889@1518096812.326)</span><br><span class="line">http_requests_total&#123;code="200",handler="graph",instance="localhost:9090",job="prometheus",method="get"&#125;=(21287@1518096812.326)</span><br></pre></td></tr></table></figure>
<p>PromQL还支持用户<strong>根据时间序列的标签匹配模式</strong>来对时间序列进行过滤，目前主要支持两种匹配模式：</p>
<ul>
<li>完全匹配</li>
<li>正则匹配</li>
</ul>
<p>PromQL支持使用<code>=</code>和<code>!=</code>两种完全匹配模式：</p>
<ul>
<li>通过使用<code>label=value</code>可以选择那些标签满足表达式定义的时间序列；</li>
<li>反之使用<code>label!=value</code>则可以根据标签匹配排除时间序列；</li>
</ul>
<p>例如，如果我们只需要查询所有 <code>http_requests_total</code> 时间序列中满足标签 <code>instance</code> 为 <code>localhost:9090</code> 的时间序列，则可以使用如下表达式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;instance="localhost:9090"&#125;</span><br></pre></td></tr></table></figure>
<p>反之使用<code>instance!=&quot;localhost:9090&quot;</code>则可以排除这些时间序列：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;instance!="localhost:9090"&#125;</span><br></pre></td></tr></table></figure>
<p>除了使用完全匹配的方式对时间序列进行过滤以外，PromQL还可以支持使用正则表达式作为匹配条件，多个表达式之间使用<code>|</code>进行分离：</p>
<ul>
<li>使用<code>label=~regx</code>表示选择那些标签符合正则表达式定义的时间序列；</li>
<li>反之使用<code>label!~regx</code>进行排除；</li>
</ul>
<p>例如，如果想查询多个环节下的时间序列序列可以使用如下表达式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;environment=~"staging|testing|development",method!="GET"&#125;</span><br></pre></td></tr></table></figure>
<h3 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h3><p>Prometheus 中根据是瞬时还是时间范围，可以分为：</p>
<ul>
<li><strong>瞬时向量表达式</strong>：直接通过类似于PromQL表达式<code>http_requests_total</code>查询时间序列时，返回值中只会包含该时间序列中的最新的一个样本值</li>
<li><strong>区间向量表达式</strong>：如果我们想过去一段时间范围内的样本数据时，通过时间范围选择器<code>[]</code>进行定义时间选择的范围</li>
</ul>
<p>例如，通过以下表达式可以选择最近5分钟内的所有样本数据：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;&#125;[5m]</span><br></pre></td></tr></table></figure>
<p>该表达式将会返回查询到的时间序列中最近5分钟的所有样本数据：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;code="200",handler="alerts",instance="localhost:9090",job="prometheus",method="get"&#125;=[</span><br><span class="line">    1@1518096812.326</span><br><span class="line">    1@1518096817.326</span><br><span class="line">    1@1518096822.326</span><br><span class="line">    1@1518096827.326</span><br><span class="line">    1@1518096832.326</span><br><span class="line">    1@1518096837.325</span><br><span class="line">]</span><br><span class="line">http_requests_total&#123;code="200",handler="graph",instance="localhost:9090",job="prometheus",method="get"&#125;=[</span><br><span class="line">    4@1518096812.326</span><br><span class="line">    4@1518096817.326</span><br><span class="line">    4@1518096822.326</span><br><span class="line">    4@1518096827.326</span><br><span class="line">    4@1518096832.326</span><br><span class="line">    4@1518096837.325</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>通过区间向量表达式查询到的结果我们称为<strong>区间向量</strong>。</p>
<p>除了使用m表示分钟以外，PromQL的时间范围选择器支持其它时间单位：</p>
<ul>
<li>s - 秒</li>
<li>m - 分钟</li>
<li>h - 小时</li>
<li>d - 天</li>
<li>w - 周</li>
<li>y - 年</li>
</ul>
<h3 id="时间位移操作"><a href="#时间位移操作" class="headerlink" title="时间位移操作"></a>时间位移操作</h3><p>在瞬时向量表达式或者区间向量表达式中，都是以当前时间为基准：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">http_request_total&#123;&#125;</span> <span class="comment"># 瞬时向量表达式，选择当前最新的数据</span></span><br><span class="line"><span class="string">http_request_total&#123;&#125;[5m]</span> <span class="comment"># 区间向量表达式，选择以当前时间为基准，5分钟内的数据</span></span><br></pre></td></tr></table></figure>
<p>而如果我们想查询，5分钟前的瞬时样本数据，或昨天一天的区间内的样本数据呢? 这个时候我们就可以使用位移操作，位移操作的关键字为<strong>offset</strong>。</p>
<p>可以使用offset时间位移操作：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_request_total&#123;&#125; offset 5m</span><br><span class="line">http_request_total&#123;&#125;[1d] offset 1d</span><br></pre></td></tr></table></figure>
<p>请注意，偏移量修饰符始终需要跟随选择器，即以下是正确的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(http_requests_total&#123;method="GET"&#125; offset 5m) // GOOD.</span><br></pre></td></tr></table></figure>
<p>下面是错误的:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(http_requests_total&#123;method="GET"&#125;) offset 5m // INVALID.</span><br></pre></td></tr></table></figure>
<h3 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h3><p>使用PromQL除了能够方便的按照查询和过滤时间序列以外，PromQL还支持丰富的操作符，用户可以使用这些操作符对进一步的对事件序列进行二次加工。这些操作符包括：<strong>数学运算符</strong>，<strong>逻辑运算符</strong>，<strong>布尔运算符</strong>等等。</p>
<h4 id="数学运算"><a href="#数学运算" class="headerlink" title="数学运算"></a>数学运算</h4><p>例如，我们可以通过指标node_memory_free_bytes_total获取当前主机可用的内存空间大小，其样本单位为Bytes。这是如果客户端要求使用MB作为单位响应数据，那只需要将查询到的时间序列的样本值进行单位换算即可：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_memory_free_bytes_total / (1024 * 1024)</span><br></pre></td></tr></table></figure>
<p><code>node_memory_free_bytes_total</code> 表达式会查询出所有满足表达式条件的时间序列，在上一小节中我们称该表达式为瞬时向量表达式，而返回的结果成为瞬时向量。当瞬时向量与标量之间进行数学运算时，数学运算符会依次作用域瞬时向量中的每一个样本值，从而得到一组新的时间序列。</p>
<p>如果是瞬时向量与瞬时向量之间进行数学运算时，过程会相对复杂一点。 例如，如果我们想根据 <code>node_disk_bytes_written</code> 和 <code>node_disk_bytes_read</code> 获取主机磁盘IO的总量，可以使用如下表达式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_disk_bytes_written + node_disk_bytes_read</span><br></pre></td></tr></table></figure>
<p>那这个表达式是如何工作的呢？依次找到与左边向量元素匹配（标签完全一致）的右边向量元素进行运算，如果没找到匹配元素，则直接丢弃。同时新的时间序列将不会包含指标名称。 该表达式返回结果的示例如下所示：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;device="sda",instance="localhost:9100",job="node_exporter"&#125;=&gt;1634967552@1518146427.807 + 864551424@1518146427.807</span><br><span class="line">&#123;device="sdb",instance="localhost:9100",job="node_exporter"&#125;=&gt;0@1518146427.807 + 1744384@1518146427.807</span><br></pre></td></tr></table></figure>
<p>PromQL支持的所有数学运算符如下所示：</p>
<ul>
<li><code>+</code> (加法)</li>
<li><code>-</code> (减法)</li>
<li><code>*</code> (乘法)</li>
<li><code>/</code> (除法)</li>
<li><code>%</code> (求余)</li>
<li><code>^</code> (幂运算)</li>
</ul>
<h4 id="布尔运算"><a href="#布尔运算" class="headerlink" title="布尔运算"></a>布尔运算</h4><p>在PromQL通过标签匹配模式，用户可以根据时间序列的特征维度对其进行查询。而布尔运算则支持用户根据时间序列中样本的值，对时间序列进行过滤。</p>
<p>例如，通过数学运算符我们可以很方便的计算出，当前所有主机节点的内存使用率：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_memory_bytes_total - node_memory_free_bytes_total) / node_memory_bytes_total</span><br></pre></td></tr></table></figure>
<p>而系统管理员在排查问题的时候可能只想知道当前内存使用率超过95%的主机呢？通过使用布尔运算符可以方便的获取到该结果：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_memory_bytes_total - node_memory_free_bytes_total) / node_memory_bytes_total &gt; 0.95</span><br></pre></td></tr></table></figure>
<ul>
<li>瞬时向量与标量进行布尔运算时，PromQL依次比较向量中的所有时间序列样本的值，如果比较结果为true则保留，反之丢弃。</li>
<li>瞬时向量与瞬时向量直接进行布尔运算时，同样遵循默认的匹配模式：依次找到与左边向量元素匹配（标签完全一致）的右边向量元素进行相应的操作，如果没找到匹配元素，则直接丢弃。</li>
</ul>
<p>目前，Prometheus支持以下布尔运算符如下：</p>
<ul>
<li><code>==</code> (相等)</li>
<li><code>!=</code> (不相等)</li>
<li><code>&gt;</code> (大于)</li>
<li><code>&lt;</code> (小于)</li>
<li><code>&gt;=</code> (大于等于)</li>
<li><code>&lt;=</code> (小于等于)</li>
</ul>
<h4 id="集合运算"><a href="#集合运算" class="headerlink" title="集合运算"></a>集合运算</h4><p>使用瞬时向量表达式能够获取到一个包含多个时间序列的集合，我们称为<strong>瞬时向量</strong>。 通过集合运算，可以在两个瞬时向量与瞬时向量之间进行相应的集合操作。目前，Prometheus支持以下集合运算符：</p>
<ul>
<li><code>and</code> (并且)</li>
<li><code>or</code> (或者)</li>
<li><code>unless</code> (排除)</li>
</ul>
<p><strong><em>vector1 and vector2</em></strong> 会产生一个由vector1的元素组成的新的向量。该向量包含vector1中完全匹配vector2中的元素组成。</p>
<p><strong><em>vector1 or vector2</em></strong> 会产生一个新的向量，该向量包含vector1中所有的样本数据，以及vector2中没有与vector1匹配到的样本数据。</p>
<p><strong><em>vector1 unless vector2</em></strong> 会产生一个新的向量，新向量中的元素由vector1中没有与vector2匹配的元素组成。</p>
<h4 id="操作符优先级"><a href="#操作符优先级" class="headerlink" title="操作符优先级"></a>操作符优先级</h4><p>对于复杂类型的表达式，需要了解运算操作的运行优先级。例如，查询主机的CPU使用率，可以使用表达式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100 * (1 - avg (irate(node_cpu&#123;mode='idle'&#125;[5m])) by(job) )</span><br></pre></td></tr></table></figure>
<p>其中 <code>irate</code> 是PromQL中的内置函数，用于计算区间向量中时间序列每秒的即时增长率。关于内置函数的部分，会在后面详细介绍。</p>
<p>在PromQL操作符中优先级由高到低依次为：</p>
<ol>
<li><code>^</code></li>
<li><code>*, /, %</code></li>
<li><code>+, -</code></li>
<li><code>==, !=, &lt;=, &lt;, &gt;=, &gt;</code></li>
<li><code>and, unless</code></li>
<li><code>or</code></li>
</ol>
<h4 id="匹配模式（联合查询）"><a href="#匹配模式（联合查询）" class="headerlink" title="匹配模式（联合查询）"></a>匹配模式（联合查询）</h4><p>向量与向量之间进行运算操作时会基于默认的匹配规则：依次找到与左边向量元素匹配（标签完全一致）的右边向量元素进行运算，如果没找到匹配元素，则直接丢弃。在PromQL中有两种典型的匹配模式：</p>
<ul>
<li>一对一（one-to-one）</li>
<li>多对一（many-to-one）或一对多（one-to-many）</li>
</ul>
<h5 id="一对一匹配"><a href="#一对一匹配" class="headerlink" title="一对一匹配"></a><strong>一对一匹配</strong></h5><p>一对一匹配模式会从操作符两边表达式获取的瞬时向量依次比较并找到唯一匹配(标签完全一致)的样本值。默认情况下，使用表达式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vector1 &lt;operator&gt; vector2</span><br></pre></td></tr></table></figure>
<p>在操作符两边表达式标签不一致的情况下，可以使用 <code>on(label list)</code> 或者 <code>ignoring(label list）</code> 来修改标签的匹配行为：</p>
<ul>
<li>使用ignoreing可以在匹配时忽略某些标签</li>
<li>使用 on 则用于将匹配行为限定在某些标签之内</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) &lt;vector expr&gt;</span><br></pre></td></tr></table></figure>
<p>例如当存在样本：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">method_code:http_errors:rate5m&#123;method="get", code="500"&#125;  24</span><br><span class="line">method_code:http_errors:rate5m&#123;method="get", code="404"&#125;  30</span><br><span class="line">method_code:http_errors:rate5m&#123;method="put", code="501"&#125;  3</span><br><span class="line">method_code:http_errors:rate5m&#123;method="post", code="500"&#125; 6</span><br><span class="line">method_code:http_errors:rate5m&#123;method="post", code="404"&#125; 21</span><br><span class="line"></span><br><span class="line">method:http_requests:rate5m&#123;method="get"&#125;  600</span><br><span class="line">method:http_requests:rate5m&#123;method="del"&#125;  34</span><br><span class="line">method:http_requests:rate5m&#123;method="post"&#125; 120</span><br></pre></td></tr></table></figure>
<p>使用PromQL表达式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method_code:http_errors:rate5m&#123;code="500"&#125; / ignoring(code) method:http_requests:rate5m</span><br></pre></td></tr></table></figure>
<p>该表达式会返回在过去5分钟内，HTTP请求状态码为500的在所有请求中的比例。如果没有使用ignoring(code)，操作符两边表达式返回的瞬时向量中将找不到任何一个标签完全相同的匹配项。</p>
<p>因此结果如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;method="get"&#125;  0.04            //  24 / 600</span><br><span class="line">&#123;method="post"&#125; 0.05            //   6 / 120</span><br></pre></td></tr></table></figure>
<p>同时由于method为put和del的样本找不到匹配项，因此不会出现在结果当中。</p>
<h5 id="多对一和一对多"><a href="#多对一和一对多" class="headerlink" title="多对一和一对多"></a><strong>多对一和一对多</strong></h5><p>多对一和一对多两种匹配模式指的是一侧的每一个向量元素可以与多侧的多个元素匹配的情况。在这种情况下，必须使用group修饰符：<code>group_left</code> 或者<code>group_righ</code> t来确定哪一个向量具有更高的基数（充当“多”的角色）。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;</span><br></pre></td></tr></table></figure>
<p>多对一和一对多两种模式一定是出现在操作符两侧表达式返回的向量标签不一致的情况。因此需要使用 <code>ignoring</code> 和 <code>on</code> 修饰符来排除或者限定匹配的标签列表。例如，使用表达式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method_code:http_errors:rate5m / ignoring(code) group_left method:http_requests:rate5m</span><br></pre></td></tr></table></figure>
<p>该表达式中，左向量<code>method_code:http_errors:rate5m</code>包含两个标签method和code。而右向量<code>method:http_requests:rate5m</code>中只包含一个标签method，因此匹配时需要使用ignoring限定匹配的标签为code。 在限定匹配标签后，右向量中的元素可能匹配到多个左向量中的元素 因此该表达式的匹配模式为多对一，需要使用group修饰符group_left指定左向量具有更好的基数。</p>
<p>最终的运算结果如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;method="get", code="500"&#125;  0.04            //  24 / 600</span><br><span class="line">&#123;method="get", code="404"&#125;  0.05            //  30 / 600</span><br><span class="line">&#123;method="post", code="500"&#125; 0.05            //   6 / 120</span><br><span class="line">&#123;method="post", code="404"&#125; 0.175           //  21 / 120</span><br></pre></td></tr></table></figure>
<blockquote>
<p>提醒：group修饰符只能在比较和数学运算符中使用。在逻辑运算and,unless和or才注意操作中默认与右向量中的所有元素进行匹配。</p>
</blockquote>
<h3 id="聚合操作"><a href="#聚合操作" class="headerlink" title="聚合操作"></a>聚合操作</h3><p>一般来说，如果描述样本特征的 label 在并非唯一的情况下，通过PromQL查询数据，会返回多条满足这些特征维度的时间序列。而PromQL提供的聚合操作可以用来对这些时间序列进行处理，形成一条新的时间序列：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询系统所有http请求的总量</span></span><br><span class="line"><span class="string">sum(http_request_total)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照mode计算主机CPU的平均使用时间</span></span><br><span class="line"><span class="string">avg(node_cpu)</span> <span class="string">by</span> <span class="string">(mode)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照主机查询各个主机的CPU使用率</span></span><br><span class="line"><span class="string">sum(sum(irate(node_cpu&#123;mode!='idle'&#125;[5m]))</span> <span class="string">/</span> <span class="string">sum(irate(node_cpu[5m])))</span> <span class="string">by</span> <span class="string">(instance)</span></span><br></pre></td></tr></table></figure>
<p>Prometheus 还提供了下列内置的聚合操作符，这些操作符作用域瞬时向量。可以将瞬时表达式返回的样本数据进行聚合，形成一个具有较少样本值的新的时间序列：</p>
<ul>
<li><code>sum</code> (求和)</li>
<li><code>min</code> (最小值)</li>
<li><code>max</code> (最大值)</li>
<li><code>avg</code> (平均值)</li>
<li><code>stddev</code> (标准差)</li>
<li><code>stdvar</code> (标准方差)</li>
<li><code>count</code> (计数)</li>
<li><code>count_values</code> (对value进行计数)</li>
<li><code>bottomk</code> (后n条时序)</li>
<li><code>topk</code> (前n条时序)</li>
<li><code>quantile</code> (分位数)</li>
</ul>
<p>使用聚合操作的语法如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]</span><br></pre></td></tr></table></figure>
<p>其中只有<code>count_values</code>, <code>quantile</code>, <code>topk</code>, <code>bottomk</code>支持参数(parameter)。这些操作符被用于聚合所有标签维度，或者通过 without 或者 by 子语句来保留不同的维度。</p>
<ul>
<li><code>without</code>用于从计算结果中移除列举的标签，而保留其它标签</li>
<li><code>by</code> 则正好相反，结果向量中只保留列出的标签，其余标签则移除</li>
</ul>
<p>通过without和by可以按照样本的问题对数据进行聚合。例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(http_requests_total) without (instance)</span><br></pre></td></tr></table></figure>
<p>等价于</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(http_requests_total) by (code,handler,job,method)</span><br></pre></td></tr></table></figure>
<p>如果只需要计算整个应用的HTTP请求总量，可以直接使用表达式：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">sum</span><span class="params">(http_requests_total)</span></span></span><br></pre></td></tr></table></figure>
<p>count_values用于时间序列中每一个样本值出现的次数。count_values会为每一个唯一的样本值输出一个时间序列，并且每一个时间序列包含一个额外的标签。例如：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">count_values</span><span class="params">(<span class="string">"count"</span>, http_requests_total)</span></span></span><br></pre></td></tr></table></figure>
<p>topk和bottomk则用于对样本值进行排序，返回当前样本值前n位，或者后n位的时间序列。</p>
<p>获取HTTP请求数前5位的时序样本数据，可以使用表达式：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">topk</span><span class="params">(<span class="number">5</span>, http_requests_total)</span></span></span><br></pre></td></tr></table></figure>
<p><code>quantile</code> 用于计算当前样本数据值的分布情况<code>quantile(φ, express)</code>其中 <code>0 ≤ φ ≤ 1</code>。</p>
<p>例如，当φ为0.5时，即表示找到当前样本数据中的中位数：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">quantile(0.5, http_requests_total)</span><br></pre></td></tr></table></figure>
<h3 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h3><p>Prometheus还提供了其它大量的内置函数，可以对时序数据进行丰富的处理。本小节将带来读者了解一些常用的内置函数以及相关的使用场景和用法。</p>
<h4 id="计算Counter指标增长率"><a href="#计算Counter指标增长率" class="headerlink" title="计算Counter指标增长率"></a><strong>计算Counter指标增长率</strong></h4><p>我们知道Counter类型的监控指标其特点是只增不减，在没有发生重置（如服务器重启，应用重启）的情况下其样本值应该是不断增大的。为了能够更直观的表示样本数据的变化剧烈情况，需要计算样本的增长速率。</p>
<p>如下图所示，样本增长率反映出了样本变化的剧烈程度：</p>
<p><img alt="通过增长率表示样本的变化情况" data-src="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LVT4hCAm7HWaP8rOjeF%2F-LPS8MxTnlks9MW9afcf%2Fcounter-to-rate.png"></p>
<p><code>increase(v range-vector)</code> 函数是PromQL中提供的众多内置函数之一。其中参数v是一个区间向量，increase函数获取区间向量中的第一个和最后一个样本并返回其增长量。因此，可以通过以下表达式Counter类型指标的增长率：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">increase(node_cpu[2m]) / 120</span><br></pre></td></tr></table></figure>
<p>这里通过 <code>node_cpu[2m]</code> 获取时间序列最近两分钟的所有样本，increase计算出最近两分钟的增长量，最后除以时间120秒得到node_cpu样本在最近两分钟的平均增长率。并且这个值也近似于主机节点最近两分钟内的平均CPU使用率。</p>
<p>除了使用 <code>increase</code> 函数以外，PromQL中还直接内置了<code>rate(v range-vector)</code>函数，rate函数可以直接计算区间向量v在时间窗口内<strong>平均增长速率</strong>。因此，通过以下表达式可以得到与increase函数相同的结果：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(node_cpu[2m])</span><br></pre></td></tr></table></figure>
<p>需要注意的是使用rate或者increase函数去计算样本的平均增长速率，容易陷入“长尾问题”当中，其无法反应在时间窗口内样本数据的突发变化。 例如，对于主机而言在2分钟的时间窗口内，可能在某一个由于访问量或者其它问题导致CPU占用100%的情况，但是通过计算在时间窗口内的平均增长率却无法反应出该问题。</p>
<p>为了解决该问题，PromQL提供了另外一个灵敏度更高的函数 <code>irate(v range-vector)</code>。irate同样用于计算区间向量的计算率，但是其反应出的是瞬时增长率。irate函数是通过区间向量中最后两个样本数据来计算区间向量的增长速率。这种方式可以避免在时间窗口范围内的“长尾问题”，并且体现出更好的灵敏度，通过irate函数绘制的图标能够更好的反应样本数据的瞬时变化状态。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">irate(node_cpu[2m])</span><br></pre></td></tr></table></figure>
<p>irate函数相比于rate函数提供了更高的灵敏度，不过当需要分析长期趋势或者在告警规则中，irate的这种灵敏度反而容易造成干扰。因此在长期趋势分析或者告警中更推荐使用rate函数。</p>
<h4 id="预测Gauge指标变化趋势"><a href="#预测Gauge指标变化趋势" class="headerlink" title="预测Gauge指标变化趋势"></a><strong>预测Gauge指标变化趋势</strong></h4><p>在一般情况下，系统管理员为了确保业务的持续可用运行，会针对服务器的资源设置相应的告警阈值。例如，当磁盘空间只剩512MB时向相关人员发送告警通知。 这种基于阈值的告警模式对于当资源用量是平滑增长的情况下是能够有效的工作的。 但是如果资源不是平滑变化的呢？ 比如有些某些业务增长，存储空间的增长速率提升了高几倍。这时，如果基于原有阈值去触发告警，当系统管理员接收到告警以后可能还没来得及去处理问题，系统就已经不可用了。 因此阈值通常来说不是固定的，需要定期进行调整才能保证该告警阈值能够发挥去作用。 那么还有没有更好的方法吗？</p>
<p>PromQL中内置的 <code>predict_linear(v range-vector, t scalar)</code> 函数可以帮助系统管理员更好的处理此类情况，<code>predict_linear</code> 函数可以预测时间序列v在t秒后的值。它基于简单线性回归的方式，对时间窗口内的样本数据进行统计，从而可以对时间序列的变化趋势做出预测。例如，基于2小时的样本数据，来预测主机可用磁盘空间的是否在4个小时候被占满，可以使用如下表达式：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">predict_linear(node_filesystem_free&#123;job=<span class="string">"node"</span>&#125;[<span class="number">2</span>h], <span class="number">4</span> * <span class="number">3600</span>) &lt; <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h4 id="统计Histogram指标的分位数"><a href="#统计Histogram指标的分位数" class="headerlink" title="统计Histogram指标的分位数"></a><strong>统计Histogram指标的分位数</strong></h4><p>前面我们介绍了Prometheus的四种监控指标类型，其中Histogram和Summary都可以用于统计和分析数据的分布情况。区别在于Summary是直接在客户端计算了数据分布的分位数情况。而Histogram的分位数计算需要通过 <code>histogram_quantile(φ float, b instant-vector)</code> 函数进行计算。其中 <code>φ（0&lt;φ&lt;1）</code>表示需要计算的分位数，如果需要计算中位数φ取值为0.5，以此类推即可。</p>
<p>以指标http_request_duration_seconds_bucket为例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP http_request_duration_seconds request duration histogram</span></span><br><span class="line"><span class="comment"># TYPE http_request_duration_seconds histogram</span></span><br><span class="line"><span class="string">http_request_duration_seconds_bucket&#123;le="0.5"&#125;</span> <span class="number">0</span></span><br><span class="line"><span class="string">http_request_duration_seconds_bucket&#123;le="1"&#125;</span> <span class="number">1</span></span><br><span class="line"><span class="string">http_request_duration_seconds_bucket&#123;le="2"&#125;</span> <span class="number">2</span></span><br><span class="line"><span class="string">http_request_duration_seconds_bucket&#123;le="3"&#125;</span> <span class="number">3</span></span><br><span class="line"><span class="string">http_request_duration_seconds_bucket&#123;le="5"&#125;</span> <span class="number">3</span></span><br><span class="line"><span class="string">http_request_duration_seconds_bucket&#123;le="+Inf"&#125;</span> <span class="number">3</span></span><br><span class="line"><span class="string">http_request_duration_seconds_sum</span> <span class="number">6</span></span><br><span class="line"><span class="string">http_request_duration_seconds_count</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>当计算9分位数时，使用如下表达式：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">histogram_quantile</span><span class="params">(<span class="number">0.5</span>, http_request_duration_seconds_bucket)</span></span></span><br></pre></td></tr></table></figure>
<p>通过对Histogram类型的监控指标，用户可以轻松获取样本数据的分布情况。同时分位数的计算，也可以非常方便的用于评判当前监控指标的服务水平。</p>
<p><img alt="获取分布直方图的中位数" data-src="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LVT4hCAm7HWaP8rOjeF%2F-LPS8MxYOMNuHXOylcUA%2Fhistogram_quantile.png?alt=media"></p>
<p>需要注意的是通过 <code>histogram_quantile</code> 计算的分位数，并非为精确值，而是通过 <code>http_request_duration_seconds_bucket</code> 和<code>http_request_duration_seconds_sum</code> 近似计算的结果。</p>
<h4 id="动态标签替换"><a href="#动态标签替换" class="headerlink" title="动态标签替换"></a><strong>动态标签替换</strong></h4><p>一般来说来说，使用 <code>PromQL</code> 查询到时间序列后，可视化工具会根据时间序列的标签来渲染图表。例如通过up指标可以获取到当前所有运行的Exporter实例以及其状态：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">up&#123;instance="localhost:8080",job="cadvisor"&#125;</span>    <span class="number">1</span></span><br><span class="line"><span class="string">up&#123;instance="localhost:9090",job="prometheus"&#125;</span>    <span class="number">1</span></span><br><span class="line"><span class="string">up&#123;instance="localhost:9100",job="node"&#125;</span>    <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>这是可视化工具渲染图标时可能根据，instance和job的值进行渲染，为了能够让客户端的图标更具有可读性，可以通过label_replace标签为时间序列添加额外的标签。label_replace的具体参数如下：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label<span class="constructor">_replace(<span class="params">v</span> <span class="params">instant</span>-<span class="params">vector</span>, <span class="params">dst_label</span> <span class="params">string</span>, <span class="params">replacement</span> <span class="params">string</span>, <span class="params">src_label</span> <span class="params">string</span>, <span class="params">regex</span> <span class="params">string</span>)</span></span><br></pre></td></tr></table></figure>
<p>该函数会依次对v中的每一条时间序列进行处理，通过regex匹配src_label的值，并将匹配部分relacement写入到dst_label标签中。如下所示：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">label_replace</span><span class="params">(up, <span class="string">"host"</span>, <span class="string">"$1"</span>, <span class="string">"instance"</span>,  <span class="string">"(.*):.*"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>函数处理后，时间序列将包含一个host标签，host标签的值为Exporter实例的IP地址：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">up&#123;host="localhost",instance="localhost:8080",job="cadvisor"&#125;</span>    <span class="number">1</span></span><br><span class="line"><span class="string">up&#123;host="localhost",instance="localhost:9090",job="prometheus"&#125;</span>    <span class="number">1</span></span><br><span class="line"><span class="string">up&#123;host="localhost",instance="localhost:9100",job="node"&#125;</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>除了 <code>label_replace</code> 以外，Prometheus还提供了 <code>label_join</code> 函数，该函数可以将时间序列中v多个标签 <code>src_label</code> 的值，通过separator作为连接符写入到一个新的标签dst_label中:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label<span class="constructor">_join(<span class="params">v</span> <span class="params">instant</span>-<span class="params">vector</span>, <span class="params">dst_label</span> <span class="params">string</span>, <span class="params">separator</span> <span class="params">string</span>, <span class="params">src_label_1</span> <span class="params">string</span>, <span class="params">src_label_2</span> <span class="params">string</span>, <span class="operator">...</span>)</span></span><br></pre></td></tr></table></figure>
<p>label_replace和label_join函数提供了对时间序列标签的自定义能力，从而能够更好的于客户端或者可视化工具配合。</p>
<h4 id="其它内置函数"><a href="#其它内置函数" class="headerlink" title="其它内置函数"></a><strong>其它内置函数</strong></h4><p>除了上文介绍的这些内置函数以外，PromQL还提供了大量的其它内置函数。这些内置函数包括一些常用的数学计算、日期等等。这里就不一一细讲，感兴趣的读者可以通过阅读Prometheus的官方文档，了解这些函数的使用方式。</p>
<h3 id="API访问"><a href="#API访问" class="headerlink" title="API访问"></a>API访问</h3><p>Prometheus当前稳定的HTTP API可以通过 <code>/api/v1</code> 访问，根据瞬时数据查询和区间范围查询请求字段可分为：</p>
<ul>
<li><code>/api/v1/query</code></li>
<li><p><code>/api/v1/query_range</code></p>
<p>错误状态码：</p>
</li>
<li><p>404 Bad Request：当参数错误或者缺失时。</p>
</li>
<li>422 Unprocessable Entity 当表达式无法执行时。</li>
<li>503 Service Unavailiable 当请求超时或者被中断时。</li>
</ul>
<p>所有的API请求均使用以下的JSON格式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"status"</span>: <span class="string">"success"</span> | <span class="string">"error"</span>,</span><br><span class="line">  <span class="attr">"data"</span>: &lt;data&gt;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 为error时，有如下报错信息</span></span><br><span class="line">  <span class="attr">"errorType"</span>: <span class="string">"&lt;string&gt;"</span>,</span><br><span class="line">  <span class="attr">"error"</span>: <span class="string">"&lt;string&gt;"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="瞬时数据查询"><a href="#瞬时数据查询" class="headerlink" title="瞬时数据查询"></a>瞬时数据查询</h4><p>URL请求参数：</p>
<ul>
<li>query=：PromQL表达式。</li>
<li>time=：用于指定用于计算PromQL的时间戳。可选参数，默认情况下使用当前系统时间。</li>
<li>timeout=：超时设置。可选参数，默认情况下使用-query,timeout的全局设置。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">'http://localhost:9090/api/v1/query?query=up&amp;time=2015-07-01T20:10:51.781Z'</span></span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"status"</span> : <span class="string">"success"</span>,</span><br><span class="line">   <span class="attr">"data"</span> : &#123;</span><br><span class="line">      <span class="attr">"resultType"</span> : <span class="string">"vector"</span>,</span><br><span class="line">      <span class="attr">"result"</span> : [</span><br><span class="line">         &#123;</span><br><span class="line">            <span class="attr">"metric"</span> : &#123;</span><br><span class="line">               <span class="attr">"__name__"</span> : <span class="string">"up"</span>,</span><br><span class="line">               <span class="attr">"job"</span> : <span class="string">"prometheus"</span>,</span><br><span class="line">               <span class="attr">"instance"</span> : <span class="string">"localhost:9090"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"value"</span>: [ <span class="number">1435781451.781</span>, <span class="string">"1"</span> ]</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123;</span><br><span class="line">            <span class="attr">"metric"</span> : &#123;</span><br><span class="line">               <span class="attr">"__name__"</span> : <span class="string">"up"</span>,</span><br><span class="line">               <span class="attr">"job"</span> : <span class="string">"node"</span>,</span><br><span class="line">               <span class="attr">"instance"</span> : <span class="string">"localhost:9100"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"value"</span> : [ <span class="number">1435781451.781</span>, <span class="string">"0"</span> ]</span><br><span class="line">         &#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="区间范围查询"><a href="#区间范围查询" class="headerlink" title="区间范围查询"></a>区间范围查询</h4><p>URL请求参数：</p>
<ul>
<li>query=: PromQL表达式。</li>
<li>start=: 起始时间。</li>
<li>end=: 结束时间。</li>
<li>step=: 查询步长。</li>
<li>timeout=: 超时设置。可选参数，默认情况下使用-query,timeout的全局设置。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">'http://localhost:9090/api/v1/query_range?query=up&amp;start=2015-07-01T20:10:30.781Z&amp;end=2015-07-01T20:11:00.781Z&amp;step=15s'</span></span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"status"</span> : <span class="string">"success"</span>,</span><br><span class="line">   <span class="attr">"data"</span> : &#123;</span><br><span class="line">      <span class="attr">"resultType"</span> : <span class="string">"matrix"</span>,</span><br><span class="line">      <span class="attr">"result"</span> : [</span><br><span class="line">         &#123;</span><br><span class="line">            <span class="attr">"metric"</span> : &#123;</span><br><span class="line">               <span class="attr">"__name__"</span> : <span class="string">"up"</span>,</span><br><span class="line">               <span class="attr">"job"</span> : <span class="string">"prometheus"</span>,</span><br><span class="line">               <span class="attr">"instance"</span> : <span class="string">"localhost:9090"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"values"</span> : [</span><br><span class="line">               [ <span class="number">1435781430.781</span>, <span class="string">"1"</span> ],</span><br><span class="line">               [ <span class="number">1435781445.781</span>, <span class="string">"1"</span> ],</span><br><span class="line">               [ <span class="number">1435781460.781</span>, <span class="string">"1"</span> ]</span><br><span class="line">            ]</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123;</span><br><span class="line">            <span class="attr">"metric"</span> : &#123;</span><br><span class="line">               <span class="attr">"__name__"</span> : <span class="string">"up"</span>,</span><br><span class="line">               <span class="attr">"job"</span> : <span class="string">"node"</span>,</span><br><span class="line">               <span class="attr">"instance"</span> : <span class="string">"localhost:9091"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"values"</span> : [</span><br><span class="line">               [ <span class="number">1435781430.781</span>, <span class="string">"0"</span> ],</span><br><span class="line">               [ <span class="number">1435781445.781</span>, <span class="string">"0"</span> ],</span><br><span class="line">               [ <span class="number">1435781460.781</span>, <span class="string">"1"</span> ]</span><br><span class="line">            ]</span><br><span class="line">         &#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><p>与传统的监控系统需要向中心监控服务 Push 监控数据不同，Prometheus 基于 Pull 模型从 Target 拉取监控的数据。传统的 Push 模型中，每个监控 Target 需要知道中心监控服务的地址，然后才可以推送。而Prometheus不需要给每个监控 Target 配置Prometheus服务的地址，这种开放性极大地减少了监控 Target 对于监控系统的绑定。</p>
<p>然而，为了支持 Pull 模型，Prometheus 还是得知道每个监控 Target 的地址，这就是服务发现机制。在 Kubernetes 这种容器平台中，Kubernetes 掌管着所有容器与服务的信息，这时候 Prometheus 只需要和 Kubernetes 打交道即可。在其他的场景，也可以有 服务发现和注册中心 来扮演代理人的角色。Prometheus 集成了各种服务发现机制，可以动态配置想要抓取的 Target。</p>
<p><img alt="服务发现" data-src="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LVSqkQub5oDFvoLr1P2%2F-LVSr9O9L372kPUgr25X%2Fprometheus-sd.png?alt=media"></p>
<p><code>scrape_config</code> 部分指定了一系列需要抓取的 <code>Target</code> 和参数，一般来说，一个scrape配置指定了一个Job，这部分多个<code>scrape_config</code> 以一个列表的形式呈现。Target可以通过 <code>static_configs</code> 来静态配置，也可以通过Prometheus支持的各种服务发现机制来动态配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The job name assigned to scraped metrics by default.</span></span><br><span class="line"><span class="attr">job_name:</span> <span class="string">&lt;job_name&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># How frequently to scrape targets from this job.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">scrape_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">&lt;global_config.scrape_interval&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Per-scrape timeout when scraping this job.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">scrape_timeout:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">&lt;global_config.scrape_timeout&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The HTTP resource path on which to fetch metrics from targets.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">metrics_path:</span> <span class="string">&lt;path&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">/metrics</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># honor_labels controls how Prometheus handles conflicts between labels that are</span></span><br><span class="line"><span class="comment"># already present in scraped data and labels that Prometheus would attach</span></span><br><span class="line"><span class="comment"># server-side ("job" and "instance" labels, manually configured target</span></span><br><span class="line"><span class="comment"># labels, and labels generated by service discovery implementations).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If honor_labels is set to "true", label conflicts are resolved by keeping label</span></span><br><span class="line"><span class="comment"># values from the scraped data and ignoring the conflicting server-side labels.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If honor_labels is set to "false", label conflicts are resolved by renaming</span></span><br><span class="line"><span class="comment"># conflicting labels in the scraped data to "exported_&lt;original-label&gt;" (for</span></span><br><span class="line"><span class="comment"># example "exported_instance", "exported_job") and then attaching server-side</span></span><br><span class="line"><span class="comment"># labels.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Setting honor_labels to "true" is useful for use cases such as federation and</span></span><br><span class="line"><span class="comment"># scraping the Pushgateway, where all labels specified in the target should be</span></span><br><span class="line"><span class="comment"># preserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that any globally configured "external_labels" are unaffected by this</span></span><br><span class="line"><span class="comment"># setting. In communication with external systems, they are always applied only</span></span><br><span class="line"><span class="comment"># when a time series does not have a given label yet and are ignored otherwise.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">honor_labels:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># honor_timestamps controls whether Prometheus respects the timestamps present</span></span><br><span class="line"><span class="comment"># in scraped data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If honor_timestamps is set to "true", the timestamps of the metrics exposed</span></span><br><span class="line"><span class="comment"># by the target will be used.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If honor_timestamps is set to "false", the timestamps of the metrics exposed</span></span><br><span class="line"><span class="comment"># by the target will be ignored.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">honor_timestamps:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">true</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configures the protocol scheme used for requests.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">scheme:</span> <span class="string">&lt;scheme&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">http</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional HTTP URL parameters.</span></span><br><span class="line"><span class="attr">params:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;string&gt;:</span> <span class="string">[&lt;string&gt;,</span> <span class="string">...]</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sets the `Authorization` header on every scrape request with the</span></span><br><span class="line"><span class="comment"># configured username and password.</span></span><br><span class="line"><span class="comment"># password and password_file are mutually exclusive.</span></span><br><span class="line"><span class="attr">basic_auth:</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">username:</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">password:</span> <span class="string">&lt;secret&gt;</span> <span class="string">]</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">password_file:</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sets the `Authorization` header on every scrape request with</span></span><br><span class="line"><span class="comment"># the configured bearer token. It is mutually exclusive with `bearer_token_file`.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">bearer_token:</span> <span class="string">&lt;secret&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sets the `Authorization` header on every scrape request with the bearer token</span></span><br><span class="line"><span class="comment"># read from the configured file. It is mutually exclusive with `bearer_token`.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">bearer_token_file:</span> <span class="string">&lt;filename&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configures the scrape request's TLS settings.</span></span><br><span class="line"><span class="attr">tls_config:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;tls_config&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional proxy URL.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">proxy_url:</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Azure service discovery configurations.</span></span><br><span class="line"><span class="attr">azure_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;azure_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Consul service discovery configurations.</span></span><br><span class="line"><span class="attr">consul_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;consul_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of DigitalOcean service discovery configurations.</span></span><br><span class="line"><span class="attr">digitalocean_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;digitalocean_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Docker Swarm service discovery configurations.</span></span><br><span class="line"><span class="attr">dockerswarm_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;dockerswarm_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of DNS service discovery configurations.</span></span><br><span class="line"><span class="attr">dns_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;dns_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of EC2 service discovery configurations.</span></span><br><span class="line"><span class="attr">ec2_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;ec2_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Eureka service discovery configurations.</span></span><br><span class="line"><span class="attr">eureka_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;eureka_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of file service discovery configurations.</span></span><br><span class="line"><span class="attr">file_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;file_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of GCE service discovery configurations.</span></span><br><span class="line"><span class="attr">gce_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;gce_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Hetzner service discovery configurations.</span></span><br><span class="line"><span class="attr">hetzner_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;hetzner_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Kubernetes service discovery configurations.</span></span><br><span class="line"><span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;kubernetes_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Marathon service discovery configurations.</span></span><br><span class="line"><span class="attr">marathon_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;marathon_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of AirBnB's Nerve service discovery configurations.</span></span><br><span class="line"><span class="attr">nerve_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;nerve_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of OpenStack service discovery configurations.</span></span><br><span class="line"><span class="attr">openstack_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;openstack_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Zookeeper Serverset service discovery configurations.</span></span><br><span class="line"><span class="attr">serverset_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;serverset_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of Triton service discovery configurations.</span></span><br><span class="line"><span class="attr">triton_sd_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;triton_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of labeled statically configured targets for this job.</span></span><br><span class="line"><span class="attr">static_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;static_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of target relabel configurations.</span></span><br><span class="line"><span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;relabel_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of metric relabel configurations.</span></span><br><span class="line"><span class="attr">metric_relabel_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;relabel_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Per-scrape limit on number of scraped samples that will be accepted.</span></span><br><span class="line"><span class="comment"># If more than this number of samples are present after metric relabeling</span></span><br><span class="line"><span class="comment"># the entire scrape will be treated as failed. 0 means no limit.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">sample_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Per-scrape config limit on number of unique targets that will be</span></span><br><span class="line"><span class="comment"># accepted. If more than this number of targets are present after target</span></span><br><span class="line"><span class="comment"># relabeling, Prometheus will mark the targets as failed without scraping them.</span></span><br><span class="line"><span class="comment"># 0 means no limit. This is an experimental feature, this behaviour could</span></span><br><span class="line"><span class="comment"># change in the future.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">target_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<h3 id="基于k8s的服务发现"><a href="#基于k8s的服务发现" class="headerlink" title="基于k8s的服务发现"></a>基于k8s的服务发现</h3><p><code>Kubernetes SD configurations</code> 允许从 Kubernetes 的 REST API 来动态发现需要监控的 target 信息，并且保持与集群状态同步。</p>
<p>下面是 <code>kubernetes_sd_config</code> 的配置模板，在 <a href="https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml" target="_blank" rel="external nofollow noopener noreferrer">这里</a> 可以看到 Prometheus 给出的示例。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The information to access the Kubernetes API.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The API server addresses. If left empty, Prometheus is assumed to run inside</span></span><br><span class="line"><span class="comment"># of the cluster and will discover API servers automatically and use the pod's</span></span><br><span class="line"><span class="comment"># CA certificate and bearer token file at /var/run/secrets/kubernetes.io/serviceaccount/.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">api_server:</span> <span class="string">&lt;host&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The Kubernetes role of entities that should be discovered.</span></span><br><span class="line"><span class="comment"># One of endpoints, service, pod, node, or ingress.</span></span><br><span class="line"><span class="attr">role:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional authentication information used to authenticate to the API server.</span></span><br><span class="line"><span class="comment"># Note that `basic_auth`, `bearer_token` and `bearer_token_file` options are</span></span><br><span class="line"><span class="comment"># mutually exclusive.</span></span><br><span class="line"><span class="comment"># password and password_file are mutually exclusive.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional HTTP basic authentication information.</span></span><br><span class="line"><span class="attr">basic_auth:</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">username:</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">password:</span> <span class="string">&lt;secret&gt;</span> <span class="string">]</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">password_file:</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional bearer token authentication information.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">bearer_token:</span> <span class="string">&lt;secret&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional bearer token file authentication information.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">bearer_token_file:</span> <span class="string">&lt;filename&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional proxy URL.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">proxy_url:</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TLS configuration.</span></span><br><span class="line"><span class="attr">tls_config:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;tls_config&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional namespace discovery. If omitted, all namespaces are used.</span></span><br><span class="line"><span class="attr">namespaces:</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional label and field selectors to limit the discovery process to a subset of available resources. </span></span><br><span class="line"><span class="comment"># See https://kubernetes.io/docs/concepts/overview/working-with-objects/field-selectors/</span></span><br><span class="line"><span class="comment"># and https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/ to learn more about the possible </span></span><br><span class="line"><span class="comment"># filters that can be used. Endpoints role supports pod, service and endpoints selectors, other roles</span></span><br><span class="line"><span class="comment"># only support selectors matching the role itself (e.g. node role can only contain node selectors).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">Note:</span> When making decision about using field/label selector make sure that this </span></span><br><span class="line"><span class="comment"># is the best approach - it will prevent Prometheus from reusing single list/watch</span></span><br><span class="line"><span class="comment"># for all scrape configs. This might result in a bigger load on the Kubernetes API,</span></span><br><span class="line"><span class="comment"># because per each selector combination there will be additional LIST/WATCH. On the other hand,</span></span><br><span class="line"><span class="comment"># if you just want to monitor small subset of pods in large cluster it's recommended to use selectors.</span></span><br><span class="line"><span class="comment"># Decision, if selectors should be used or not depends on the particular situation.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">selectors:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="string">[</span> <span class="attr">label:</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span></span><br><span class="line">    <span class="string">[</span> <span class="attr">field:</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span> <span class="string">]]</span></span><br></pre></td></tr></table></figure>
<p>Role 的类型可以被配置为以下几种：</p>
<ul>
<li>node</li>
<li>pod</li>
<li>service</li>
<li>Ingress</li>
<li>endpoint</li>
</ul>
<h4 id="node"><a href="#node" class="headerlink" title="node"></a>node</h4><p>Prometheus 会自动将获取到 Node 的信息作为 <code>meta labels</code> 写到 Target 数据中：</p>
<p><img alt="实例的Metadata信息" data-src="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LPui3iWsSYuoIaPTZtS%2F-LPui6XS6SgDzCvoGrMw%2Fprometheus_file_target_metadata.png"></p>
<p>Node 可用的 <code>meta labels</code> 有： </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">__meta_kubernetes_node_name:</span> <span class="string">The</span> <span class="string">name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">node</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_node_label_&lt;labelname&gt;:</span> <span class="string">Each</span> <span class="string">label</span> <span class="string">from</span> <span class="string">the</span> <span class="string">node</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_node_labelpresent_&lt;labelname&gt;:</span> <span class="literal">true</span> <span class="string">for</span> <span class="string">each</span> <span class="string">label</span> <span class="string">from</span> <span class="string">the</span> <span class="string">node</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_node_annotation_&lt;annotationname&gt;:</span> <span class="string">Each</span> <span class="string">annotation</span> <span class="string">from</span> <span class="string">the</span> <span class="string">node</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_node_annotationpresent_&lt;annotationname&gt;:</span> <span class="literal">true</span> <span class="string">for</span> <span class="string">each</span> <span class="string">annotation</span> <span class="string">from</span> <span class="string">the</span> <span class="string">node</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_node_address_&lt;address_type&gt;:</span> <span class="string">The</span> <span class="string">first</span> <span class="string">address</span> <span class="string">for</span> <span class="string">each</span> <span class="string">node</span> <span class="string">address</span> <span class="string">type,</span> <span class="string">if</span> <span class="string">it</span> <span class="string">exists.</span></span><br></pre></td></tr></table></figure>
<p>下面是配置示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="comment"># Scrape config for nodes (kubelet).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Rather than connecting directly to the node, the scrape is proxied though the</span></span><br><span class="line"><span class="comment"># Kubernetes apiserver.  This means it will work if Prometheus is running out of</span></span><br><span class="line"><span class="comment"># cluster, or can't connect to nodes for some other reason (e.g. because of</span></span><br><span class="line"><span class="comment"># firewalling).</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-nodes'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Default to scraping over https. If required, just disable this or change to</span></span><br><span class="line">  <span class="comment"># `http`.</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># This TLS &amp; bearer token file config is used to connect to the actual scrape</span></span><br><span class="line">  <span class="comment"># endpoints for cluster components. This is separate to discovery auth</span></span><br><span class="line">  <span class="comment"># configuration because discovery &amp; scraping are two separate concerns in</span></span><br><span class="line">  <span class="comment"># Prometheus. The discovery auth config is automatic if Prometheus runs inside</span></span><br><span class="line">  <span class="comment"># the cluster. Otherwise, more config options have to be provided within the</span></span><br><span class="line">  <span class="comment"># &lt;kubernetes_sd_config&gt;.</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">    <span class="comment"># If your node certificates are self-signed or use a different CA to the</span></span><br><span class="line">    <span class="comment"># master CA, then disable certificate verification below. Note that</span></span><br><span class="line">    <span class="comment"># certificate verification is an integral part of a secure infrastructure</span></span><br><span class="line">    <span class="comment"># so this should only be disabled in a controlled environment. You can</span></span><br><span class="line">    <span class="comment"># disable certificate verification by uncommenting the line below.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># insecure_skip_verify: true</span></span><br><span class="line">  <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br></pre></td></tr></table></figure>
<p>cAdvisor</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="comment"># Scrape config for Kubelet cAdvisor.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This is required for Kubernetes 1.7.3 and later, where cAdvisor metrics</span></span><br><span class="line"><span class="comment"># (those whose names begin with 'container_') have been removed from the</span></span><br><span class="line"><span class="comment"># Kubelet metrics endpoint.  This job scrapes the cAdvisor endpoint to</span></span><br><span class="line"><span class="comment"># retrieve those metrics.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In Kubernetes 1.7.0-1.7.2, these metrics are only exposed on the cAdvisor</span></span><br><span class="line"><span class="comment"># HTTP endpoint; use the "/metrics" endpoint on the 4194 port of nodes. In</span></span><br><span class="line"><span class="comment"># that case (and ensure cAdvisor's HTTP server hasn't been disabled with the</span></span><br><span class="line"><span class="comment"># --cadvisor-port=0 Kubelet flag).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This job is not necessary and should be removed in Kubernetes 1.6 and</span></span><br><span class="line"><span class="comment"># earlier versions, or it will cause the metrics to be scraped twice.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-cadvisor'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Default to scraping over https. If required, just disable this or change to</span></span><br><span class="line">  <span class="comment"># `http`.</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Starting Kubernetes 1.7.3 the cAdvisor metrics are under /metrics/cadvisor.</span></span><br><span class="line">  <span class="comment"># Kubernetes CIS Benchmark recommends against enabling the insecure HTTP</span></span><br><span class="line">  <span class="comment"># servers of Kubernetes, therefore the cAdvisor metrics on the secure handler</span></span><br><span class="line">  <span class="comment"># are used.</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/metrics/cadvisor</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># This TLS &amp; bearer token file config is used to connect to the actual scrape</span></span><br><span class="line">  <span class="comment"># endpoints for cluster components. This is separate to discovery auth</span></span><br><span class="line">  <span class="comment"># configuration because discovery &amp; scraping are two separate concerns in</span></span><br><span class="line">  <span class="comment"># Prometheus. The discovery auth config is automatic if Prometheus runs inside</span></span><br><span class="line">  <span class="comment"># the cluster. Otherwise, more config options have to be provided within the</span></span><br><span class="line">  <span class="comment"># &lt;kubernetes_sd_config&gt;.</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">    <span class="comment"># If your node certificates are self-signed or use a different CA to the</span></span><br><span class="line">    <span class="comment"># master CA, then disable certificate verification below. Note that</span></span><br><span class="line">    <span class="comment"># certificate verification is an integral part of a secure infrastructure</span></span><br><span class="line">    <span class="comment"># so this should only be disabled in a controlled environment. You can</span></span><br><span class="line">    <span class="comment"># disable certificate verification by uncommenting the line below.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># insecure_skip_verify: true</span></span><br><span class="line">  <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br></pre></td></tr></table></figure>
<h4 id="service"><a href="#service" class="headerlink" title="service"></a>service</h4><p>可用的 <code>meata label</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">__meta_kubernetes_namespace:</span> <span class="string">The</span> <span class="string">namespace</span> <span class="string">of</span> <span class="string">the</span> <span class="string">service</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_service_annotation_&lt;annotationname&gt;:</span> <span class="string">Each</span> <span class="string">annotation</span> <span class="string">from</span> <span class="string">the</span> <span class="string">service</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_service_annotationpresent_&lt;annotationname&gt;:</span> <span class="string">"true"</span> <span class="string">for</span> <span class="string">each</span> <span class="string">annotation</span> <span class="string">of</span> <span class="string">the</span> <span class="string">service</span> <span class="string">object.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_service_cluster_ip:</span> <span class="string">The</span> <span class="string">cluster</span> <span class="string">IP</span> <span class="string">address</span> <span class="string">of</span> <span class="string">the</span> <span class="string">service.</span> <span class="string">(Does</span> <span class="string">not</span> <span class="string">apply</span> <span class="string">to</span> <span class="string">services</span> <span class="string">of</span> <span class="string">type</span> <span class="string">ExternalName)</span></span><br><span class="line"><span class="attr">__meta_kubernetes_service_external_name:</span> <span class="string">The</span> <span class="string">DNS</span> <span class="string">name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">service.</span> <span class="string">(Applies</span> <span class="string">to</span> <span class="string">services</span> <span class="string">of</span> <span class="string">type</span> <span class="string">ExternalName)</span></span><br><span class="line"><span class="string">__meta_kubernetes_service_label_&lt;labelname&gt;:</span> <span class="string">Each</span> <span class="string">label</span> <span class="string">from</span> <span class="string">the</span> <span class="string">service</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_service_labelpresent_&lt;labelname&gt;:</span> <span class="literal">true</span> <span class="string">for</span> <span class="string">each</span> <span class="string">label</span> <span class="string">of</span> <span class="string">the</span> <span class="string">service</span> <span class="string">object.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_service_name:</span> <span class="string">The</span> <span class="string">name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">service</span> <span class="string">object.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_service_port_name:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">service</span> <span class="string">port</span> <span class="string">for</span> <span class="string">the</span> <span class="string">target.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_service_port_protocol:</span> <span class="string">Protocol</span> <span class="string">of</span> <span class="string">the</span> <span class="string">service</span> <span class="string">port</span> <span class="string">for</span> <span class="string">the</span> <span class="string">target.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_service_type:</span> <span class="string">The</span> <span class="string">type</span> <span class="string">of</span> <span class="string">the</span> <span class="string">service.</span></span><br></pre></td></tr></table></figure>
<p>配置示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-service-endpoints'</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="comment"># Example relabel to scrape only endpoints that have</span></span><br><span class="line">  <span class="comment"># "example.io/should_be_scraped = true" annotation.</span></span><br><span class="line">  <span class="comment">#  - source_labels: [__meta_kubernetes_service_annotation_example_io_should_be_scraped]</span></span><br><span class="line">  <span class="comment">#    action: keep</span></span><br><span class="line">  <span class="comment">#    regex: true</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Example relabel to customize metric path based on endpoints</span></span><br><span class="line">  <span class="comment"># "example.io/metric_path = &lt;metric path&gt;" annotation.</span></span><br><span class="line">  <span class="comment">#  - source_labels: [__meta_kubernetes_service_annotation_example_io_metric_path]</span></span><br><span class="line">  <span class="comment">#    action: replace</span></span><br><span class="line">  <span class="comment">#    target_label: __metrics_path__</span></span><br><span class="line">  <span class="comment">#    regex: (.+)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Example relabel to scrape only single, desired port for the service based</span></span><br><span class="line">  <span class="comment"># on endpoints "example.io/scrape_port = &lt;port&gt;" annotation.</span></span><br><span class="line">  <span class="comment">#  - source_labels: [__address__, __meta_kubernetes_service_annotation_example_io_scrape_port]</span></span><br><span class="line">  <span class="comment">#    action: replace</span></span><br><span class="line">  <span class="comment">#    regex: ([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">  <span class="comment">#    replacement: $1:$2</span></span><br><span class="line">  <span class="comment">#    target_label: __address__</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Example relabel to configure scrape scheme for all service scrape targets</span></span><br><span class="line">  <span class="comment"># based on endpoints "example.io/scrape_scheme = &lt;scheme&gt;" annotation.</span></span><br><span class="line">  <span class="comment">#  - source_labels: [__meta_kubernetes_service_annotation_example_io_scrape_scheme]</span></span><br><span class="line">  <span class="comment">#    action: replace</span></span><br><span class="line">  <span class="comment">#    target_label: __scheme__</span></span><br><span class="line">  <span class="comment">#    regex: (https?)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_namespace]</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_service_name]</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-services'</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> <span class="string">[http_2xx]</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">service</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="comment"># Example relabel to probe only some services that have "example.io/should_be_probed = true" annotation</span></span><br><span class="line">  <span class="comment">#  - source_labels: [__meta_kubernetes_service_annotation_example_io_should_be_probed]</span></span><br><span class="line">  <span class="comment">#    action: keep</span></span><br><span class="line">  <span class="comment">#    regex: true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__address__]</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">blackbox-exporter.example.com:9115</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__param_target]</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_namespace]</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_service_name]</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br></pre></td></tr></table></figure>
<h4 id="pod"><a href="#pod" class="headerlink" title="pod"></a>pod</h4><p>可用的 <code>mata labels</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">__meta_kubernetes_namespace:</span> <span class="string">The</span> <span class="string">namespace</span> <span class="string">of</span> <span class="string">the</span> <span class="string">pod</span> <span class="string">object.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_name:</span> <span class="string">The</span> <span class="string">name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">pod</span> <span class="string">object.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_ip:</span> <span class="string">The</span> <span class="string">pod</span> <span class="string">IP</span> <span class="string">of</span> <span class="string">the</span> <span class="string">pod</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_pod_label_&lt;labelname&gt;:</span> <span class="string">Each</span> <span class="string">label</span> <span class="string">from</span> <span class="string">the</span> <span class="string">pod</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_pod_labelpresent_&lt;labelname&gt;:</span> <span class="string">truefor</span> <span class="string">each</span> <span class="string">label</span> <span class="string">from</span> <span class="string">the</span> <span class="string">pod</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_pod_annotation_&lt;annotationname&gt;:</span> <span class="string">Each</span> <span class="string">annotation</span> <span class="string">from</span> <span class="string">the</span> <span class="string">pod</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_pod_annotationpresent_&lt;annotationname&gt;:</span> <span class="literal">true</span> <span class="string">for</span> <span class="string">each</span> <span class="string">annotation</span> <span class="string">from</span> <span class="string">the</span> <span class="string">pod</span> <span class="string">object.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_container_init:</span> <span class="literal">true</span> <span class="string">if</span> <span class="string">the</span> <span class="string">container</span> <span class="string">is</span> <span class="string">an</span> <span class="string">InitContainer</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_container_name:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">container</span> <span class="string">the</span> <span class="string">target</span> <span class="string">address</span> <span class="string">points</span> <span class="string">to.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_container_port_name:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">container</span> <span class="string">port.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_container_port_number:</span> <span class="string">Number</span> <span class="string">of</span> <span class="string">the</span> <span class="string">container</span> <span class="string">port.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_container_port_protocol:</span> <span class="string">Protocol</span> <span class="string">of</span> <span class="string">the</span> <span class="string">container</span> <span class="string">port.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_ready:</span> <span class="string">Set</span> <span class="string">to</span> <span class="literal">true</span> <span class="string">or</span> <span class="literal">false</span> <span class="string">for</span> <span class="string">the</span> <span class="string">pod's</span> <span class="string">ready</span> <span class="string">state.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_phase:</span> <span class="string">Set</span> <span class="string">to</span> <span class="string">Pending,</span> <span class="string">Running,</span> <span class="string">Succeeded,</span> <span class="string">Failed</span> <span class="string">or</span> <span class="string">Unknown</span> <span class="string">in</span> <span class="string">the</span> <span class="string">lifecycle.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_node_name:</span> <span class="string">The</span> <span class="string">name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">node</span> <span class="string">the</span> <span class="string">pod</span> <span class="string">is</span> <span class="string">scheduled</span> <span class="string">onto.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_host_ip:</span> <span class="string">The</span> <span class="string">current</span> <span class="string">host</span> <span class="string">IP</span> <span class="string">of</span> <span class="string">the</span> <span class="string">pod</span> <span class="string">object.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_uid:</span> <span class="string">The</span> <span class="string">UID</span> <span class="string">of</span> <span class="string">the</span> <span class="string">pod</span> <span class="string">object.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_controller_kind:</span> <span class="string">Object</span> <span class="string">kind</span> <span class="string">of</span> <span class="string">the</span> <span class="string">pod</span> <span class="string">controller.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_pod_controller_name:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">pod</span> <span class="string">controller.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="comment"># Example scrape config for pods</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The relabeling allows the actual pod scrape to be configured</span></span><br><span class="line"><span class="comment"># for all the declared ports (or port-free target if none is declared)</span></span><br><span class="line"><span class="comment"># or only some ports.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-pods'</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="comment"># Example relabel to scrape only pods that have</span></span><br><span class="line">  <span class="comment"># "example.io/should_be_scraped = true" annotation.</span></span><br><span class="line">  <span class="comment">#  - source_labels: [__meta_kubernetes_pod_annotation_example_io_should_be_scraped]</span></span><br><span class="line">  <span class="comment">#    action: keep</span></span><br><span class="line">  <span class="comment">#    regex: true</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Example relabel to customize metric path based on pod</span></span><br><span class="line">  <span class="comment"># "example.io/metric_path = &lt;metric path&gt;" annotation.</span></span><br><span class="line">  <span class="comment">#  - source_labels: [__meta_kubernetes_pod_annotation_example_io_metric_path]</span></span><br><span class="line">  <span class="comment">#    action: replace</span></span><br><span class="line">  <span class="comment">#    target_label: __metrics_path__</span></span><br><span class="line">  <span class="comment">#    regex: (.+)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Example relabel to scrape only single, desired port for the pod</span></span><br><span class="line">  <span class="comment"># based on pod "example.io/scrape_port = &lt;port&gt;" annotation.</span></span><br><span class="line">  <span class="comment">#  - source_labels: [__address__, __meta_kubernetes_pod_annotation_example_io_scrape_port]</span></span><br><span class="line">  <span class="comment">#    action: replace</span></span><br><span class="line">  <span class="comment">#    regex: ([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">  <span class="comment">#    replacement: $1:$2</span></span><br><span class="line">  <span class="comment">#    target_label: __address__</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_namespace]</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_pod_name]</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span></span><br></pre></td></tr></table></figure>
<p>可以通过 <code>selectors</code> 来对 pod 进行选择，比如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-pods'</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">      <span class="attr">namespaces:</span></span><br><span class="line">        <span class="attr">names:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">selectors:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">          <span class="attr">label:</span> <span class="string">"app:abc-123"</span></span><br></pre></td></tr></table></figure>
<h4 id="endpoints"><a href="#endpoints" class="headerlink" title="endpoints"></a>endpoints</h4><p>可用的 <code>meta label</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">__meta_kubernetes_namespace:</span> <span class="string">The</span> <span class="string">namespace</span> <span class="string">of</span> <span class="string">the</span> <span class="string">endpoints</span> <span class="string">object.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">__meta_kubernetes_endpoints_name:</span> <span class="string">The</span> <span class="string">names</span> <span class="string">of</span> <span class="string">the</span> <span class="string">endpoints</span> <span class="string">object.</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">For</span> <span class="string">all</span> <span class="string">targets</span> <span class="string">discovered</span> <span class="string">directly</span> <span class="string">from</span> <span class="string">the</span> <span class="string">endpoints</span> <span class="string">list</span> <span class="string">(those</span> <span class="string">not</span> <span class="string">additionally</span> <span class="string">inferred</span> <span class="string">from</span> <span class="string">underlying</span> <span class="string">pods),</span> <span class="attr">the following labels are attached:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">__meta_kubernetes_endpoint_hostname:</span> <span class="string">Hostname</span> <span class="string">of</span> <span class="string">the</span> <span class="string">endpoint.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">__meta_kubernetes_endpoint_node_name:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">node</span> <span class="string">hosting</span> <span class="string">the</span> <span class="string">endpoint.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">__meta_kubernetes_endpoint_ready:</span> <span class="string">Set</span> <span class="string">to</span> <span class="literal">true</span> <span class="string">or</span> <span class="literal">false</span> <span class="string">for</span> <span class="string">the</span> <span class="string">endpoint's</span> <span class="string">ready</span> <span class="string">state.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">__meta_kubernetes_endpoint_port_name:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">endpoint</span> <span class="string">port.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">__meta_kubernetes_endpoint_port_protocol:</span> <span class="string">Protocol</span> <span class="string">of</span> <span class="string">the</span> <span class="string">endpoint</span> <span class="string">port.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">__meta_kubernetes_endpoint_address_target_kind:</span> <span class="string">Kind</span> <span class="string">of</span> <span class="string">the</span> <span class="string">endpoint</span> <span class="string">address</span> <span class="string">target.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">__meta_kubernetes_endpoint_address_target_name:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">endpoint</span> <span class="string">address</span> <span class="string">target.</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">If</span> <span class="string">the</span> <span class="string">endpoints</span> <span class="string">belong</span> <span class="string">to</span> <span class="string">a</span> <span class="string">service,</span> <span class="attr">all labels of the role:</span> <span class="string">service</span> <span class="string">discovery</span> <span class="string">are</span> <span class="string">attached.</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">For</span> <span class="string">all</span> <span class="string">targets</span> <span class="string">backed</span> <span class="string">by</span> <span class="string">a</span> <span class="string">pod,</span> <span class="attr">all labels of the role:</span> <span class="string">pod</span> <span class="string">discovery</span> <span class="string">are</span> <span class="string">attached.</span></span><br></pre></td></tr></table></figure>
<p>配置示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-apiservers'</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Default to scraping over https. If required, just disable this or change to</span></span><br><span class="line">  <span class="comment"># `http`.</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># This TLS &amp; bearer token file config is used to connect to the actual scrape</span></span><br><span class="line">  <span class="comment"># endpoints for cluster components. This is separate to discovery auth</span></span><br><span class="line">  <span class="comment"># configuration because discovery &amp; scraping are two separate concerns in</span></span><br><span class="line">  <span class="comment"># Prometheus. The discovery auth config is automatic if Prometheus runs inside</span></span><br><span class="line">  <span class="comment"># the cluster. Otherwise, more config options have to be provided within the</span></span><br><span class="line">  <span class="comment"># &lt;kubernetes_sd_config&gt;.</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">    <span class="comment"># If your node certificates are self-signed or use a different CA to the</span></span><br><span class="line">    <span class="comment"># master CA, then disable certificate verification below. Note that</span></span><br><span class="line">    <span class="comment"># certificate verification is an integral part of a secure infrastructure</span></span><br><span class="line">    <span class="comment"># so this should only be disabled in a controlled environment. You can</span></span><br><span class="line">    <span class="comment"># disable certificate verification by uncommenting the line below.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># insecure_skip_verify: true</span></span><br><span class="line">  <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Keep only the default/kubernetes service endpoints for the https port. This</span></span><br><span class="line">  <span class="comment"># will add targets for each API server which Kubernetes adds an endpoint to</span></span><br><span class="line">  <span class="comment"># the default/kubernetes service.</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_namespace,</span> <span class="string">__meta_kubernetes_service_name,</span> <span class="string">__meta_kubernetes_endpoint_port_name]</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">default;kubernetes;https</span></span><br></pre></td></tr></table></figure>
<h4 id="ingress"><a href="#ingress" class="headerlink" title="ingress"></a>ingress</h4><p>可用的 <code>mata label</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">__meta_kubernetes_namespace:</span> <span class="string">The</span> <span class="string">namespace</span> <span class="string">of</span> <span class="string">the</span> <span class="string">ingress</span> <span class="string">object.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_ingress_name:</span> <span class="string">The</span> <span class="string">name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">ingress</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_ingress_label_&lt;labelname&gt;:</span> <span class="string">Each</span> <span class="string">label</span> <span class="string">from</span> <span class="string">the</span> <span class="string">ingress</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_ingress_labelpresent_&lt;labelname&gt;:</span> <span class="literal">true</span> <span class="string">for</span> <span class="string">each</span> <span class="string">label</span> <span class="string">from</span> <span class="string">the</span> <span class="string">ingress</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_ingress_annotation_&lt;annotationname&gt;:</span> <span class="string">Each</span> <span class="string">annotation</span> <span class="string">from</span> <span class="string">the</span> <span class="string">ingress</span> <span class="string">object.</span></span><br><span class="line"><span class="string">__meta_kubernetes_ingress_annotationpresent_&lt;annotationname&gt;:</span> <span class="literal">true</span> <span class="string">for</span> <span class="string">each</span> <span class="string">annotation</span> <span class="string">from</span> <span class="string">the</span> <span class="string">ingress</span> <span class="string">object.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_ingress_scheme:</span> <span class="string">Protocol</span> <span class="string">scheme</span> <span class="string">of</span> <span class="string">ingress,</span> <span class="string">https</span> <span class="string">if</span> <span class="string">TLS</span> <span class="string">config</span> <span class="string">is</span> <span class="string">set.</span> <span class="string">Defaults</span> <span class="string">to</span> <span class="string">http.</span></span><br><span class="line"><span class="attr">__meta_kubernetes_ingress_path:</span> <span class="string">Path</span> <span class="string">from</span> <span class="string">ingress</span> <span class="string">spec.</span> <span class="string">Defaults</span> <span class="string">to</span> <span class="string">/.</span></span><br></pre></td></tr></table></figure>
<p>配置示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-ingresses'</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> <span class="string">[http_2xx]</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">ingress</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="comment"># Example relabel to probe only some ingresses that have "example.io/should_be_probed = true" annotation</span></span><br><span class="line">  <span class="comment">#  - source_labels: [__meta_kubernetes_ingress_annotation_example_io_should_be_probed]</span></span><br><span class="line">  <span class="comment">#    action: keep</span></span><br><span class="line">  <span class="comment">#    regex: true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.+);(.+);(.+)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$&#123;1&#125;://$&#123;2&#125;$&#123;3&#125;</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">blackbox-exporter.example.com:9115</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__param_target]</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_ingress_label_(.+)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_namespace]</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_ingress_name]</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br></pre></td></tr></table></figure>
<h3 id="Relabeling-机制"><a href="#Relabeling-机制" class="headerlink" title="Relabeling 机制"></a>Relabeling 机制</h3><p><code>Relabeling</code> 是一个可以在数据被抓取之前动态重写 target 里面 label 的强大工具。这种发生在采集样本数据之前，对Target实例的标签进行重写的机制在Prometheus被称为Relabeling，具体是通过配置  <code>relabel_configs</code> 来实现：</p>
<p><img alt="Relabeling作用时机" data-src="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LVSsqoyc3erej7bf3vS%2F-LPui6XUJUk0y4kPPia0%2Fwhen-relabel-work.png"></p>
<p>Relabeling最基本的应用场景就是基于Target实例中包含的metadata标签，动态的添加或者覆盖标签。例如，通过Consul动态发现的服务实例还会包含以下Metadata标签信息：</p>
<ul>
<li>__meta_consul_address：consul地址</li>
<li>__meta_consul_dc：consul中服务所在的数据中心</li>
<li>__meta_consulmetadata：服务的metadata</li>
<li>__meta_consul_node：服务所在consul节点的信息</li>
<li>__meta_consul_service_address：服务访问地址</li>
<li>__meta_consul_service_id：服务ID</li>
<li>__meta_consul_service_port：服务端口</li>
<li>__meta_consul_service：服务名称</li>
<li>__meta_consul_tags：服务包含的标签信息</li>
</ul>
<p>在默认情况下，从Node Exporter实例采集上来的样本数据如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">node_cpu&#123;cpu="cpu0",instance="localhost:9100",job="node",mode="idle"&#125;</span> <span class="number">93970.8203125</span></span><br></pre></td></tr></table></figure>
<p>我们希望能有一个额外的标签dc可以表示该样本所属的数据中心：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">node_cpu&#123;cpu="cpu0",instance="localhost:9100",job="node",mode="idle",</span> <span class="string">dc="dc1"&#125;</span> <span class="number">93970.8203125</span></span><br></pre></td></tr></table></figure>
<p>在每一个采集任务的配置中可以添加多个relabel_config配置，一个最简单的relabel配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">node_exporter</span></span><br><span class="line">    <span class="attr">consul_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">localhost:8500</span></span><br><span class="line">        <span class="attr">services:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">node_exporter</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span>  <span class="string">["__meta_consul_dc"]</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">"dc"</span></span><br></pre></td></tr></table></figure>
<p>该采集任务通过Consul动态发现Node Exporter实例信息作为监控采集目标。我们知道通过Consul动态发现的监控Target都会包含一些额外的Metadata标签，比如标签 <code>__meta_consul_dc</code> 表明了当前实例所在的Consul数据中心，因此我们希望从这些实例中采集到的监控样本中也可以包含这样一个标签，例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">node_cpu&#123;cpu="cpu0",dc="dc1",instance="172.21.0.6:9100",job="consul_sd",mode="guest"&#125;</span></span><br></pre></td></tr></table></figure>
<p>这样可以方便的根据dc标签的值，根据不同的数据中心聚合分析各自的数据。在这个例子中，通过从Target实例中获取 <code>__meta_consul_dc</code> 的值，并且重写所有从该实例获取的样本中。</p>
<p>一般来说，Target 以<code>__</code>作为前置的标签是在系统内部使用的，因此这些标签不会被写入到样本数据中。在Prometheus所有的Target实例中，都包含一些默认的Metadata标签信息。可以通过 Prometheus UI 的Targets页面中查看这些实例的Metadata标签的内容：</p>
<p><img alt="实例的Metadata信息" data-src="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LPui3iWsSYuoIaPTZtS%2F-LPui6XS6SgDzCvoGrMw%2Fprometheus_file_target_metadata.png"></p>
<p>默认情况下，当Prometheus加载Target实例完成后，这些Target时候都会包含一些默认的标签：</p>
<ul>
<li><code>__address__</code>：当前Target实例的访问地址<code>&lt;host&gt;:&lt;port&gt;</code></li>
<li><code>__scheme__</code>：采集目标服务访问地址的HTTP Scheme，HTTP或者HTTPS</li>
<li><code>__metrics_path__</code>：采集目标服务访问地址的访问路径</li>
<li><code>__param_&lt;name&gt;</code>：采集任务目标服务的中包含的请求参数</li>
</ul>
<p>例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__address__="192.168.99.100:10250"</span><br><span class="line">__meta_kubernetes_node_address_Hostname="minikube"</span><br><span class="line">__meta_kubernetes_node_address_InternalIP="192.168.99.100"</span><br><span class="line">__meta_kubernetes_node_annotation_alpha_kubernetes_io_provided_node_ip="192.168.99.100"</span><br><span class="line">__meta_kubernetes_node_annotation_node_alpha_kubernetes_io_ttl="0"</span><br><span class="line">__meta_kubernetes_node_annotation_volumes_kubernetes_io_controller_managed_attach_detach="true"</span><br><span class="line">__meta_kubernetes_node_label_beta_kubernetes_io_arch="amd64"</span><br><span class="line">__meta_kubernetes_node_label_beta_kubernetes_io_os="linux"</span><br><span class="line">__meta_kubernetes_node_label_kubernetes_io_hostname="minikube"</span><br><span class="line">__meta_kubernetes_node_name="minikube"</span><br><span class="line">__metrics_path__="/metrics"</span><br><span class="line">__scheme__="https"</span><br><span class="line">instance="minikube"</span><br><span class="line">job="kubernetes-nodes"</span><br></pre></td></tr></table></figure>
<p>完整的relabel_config配置如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The source labels select values from existing labels. Their content is concatenated</span></span><br><span class="line"><span class="comment"># using the configured separator and matched against the configured regular expression</span></span><br><span class="line"><span class="comment"># for the replace, keep, and drop actions.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">source_labels:</span> <span class="string">'['</span> <span class="string">&lt;labelname&gt;</span> <span class="string">[,</span> <span class="string">...]</span> <span class="string">']'</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Separator placed between concatenated source label values.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">separator:</span> <span class="string">&lt;string&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Label to which the resulting value is written in a replace action.</span></span><br><span class="line"><span class="comment"># It is mandatory for replace actions. Regex capture groups are available.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">target_label:</span> <span class="string">&lt;labelname&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Regular expression against which the extracted value is matched.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">regex:</span> <span class="string">&lt;regex&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">(.*)</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Modulus to take of the hash of the source label values.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">modulus:</span> <span class="string">&lt;int&gt;</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Replacement value against which a regex replace is performed if the</span></span><br><span class="line"><span class="comment"># regular expression matches. Regex capture groups are available.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">replacement:</span> <span class="string">&lt;string&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">$1</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Action to perform based on regex matching.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">action:</span> <span class="string">&lt;relabel_action&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">replace</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<p><code>&lt;relabel_action&gt;</code> 决定了relabel时候采取的动作：</p>
<ul>
<li><code>replace</code>: Match <code>regex</code> against the concatenated <code>source_labels</code>. Then, set <code>target_label</code> to <code>replacement</code>, with match group references (<code>${1}</code>, <code>${2}</code>, …) in <code>replacement</code> substituted by their value. If <code>regex</code> does not match, no replacement takes place.</li>
<li><code>keep</code>: Drop targets for which <code>regex</code> does not match the concatenated <code>source_labels</code>.</li>
<li><code>drop</code>: Drop targets for which <code>regex</code> matches the concatenated <code>source_labels</code>.</li>
<li><code>hashmod</code>: Set <code>target_label</code> to the <code>modulus</code> of a hash of the concatenated <code>source_labels</code>.</li>
<li><code>labelmap</code>: Match <code>regex</code> against all label names. Then copy the values of the matching labels to label names given by <code>replacement</code> with match group references (<code>${1}</code>, <code>${2}</code>, …) in <code>replacement</code> substituted by their value.</li>
<li><code>labeldrop</code>: Match <code>regex</code> against all label names. Any label that matches will be removed from the set of labels.</li>
<li><code>labelkeep</code>: Match <code>regex</code> against all label names. Any label that does not match will be removed from the set of labels.</li>
</ul>
<p><strong>Replace</strong></p>
<p>其中action定义了当前relabel_config对Metadata标签的处理方式，默认的action行为为replace。replace行为会根据regex的配置匹配 <code>source_labels</code> 标签的值（多个source_label的值会按照separator进行拼接），并且将匹配到的值写入到target_label当中，如果有多个匹配组，则可以使用${1}, ${2}确定写入的内容。如果没匹配到任何内容则不对target_label进行重新。</p>
<p>repalce操作允许用户根据Target的Metadata标签重写或者写入新的标签键值对，在多环境的场景下，可以帮助用户添加与环境相关的特征维度，从而可以更好的对数据进行聚合。</p>
<p><strong>LabelMap</strong></p>
<p>labelmap会根据 regex 的定义去匹配 Target 实例所有标签的名称，并且以匹配到的内容为新的标签名称，其值作为新标签的值。例如，在监控 Kubernetes 下所有的主机节点时，为将这些节点上定义的标签写入到样本中时，可以使用如下 <code>relabel_config</code> 配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-nodes'</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br></pre></td></tr></table></figure>
<p><strong>Keep/Drop</strong></p>
<p>例如，如果我们只希望采集数据中心dc1中的Node Exporter实例的样本数据，那么可以使用如下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">node_exporter</span></span><br><span class="line">    <span class="attr">consul_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">localhost:8500</span></span><br><span class="line">        <span class="attr">services:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">node_exporter</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span>  <span class="string">["__meta_consul_dc"]</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">"dc1"</span></span><br><span class="line">      <span class="attr">action:</span> <span class="string">keep</span></span><br></pre></td></tr></table></figure>
<p>当action设置为 <code>keep</code> 时，Prometheus会丢弃 <code>source_labels</code> 的值中没有匹配到regex正则表达式内容的Target实例，而当action设置为drop时，则会丢弃那些source_labels的值匹配到regex正则表达式内容的Target实例。可以简单理解为keep用于选择，而drop用于排除。</p>
<p><strong>LabelKeep/LabelDrop</strong></p>
<p>使用 <code>labelkeep</code> 或者 <code>labeldrop</code> 则可以对Target标签进行过滤，仅保留符合过滤条件的标签，例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">label_should_drop_(.+)</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">labeldrop</span></span><br></pre></td></tr></table></figure>
<p>该配置会使用regex匹配当前Target实例的所有标签，并将符合regex规则的标签从Target实例中移除。labelkeep正好相反，会移除那些不匹配regex定义的所有标签。</p>
<h2 id="告警处理"><a href="#告警处理" class="headerlink" title="告警处理"></a>告警处理</h2><p>告警能力在Prometheus的架构中被划分成两个独立的部分：</p>
<ul>
<li>通过在Prometheus中定义AlertRule，Prometheus会周期性的对告警规则进行计算，如果满足告警触发条件就会向Alertmanager发送告警信息</li>
<li>AlertManager 收到来自 Prometheus Server 的报警规则后，对这些告警信息进行处理，并路由到正确的通知方</li>
</ul>
<p><img alt="Prometheus告警处理" data-src="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LVMF4RtPS-2rjW9R-hG%2F-LPS9QhUbi37E1ZK8mXF%2Fprometheus-alert-artich.png?alt=media"></p>
<p>Alertmanager除了提供基本的告警通知能力以外，还主要提供了如：分组、抑制以及静默等告警特性：</p>
<p><img alt="Alertmanager特性" data-src="https://gblobscdn.gitbook.com/assets%2F-LBdoxo9EmQ0bJP2BuUi%2F-LVMF4RtPS-2rjW9R-hG%2F-LPS9QhWQUhAIdLAiEfH%2Falertmanager-features.png?alt=media"></p>
<h3 id="告警规则"><a href="#告警规则" class="headerlink" title="告警规则"></a>告警规则</h3><p>一条典型的告警规则如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighErrorRate</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">job:request_latency_seconds:mean5m&#123;job="myjob"&#125;</span> <span class="string">&gt;</span> <span class="number">0.5</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">10m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">page</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">High</span> <span class="string">request</span> <span class="string">latency</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">description</span> <span class="string">info</span></span><br></pre></td></tr></table></figure>
<p>在告警规则文件中，我们可以将一组相关的规则设置定义在一个group下。在每一个group中我们可以定义多个告警规则。一条告警规则主要由以下几部分组成：</p>
<ul>
<li>alert：告警规则的名称。</li>
<li>expr：基于PromQL表达式告警触发条件，用于计算是否有时间序列满足该条件。</li>
<li>for：评估等待时间，可选参数。用于表示只有当触发条件持续一段时间后才发送告警。在等待期间新产生告警的状态为 pending。</li>
<li>labels：自定义标签，允许用户指定要附加到告警上的一组附加标签。</li>
<li>annotations：用于指定一组附加信息，比如用于描述告警详细信息的文字等，annotations的内容在告警产生时会一同作为参数发送到 Alertmanager。</li>
</ul>
<p>为了能够让Prometheus能够启用定义的告警规则，我们需要在Prometheus全局配置文件中通过<strong>rule_files</strong>指定一组告警规则文件的访问路径，Prometheus启动后会自动扫描这些路径下规则文件中定义的内容，并且根据这些规则计算是否向外部发送通知：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;filepath_glob&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>默认情况下Prometheus会每分钟对这些告警规则进行计算，如果用户想定义自己的告警计算周期，则可以通过<code>evaluation_interval</code>来覆盖默认的计算周期：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">evaluation_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<h3 id="模板化"><a href="#模板化" class="headerlink" title="模板化"></a>模板化</h3><p>一般来说，在告警规则文件的annotations中使用<code>summary</code>描述告警的概要信息，<code>description</code>用于描述告警的详细信息。同时 Alertmanager 的UI也会根据这两个标签值，显示告警信息。为了让告警信息具有更好的可读性，Prometheus支持模板化label和annotations的中标签的值。</p>
<p>通过<code>$labels.&lt;labelname&gt;</code>变量可以访问当前告警实例中指定标签的值。$value则可以获取当前PromQL表达式计算的样本值。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># To insert a firing element's label values:</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">$labels.&lt;labelname&gt;</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="comment"># To insert the numeric expression value of the firing element:</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">$value</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>例如，可以通过模板化优化 <code>summary</code> 以及 <code>description</code> 的内容的可读性：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># Alert for any instance that is unreachable for &gt;5 minutes.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">InstanceDown</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">page</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> down"</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> of job <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has been down for more than 5 minutes."</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Alert for any instance that has a median request latency &gt;1s.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">APIHighRequestLatency</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">api_http_request_latencies_second&#123;quantile="0.5"&#125;</span> <span class="string">&gt;</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">10m</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">"High request latency on <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> has a median request latency above 1s (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>s)"</span></span><br></pre></td></tr></table></figure>
<p>配置 Alert Rules，修改 Prometheus 配置文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">global:</span></span><br><span class="line">      <span class="attr">scrape_interval:</span>     <span class="string">15s</span></span><br><span class="line">      <span class="attr">evaluation_interval:</span> <span class="string">15s</span></span><br><span class="line">    <span class="attr">rule_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/config/recording_rules.yml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/config/alerting_rules.yml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/config/rules</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/config/alerts</span></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'prometheus'</span></span><br><span class="line">        <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9090']</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'node'</span></span><br><span class="line">        <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['node-exporter:9100']</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'container'</span></span><br><span class="line">        <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['cadvisor:8080']</span></span><br><span class="line">  <span class="attr">alerting_rules.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">groups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hostStatsAlert</span></span><br><span class="line">      <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">hostMemUsageAlert</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">(sum(node_memory_MemTotal_bytes)</span> <span class="bullet">-</span> <span class="string">sum(node_memory_MemFree_bytes</span> <span class="string">+</span> <span class="string">node_memory_Buffers_bytes+node_memory_Cached_bytes))</span> <span class="string">/</span> <span class="string">sum(node_memory_MemTotal_bytes)</span> <span class="string">&gt;</span> <span class="number">0.55</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">page</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">            <span class="attr">summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> MEM usgae high"</span></span><br><span class="line">            <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> MEM usage above 85% (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br><span class="line">  <span class="attr">alerts:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">recording_rules.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">rules:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p>重启Prometheus后访问Prometheus UI 可以查看当前以加载的规则文件：</p>
<p><img alt data-src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-09-17_prometheus-rules.png"></p>
<p>切换到Alerts标签可以查看当前告警的活动状态。</p>
<p><img alt data-src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-09-17_prometheus-alerts.png"></p>
<p>现在只是在 Prometheus Web 页面查看警告，通过配置 <code>Alert Manager</code> 可以实现连接钉钉/Slack等平台报警。</p>
<h2 id="聚合规则"><a href="#聚合规则" class="headerlink" title="聚合规则"></a>聚合规则</h2><p>通过PromQL可以实时对Prometheus中采集到的样本数据进行查询，聚合以及其它各种运算操作。而在某些PromQL较为复杂且计算量较大时，直接使用PromQL可能会导致Prometheus响应超时的情况。这时需要一种能够类似于后台批处理的机制能够在后台完成这些复杂运算的计算，对于使用者而言只需要查询这些运算结果即可。Prometheus通过Recoding Rule规则支持这种后台计算的方式，可以实现对复杂查询的性能优化，提高查询效率。</p>
<p>在 Prometheus 配置文件中，通过 <code>rule_files</code> 定义 <code>recoding rule</code> 规则文件的访问路径。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;filepath_glob&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>每一个规则文件通过以下格式进行定义：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;rule_group&gt;</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>一个简单的规则文件可能是这个样子的：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">record:</span> <span class="string">job:http_inprogress_requests:sum</span></span><br><span class="line">      <span class="attr">expr:</span> <span class="string">sum(http_inprogress_requests)</span> <span class="string">by</span> <span class="string">(job)</span></span><br></pre></td></tr></table></figure>
<p><code>rule_group</code> 的具体配置项如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The name of the group. Must be unique within a file.</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># How often rules in the group are evaluated.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">global.evaluation_interval</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;rule&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>与告警规则一致，一个group下可以包含多条规则rule。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The name of the time series to output to. Must be a valid metric name.</span></span><br><span class="line"><span class="attr">record:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The PromQL expression to evaluate. Every evaluation cycle this is</span></span><br><span class="line"><span class="comment"># evaluated at the current time, and the result recorded as a new set of</span></span><br><span class="line"><span class="comment"># time series with the metric name as given by 'record'.</span></span><br><span class="line"><span class="attr">expr:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Labels to add or overwrite before storing the result.</span></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;labelvalue&gt;</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>根据规则中的定义，Prometheus会在后台完成expr中定义的PromQL表达式计算，并且将计算结果保存到新的时间序列record中。同时还可以通过labels为这些样本添加额外的标签。</p>
<p>这些规则文件的计算频率与告警规则计算频率一致，都通过global.evaluation_interval定义:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">evaluation_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://prometheus.io/docs/prometheus/latest/" target="_blank" rel="external nofollow noopener noreferrer">Prometheus Documentation</a></li>
<li><a href="https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml" target="_blank" rel="external nofollow noopener noreferrer">Prometheus Kubernetes Examples</a></li>
</ul>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章推荐</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/588dbd28/" rel="bookmark">【系统监控】Grafana 入门</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/dd1e183c/" rel="bookmark">【系统监控】Node Exporter</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/7f85cd98/" rel="bookmark">【系统监控】Linux常见监控指标</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/703a5727/" rel="bookmark">【系统监控】cAdvisor</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/9bd76ed5/" rel="bookmark">【系统监控】kube-state-metrics</a></div>
    </li>
  </ul>

      
        <div class="reward-container">
  <div></div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/wechatpay.png" alt="Houmin 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/alipay.jpg" alt="Houmin 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Houmin
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://houmin.cc/posts/18c039ab/" title="【系统监控】Prometheus">http://houmin.cc/posts/18c039ab/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/%E7%9B%91%E6%8E%A7/" rel="tag"><i class="fa fa-tag"></i> 监控</a>
              <a href="/tags/%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/" rel="tag"><i class="fa fa-tag"></i> 可观测性</a>
              <a href="/tags/prometheus/" rel="tag"><i class="fa fa-tag"></i> prometheus</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/posts/dd1e183c/" rel="next" title="【系统监控】Node Exporter">
                  <i class="fa fa-chevron-left"></i> 【系统监控】Node Exporter
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/posts/4cc9f1a2/" rel="prev" title="【Kubernetes】Liveness/Readiness Probe">
                  【Kubernetes】Liveness/Readiness Probe <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="comments"></div>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#系统架构"><span class="nav-number">1.</span> <span class="nav-text">系统架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署使用"><span class="nav-number">2.</span> <span class="nav-text">部署使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ConfigMap"><span class="nav-number">2.1.</span> <span class="nav-text">ConfigMap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deployment"><span class="nav-number">2.2.</span> <span class="nav-text">Deployment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Service"><span class="nav-number">2.3.</span> <span class="nav-text">Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ingress"><span class="nav-number">2.4.</span> <span class="nav-text">Ingress</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据模型"><span class="nav-number">3.</span> <span class="nav-text">数据模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Sample"><span class="nav-number">3.1.</span> <span class="nav-text">Sample</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Metric"><span class="nav-number">3.2.</span> <span class="nav-text">Metric</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Counter-只增不减的计数器"><span class="nav-number">3.2.1.</span> <span class="nav-text">Counter 只增不减的计数器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Gauge-可增可减的仪表盘"><span class="nav-number">3.2.2.</span> <span class="nav-text">Gauge 可增可减的仪表盘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Histogram-直方图"><span class="nav-number">3.2.3.</span> <span class="nav-text">Histogram 直方图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Summary-摘要"><span class="nav-number">3.2.4.</span> <span class="nav-text">Summary 摘要</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PromQL查询"><span class="nav-number">4.</span> <span class="nav-text">PromQL查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查询时间序列"><span class="nav-number">4.1.</span> <span class="nav-text">查询时间序列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#范围查询"><span class="nav-number">4.2.</span> <span class="nav-text">范围查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#时间位移操作"><span class="nav-number">4.3.</span> <span class="nav-text">时间位移操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#操作符"><span class="nav-number">4.4.</span> <span class="nav-text">操作符</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#数学运算"><span class="nav-number">4.4.1.</span> <span class="nav-text">数学运算</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#布尔运算"><span class="nav-number">4.4.2.</span> <span class="nav-text">布尔运算</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集合运算"><span class="nav-number">4.4.3.</span> <span class="nav-text">集合运算</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#操作符优先级"><span class="nav-number">4.4.4.</span> <span class="nav-text">操作符优先级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#匹配模式（联合查询）"><span class="nav-number">4.4.5.</span> <span class="nav-text">匹配模式（联合查询）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#一对一匹配"><span class="nav-number">4.4.5.1.</span> <span class="nav-text">一对一匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#多对一和一对多"><span class="nav-number">4.4.5.2.</span> <span class="nav-text">多对一和一对多</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#聚合操作"><span class="nav-number">4.5.</span> <span class="nav-text">聚合操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内置函数"><span class="nav-number">4.6.</span> <span class="nav-text">内置函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#计算Counter指标增长率"><span class="nav-number">4.6.1.</span> <span class="nav-text">计算Counter指标增长率</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预测Gauge指标变化趋势"><span class="nav-number">4.6.2.</span> <span class="nav-text">预测Gauge指标变化趋势</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#统计Histogram指标的分位数"><span class="nav-number">4.6.3.</span> <span class="nav-text">统计Histogram指标的分位数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#动态标签替换"><span class="nav-number">4.6.4.</span> <span class="nav-text">动态标签替换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其它内置函数"><span class="nav-number">4.6.5.</span> <span class="nav-text">其它内置函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API访问"><span class="nav-number">4.7.</span> <span class="nav-text">API访问</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#瞬时数据查询"><span class="nav-number">4.7.1.</span> <span class="nav-text">瞬时数据查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#区间范围查询"><span class="nav-number">4.7.2.</span> <span class="nav-text">区间范围查询</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务发现"><span class="nav-number">5.</span> <span class="nav-text">服务发现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基于k8s的服务发现"><span class="nav-number">5.1.</span> <span class="nav-text">基于k8s的服务发现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#node"><span class="nav-number">5.1.1.</span> <span class="nav-text">node</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#service"><span class="nav-number">5.1.2.</span> <span class="nav-text">service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pod"><span class="nav-number">5.1.3.</span> <span class="nav-text">pod</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#endpoints"><span class="nav-number">5.1.4.</span> <span class="nav-text">endpoints</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ingress"><span class="nav-number">5.1.5.</span> <span class="nav-text">ingress</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Relabeling-机制"><span class="nav-number">5.2.</span> <span class="nav-text">Relabeling 机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#告警处理"><span class="nav-number">6.</span> <span class="nav-text">告警处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#告警规则"><span class="nav-number">6.1.</span> <span class="nav-text">告警规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模板化"><span class="nav-number">6.2.</span> <span class="nav-text">模板化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#聚合规则"><span class="nav-number">7.</span> <span class="nav-text">聚合规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">8.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Houmin" src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/avatar.png">
  <p class="site-author-name" itemprop="name">Houmin</p>
  <div class="site-description" itemprop="description">丈夫拥书万卷，何假南面百城</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">171</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">234</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/SimpCosm" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;SimpCosm" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weihoumin@gmail.com" title="E-Mail &amp;rarr; mailto:weihoumin@gmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="hitokoto">
    <!-- hitokoto -->
    <div id="hito-expression">:D 获取中...</div>

    <script src="https://cdn.jsdelivr.net/npm/bluebird@3/js/browser/bluebird.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@2.0.3/fetch.min.js"></script>
    <script>
      fetch('https://v1.hitokoto.cn')
        .then(function (res){
          return res.json();
        })
        .then(function (data) {
          var hitokoto = document.getElementById('hito-expression');
          hitokoto.innerText = data.hitokoto + '——【' + data.from + '】';
        })
        .catch(function (err) {
          console.error(err);
        })
    </script>
  </div>

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heartbeat"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Houmin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">2.2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">65:30</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>



  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.1.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  




  <script src="/js/local-search.js"></script>








<script>
if (document.querySelectorAll('div.pdf').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/pdfobject@2/pdfobject.min.js', () => {
    document.querySelectorAll('div.pdf').forEach(element => {
      PDFObject.embed(element.getAttribute('target'), element, {
        pdfOpenParams: {
          navpanes: 0,
          toolbar: 0,
          statusbar: 0,
          pagemode: 'thumbs',
          view: 'FitH'
        },
        PDFJS_URL: '/lib/pdf/web/viewer.html',
        height: element.getAttribute('height') || '800px'
      });
    });
  }, window.PDFObject);
}
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>



  

  

  


<script>
NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'iEBFuhVyk4tuhVYctQ265uid-gzGzoHsz',
    appKey: 'KGjOktrtgSEWK1v9DYA3T3Az',
    placeholder: "Just go go",
    avatar: 'retro',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: 'zh-cn' || 'zh-cn',
    path: location.pathname,
    recordIP: true,
    serverURLs: ''
  });
}, window.Valine);
</script>

</body>
</html>
