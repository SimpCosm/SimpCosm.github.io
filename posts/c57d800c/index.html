<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="icon" type="image/png" sizes="32x32" href="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="Houmin" type="application/atom+xml">
  <meta name="google-site-verification" content="zdGhdEF7jHoJW58lsdN6l9JrQFjJFwakCIc7TbbosV0">
  <meta name="msvalidate.01" content="2F527B379ED5537861D0D38C2C754C2B">
  <meta name="baidu-site-verification" content="xAag2PqzKE">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css">
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":true},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: true,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="在 Controller Manager 的系列文章 中我们看到，Kubernetes 内置的各种 Controller 通过ApiServer监控 Deployment、DaemonSet、StatefulSet 等内部资源对象，在一个控制循环中通过各种操作将系统维持在我们期望的一个状态中，这即是其经典的 声明式API设计。然而，内置的API资源大多仅代表相对底层和通用概念的对象，已经不能够满足">
<meta name="keywords" content="k8s,crd,controller">
<meta property="og:type" content="article">
<meta property="og:title" content="【Kubernetes】CRD">
<meta property="og:url" content="http://houmin.cc/posts/c57d800c/index.html">
<meta property="og:site_name" content="Houmin">
<meta property="og:description" content="在 Controller Manager 的系列文章 中我们看到，Kubernetes 内置的各种 Controller 通过ApiServer监控 Deployment、DaemonSet、StatefulSet 等内部资源对象，在一个控制循环中通过各种操作将系统维持在我们期望的一个状态中，这即是其经典的 声明式API设计。然而，内置的API资源大多仅代表相对底层和通用概念的对象，已经不能够满足">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://lihaoquan.me/media/2020/202003081.png">
<meta property="og:image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-07-20_client-go-controller-interaction.jpeg">
<meta property="og:updated_time" content="2020-11-27T03:23:33.305Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lihaoquan.me/media/2020/202003081.png">

<link rel="canonical" href="http://houmin.cc/posts/c57d800c/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>【Kubernetes】CRD | Houmin</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


  <script src="/js/photoswipe.min.js?v="></script>
  <script src="/js/photoswipe-ui-default.min.js?v="></script>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Houmin</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">Yesterday You Said Tomorrow</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-album">

    <a href="/album" rel="section"><i class="fa fa-fw fa-camera"></i>相册</a>

  </li>
        <li class="menu-item menu-item-movies">

    <a href="/movies/" rel="section"><i class="fa fa-fw fa-film"></i>观影</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="/books/" rel="section"><i class="fa fa-fw fa-book"></i>阅读</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://houmin.cc/posts/c57d800c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/avatar.png">
      <meta itemprop="name" content="Houmin">
      <meta itemprop="description" content="丈夫拥书万卷，何假南面百城">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Houmin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          【Kubernetes】CRD
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-12 14:23:18" itemprop="dateCreated datePublished" datetime="2020-09-12T14:23:18+08:00">2020-09-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9C%AF%E4%B8%9A%E4%B8%93%E6%94%BB/" itemprop="url" rel="index">
                    <span itemprop="name">术业专攻</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/posts/c57d800c/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/posts/c57d800c/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>26k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>47 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>在 <a href="https://houmin.cc/tags/controller">Controller Manager 的系列文章</a> 中我们看到，Kubernetes 内置的各种 Controller 通过ApiServer监控 <a href="https://houmin.cc">Deployment</a>、<a href="https://houmin.cc">DaemonSet</a>、<a href="https://houmin.cc">StatefulSet </a>等内部资源对象，在一个控制循环中通过各种操作将系统维持在我们期望的一个状态中，这即是其经典的 <code>声明式API设计</code>。然而，内置的API资源大多仅代表相对底层和通用概念的对象，已经不能够满足越来越复杂的业务场景需求。随着Kubernetes生态系统的持续发展，我们将需要更多高层次的面向专门的场景的对象。在声明式API的原则下，设计自定义资源API，开发者将不需要逐一进行 Deployment、Service、ConfigMap 等步骤，而是创建并关联一些用于表述整个应用程序或者软件服务的对象。在当前，CoreOS推出的各种 <a href="https://coreos.com/operators/" target="_blank" rel="external nofollow noopener noreferrer">Operator</a> 即是这一思想的广泛利用。为了实现 Operator，你需要了解 <code>CRD（CustomResourceDefinitions）</code>。本文所有实现的代码，可以参考我的 <a href="https://github.com/SimpCosm/crddemo" target="_blank" rel="external nofollow noopener noreferrer">Github</a>。</p>
<a id="more"></a>
<h2 id="CRD使用方法"><a href="#CRD使用方法" class="headerlink" title="CRD使用方法"></a>CRD使用方法</h2><p>在 <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" target="_blank" rel="external nofollow noopener noreferrer">Extend the Kubernetes API with CustomResourceDefinitions</a> 中介绍了使用CRD扩展Kubernetes API的详细用法，简单来说可以分为两步：</p>
<ul>
<li>利用CRD API声明自定义的资源API</li>
<li>根据刚才声明的资源API，创建自定义的资源对象</li>
</ul>
<h3 id="Create-CustomResourceDefinition"><a href="#Create-CustomResourceDefinition" class="headerlink" title="Create CustomResourceDefinition"></a>Create CustomResourceDefinition</h3><p>首先我们可以使用 <code>CustomResourceDefinition</code> 声明自定义的资源API，这里也可以将我们自定义的资源API理解为  <code>CustomResourceDefinition</code> 这个API的对象，我们可以指定它的 <code>metadata.name</code>。这里没有 <code>metadata.namespace</code>字段，是因为<code>CustomResourceDefinition</code> 适用于所有命名空间。</p>
<p>CRD定义中的关键字段如下：</p>
<ul>
<li>group：设置API所属的组，将其映射为API URL中的 “/apis/” 下一级目录。它是逻辑上相关的Kinds集合</li>
<li>scope：该API的生效范围，可选项为Namespaced和Cluster。</li>
<li>version：每个 Group 可以存在多个版本。例如，v1alpha1，然后升为 v1beta1，最后稳定为 v1 版本。</li>
<li>names：CRD的名称，包括单数、复数、kind、所属组等名称定义</li>
</ul>
<p><img alt="api url" data-src="https://lihaoquan.me/media/2020/202003081.png"></p>
<p>在下面的示例中，我们定义资源的Group是<code>example.houmin.cc</code>，version是v1，kind是Foo。这里的version是一个list，可以指定多个服务的版本，这里只是简单声明了v1这个版本，具体可以参考 <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" target="_blank" rel="external nofollow noopener noreferrer">Extend the Kubernetes API with CustomResourceDefinitions</a> 和 <a href="https://github.com/kubernetes/apiextensions-apiserver/blob/cec7d1c927364a42e97ab2b400d5f15a953ab84d/pkg/apis/apiextensions/v1/types.go#L59" target="_blank" rel="external nofollow noopener noreferrer">源代码</a>。</p>
<figure class="highlight yaml"><figcaption><span>crd.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">foos.example.houmin.cc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">example.houmin.cc</span></span><br><span class="line">  <span class="comment"># list of versions supported by this CustomResourceDefinition</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="comment"># kind is normally the CamelCased singular type. Your resource manifests use this.</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Foo</span></span><br><span class="line">    <span class="comment"># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">foos</span></span><br><span class="line">    <span class="comment"># singular name to be used as an alias on the CLI and for display</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">foo</span></span><br><span class="line">    <span class="comment"># shortNames allow shorter string to match your resource on the CLI</span></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">fo</span></span><br><span class="line">  <span class="comment"># either Namespaced or Cluster</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br></pre></td></tr></table></figure>
<p>根据上面的manifest文件，即可创建CRD。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f crd.yaml</span></span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/foos.example.houmin.cc created</span><br></pre></td></tr></table></figure>
<h3 id="Create-custom-objects"><a href="#Create-custom-objects" class="headerlink" title="Create custom objects"></a>Create custom objects</h3><p>在声明了自定义资源后，就可以编辑下面这样的manifest文件，创建用户自定义资源的对象，就像 <code>Pod</code>等原生资源一样。</p>
<figure class="highlight yaml"><figcaption><span>example-foo.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">example.houmin.cc/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Foo</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-foo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">deploymentName:</span> <span class="string">example-foo</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>这里的 <code>deploymentName</code> 和 <code>replicas</code> 都是我们自定义资源API的字段，在后面会详细介绍。使用kubectl创建资源后，我们发现CRD的使用和原生API资源毫无区别。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f example-foo.yaml</span></span><br><span class="line"><span class="string">foo.example.houmin.cc/example-foo</span> <span class="string">created</span></span><br><span class="line"><span class="comment"># kubectl get foo</span></span><br><span class="line"><span class="string">NAME</span>          <span class="string">AGE</span></span><br><span class="line"><span class="string">example-foo</span>   <span class="string">8s</span></span><br><span class="line"><span class="comment"># kubectl get foo -o yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">items:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">example.houmin.cc/v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Foo</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">"2020-10-27T13:32:15Z"</span></span><br><span class="line">    <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">example-foo</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">"294744500"</span></span><br><span class="line">    <span class="attr">selfLink:</span> <span class="string">/apis/example.houmin.cc/v1/namespaces/default/foos/example-foo</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">ece2daac-5510-4de1-b924-c8b1a5e178fd</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">deploymentName:</span> <span class="string">example-foo</span></span><br><span class="line">    <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">List</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">""</span></span><br></pre></td></tr></table></figure>
<p>经过上面的两步操作，我们已经能够自定义资源API并且使用它了。但是，在第一步和第二步之间还需要做一些工作，不然直接创建自定义资源对象是不会成功的。为什么呢？想一想，对于原生的资源API，比如Deployment，我们都有对应的Controller在 ApiServer 监听每一个Deployment 资源的创建，并随之创建对应的Pod和维护其状态。对于我们创建的CRD资源，我们也需要有对应的Controller做类似的工作。</p>
<p>另外，刚才提到我们创建的 <code>Foo</code>资源具有两个字段 <code>deploymentName</code> 和 <code>replicas</code>，这个都是我们自定义的，你也可以根据你的需要定义你自己的字段。每次创建 <code>Foo</code> 对象后，我们实现的 Controller 就会根据自己的逻辑去做自己的事情，比如这里就是维护 <code>replicas</code> 个 <code>deployment</code>，具体的工作流程如下图所示。</p>
<p><img alt="crd arch" data-src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/blog/2020-07-20_client-go-controller-interaction.jpeg"></p>
<p>CRD控制器的工作流，可分为监听、同步、触发三个步骤：</p>
<ul>
<li>Controller 首先会通过 Informer 从 API Server中获取它所关心的对象，这里就是上面的Foo对象。<ul>
<li>值得注意的是Informer在构建之前，会使用我们生成的client（下面编码阶段会提到）,再透过Reflector的ListAndWatch机制跟API Server建立连接，不断地监听 Foo 对象实例的变化。</li>
<li>在 ListAndWatch 机制下，一旦 APIServer 端有新的 Foo 实例被创建、删除或者更新，Reflector 都会收到 <strong>事件通知</strong>。</li>
<li>该事件及它对应的 API 对象会被放进一个 Delta FIFO Queue中。</li>
</ul>
</li>
<li>Local Store 此时完成同步缓存操作</li>
<li>Informer 根据这些事件的类型，触发我们编写并注册好的ResourceEventHandler，完成业务动作的触发。</li>
</ul>
<p>上面图中的 Control Loop 实际上可以通过code-generator生成，下面也会提到。总之Control Loop中我们只关心如何拿到 <strong>Current State</strong>，并与 <strong>Desired State</strong> 对比，从而具体的差异处理逻辑，只需要开发者自行编写即可。</p>
<h2 id="定义CRD资源"><a href="#定义CRD资源" class="headerlink" title="定义CRD资源"></a>定义CRD资源</h2><p>首先，kubernetes涉及的代码生成对项目目录结构是有要求的，所以我们先创建一个结构如下的项目，可见关键在于pkg目录就是API组的URL结构</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">├── artifacts</span><br><span class="line">│   └── examples</span><br><span class="line">│       ├── crd.yaml</span><br><span class="line">│       └── example-foo.yaml</span><br><span class="line">├── controller.go</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── hack</span><br><span class="line">├── main.go</span><br><span class="line">└── pkg</span><br><span class="line">    └── apis</span><br><span class="line">        └── example</span><br><span class="line">            ├── register.go</span><br><span class="line">            └── v1</span><br><span class="line">                ├── doc.go</span><br><span class="line">                ├── register.go</span><br><span class="line">                └── types.go</span><br></pre></td></tr></table></figure>
<ol>
<li>我们首先开看 <code>pkg/apis/example/register.go</code>，这个文件主要用来存放全局变量，如下：</li>
</ol>
<figure class="highlight go"><figcaption><span>pkg/apis/example/register.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	GroupName = <span class="string">"example.houmin.cc"</span></span><br><span class="line">	Version   = <span class="string">"v1"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ol>
<li><code>pkg/apis/example/v1/doc.go</code>  主要是 <code>global tags</code>，起到的是全局的代码生成控制的作用，详见代码生成解释。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +k8s:deepcopy-gen=package</span></span><br><span class="line"><span class="comment">// +groupName=example.houmin.cc</span></span><br><span class="line"><span class="keyword">package</span> v1</span><br></pre></td></tr></table></figure>
<ol>
<li><code>pkg/apis/example/v1/types</code> 的作用就是定义一个 Foo 类型到底有哪些字段（比如，spec 字段里的内容）。这个文件的主要内容如下所示：</li>
</ol>
<figure class="highlight go"><figcaption><span>pkg/apis/example/v1/types</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> v1</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	metav1 <span class="string">"k8s.io/apimachinery/pkg/apis/meta/v1"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// +genclient</span></span><br><span class="line"><span class="comment">// +genclient:noStatus</span></span><br><span class="line"><span class="comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Foo <span class="keyword">struct</span> &#123;</span><br><span class="line">	metav1.TypeMeta <span class="string">`json:",inline"`</span></span><br><span class="line"></span><br><span class="line">	metav1.ObjectMeta <span class="string">`json:"metadata,omitempty"`</span></span><br><span class="line"></span><br><span class="line">	Spec   FooSpec   <span class="string">`json:"spec"`</span></span><br><span class="line">	Status FooStatus <span class="string">`json:"status"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FooSpec is the spec for a Foo resource</span></span><br><span class="line"><span class="keyword">type</span> FooSpec <span class="keyword">struct</span> &#123;</span><br><span class="line">	DeploymentName <span class="keyword">string</span> <span class="string">`json:"deploymentName"`</span></span><br><span class="line">	Replicas       *<span class="keyword">int32</span> <span class="string">`json:"replicas"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FooStatus is the status for a Foo resource</span></span><br><span class="line"><span class="keyword">type</span> FooStatus <span class="keyword">struct</span> &#123;</span><br><span class="line">	AvailableReplicas <span class="keyword">int32</span> <span class="string">`json:"availableReplicas"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> FooList <span class="keyword">struct</span> &#123;</span><br><span class="line">	metav1.TypeMeta <span class="string">`json:",inline"`</span></span><br><span class="line">	metav1.ListMeta <span class="string">`json:"metadata"`</span></span><br><span class="line"></span><br><span class="line">	Items []Foo <span class="string">`json:"items"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码，可以看到我们的<code>Foo</code>定义方法跟k8s对象一样，都包含了 <code>TypeMeta</code> 和 <code>ObjectMeta</code>字段，而其中比较重要的是 <code>Spec</code> 字段和 <code>Status</code> 字段，这个可以根据用户需要自定义。</p>
<p>此外，除了定义 <code>Foo</code> 类型，你还需要定义一个 <code>FooList</code> 类型，用来描述一组 <code>Foo</code> 对象应该包括哪些字段。之所以需要这样一个类型，是因为在 Kubernetes 中，获取所有某对象的 List() 方法，返回值都是List 类型，而不是某类型的数组。所以代码上一定要做区分</p>
<p>除此之外，还有几个作为 <code>local tags</code> 存在的注释，主要用于控制代码生成，详见下一小节。</p>
<ol>
<li><code>pkg/apis/example/register.go</code> 作用就是注册一个类型（Type）给 APIServer。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> v1</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/SimpCosm/crddemo/pkg/apis/example"</span></span><br><span class="line"></span><br><span class="line">	metav1 <span class="string">"k8s.io/apimachinery/pkg/apis/meta/v1"</span></span><br><span class="line">	<span class="string">"k8s.io/apimachinery/pkg/runtime"</span></span><br><span class="line">	<span class="string">"k8s.io/apimachinery/pkg/runtime/schema"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> SchemeGroupVersion = schema.GroupVersion&#123;</span><br><span class="line">	Group:   example.GroupName,</span><br><span class="line">	Version: example.Version,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	SchemeBuilder = runtime.NewSchemeBuilder(addKnownTypes)</span><br><span class="line">	AddToScheme   = SchemeBuilder.AddToScheme</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Resource</span><span class="params">(resource <span class="keyword">string</span>)</span> <span class="title">schema</span>.<span class="title">GroupResource</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> SchemeGroupVersion.WithResource(resource).GroupResource()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Kind</span><span class="params">(kind <span class="keyword">string</span>)</span> <span class="title">schema</span>.<span class="title">GroupKind</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> SchemeGroupVersion.WithKind(kind).GroupKind()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addKnownTypes</span><span class="params">(scheme *runtime.Scheme)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	scheme.AddKnownTypes(</span><br><span class="line">		SchemeGroupVersion,</span><br><span class="line">		&amp;Foo&#123;&#125;,</span><br><span class="line">		&amp;FooList&#123;&#125;,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// register the type in the scheme</span></span><br><span class="line">	metav1.AddToGroupVersion(scheme, SchemeGroupVersion)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了 <code>addKnownTypes</code> 这个方法，Kubernetes 就能够在后面生成客户端的时候，知道 <code>Foo</code> 以及<code>FooList</code> 类型的定义了。</p>
<p>好了，到这里为止，我们有关定义的代码已经写好了，正如controller原理图所示，接下来我们需要通过kubernetes提供的代码生成工具，为上面的<code>Foo</code>资源类型生成clientset、informer 和 lister。</p>
<h2 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h2><p>kubernetes社区有一个<a href="https://github.com/kubernetes/code-generator" target="_blank" rel="external nofollow noopener noreferrer">k8s.io/code-generator</a> 仓库，在里面提供了一系列代码生成工具：</p>
<ul>
<li><code>deepcopy-gen</code>：为每个类型T创建了 <code>func (t *T) DeepCopy() *T</code>方法</li>
<li><code>client-gen</code>：为CustomeResource APIGroups 创建 typed clientsets</li>
<li><code>informer-gen</code>：为CustomResource创建informers，能够监听到服务端CustomResource发生变化的事件</li>
<li><code>lister-gen</code>：为CustomResource创建listers，能够为GET/LIST请求提供一个read only的Caching Layer</li>
</ul>
<p>其中生成的 informer 和 lister 是创建Controller的基础，通过这四个generator就可以创建一个 <code>full-featured, producation-ready</code>的controller。除此之外，<code>code-generator</code>还提供了其他的生成工具，比如 <code>conversion-gen</code> 提供了API内部版本和外部版本的转换函数，<code>defaulter-gen</code>提供了产生默认的字段的工具。</p>
<p>所有的这些code-generator都是基于<a href="https://github.com/kubernetes/gengo" target="_blank" rel="external nofollow noopener noreferrer">k8s.io/gengo</a>实现的，他们有一些共同的命令行参数，比如 <code>--input-dirs</code> 获得input package，<code>--output-package</code> 指定生成的package的目录。但是我们不需要去一个一个指定各个命令行参数， <a href="https://github.com/kubernetes/code-generator" target="_blank" rel="external nofollow noopener noreferrer">k8s.io/code-generator</a> 提供了一个Shell脚本 <a href="https://github.com/kubernetes/code-generator/blob/master/generate-groups.sh" target="_blank" rel="external nofollow noopener noreferrer">generator-group.sh</a> 来便于在CRD开发过程中的代码生成。只需一行代码，通常在 <code>hack/update-codegen.sh</code>中即可调用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vendor/k8s.io/code-generator/generate-groups.sh all \ <span class="comment"># GENS="$1"</span></span><br><span class="line">github.com/SimpCosm/crddemo/pkg/client \ <span class="comment"># OUTPUT_PKG="$2"</span></span><br><span class="line">github.com/SimpCosm/crddemo/pkg/apis \   <span class="comment"># APIS_PKG="$3"</span></span><br><span class="line">example.houmin.cc:v1 <span class="comment"># GROUPS_WITH_VERSIONS="$4"</span></span><br></pre></td></tr></table></figure>
<p>执行命令后，可以看到 <code>pkg</code> 下代码生成如下，在 <code>pkg/apis</code>目录下，除了原有的代码，生成了 <code>zz_generated_deepcopy.go</code> 的代码， <code>pkg/client</code> 目录则是完全生成的，包括 <code>clientset</code>、<code>informers</code>、<code>listers</code>等代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pkg</span><br><span class="line">├── apis</span><br><span class="line">│   └── example</span><br><span class="line">│       ├── register.go</span><br><span class="line">│       └── v1</span><br><span class="line">│           ├── doc.go</span><br><span class="line">│           ├── register.go</span><br><span class="line">│           ├── types.go</span><br><span class="line">│           └── zz_generated.deepcopy.go</span><br><span class="line">└── client</span><br><span class="line">    ├── clientset</span><br><span class="line">    │   └── versioned</span><br><span class="line">    │       ├── clientset.go</span><br><span class="line">    │       ├── doc.go</span><br><span class="line">    │       ├── fake</span><br><span class="line">    │       ├── scheme</span><br><span class="line">    │       └── typed</span><br><span class="line">    ├── informers</span><br><span class="line">    │   └── externalversions</span><br><span class="line">    │       ├── example</span><br><span class="line">    │       ├── factory.go</span><br><span class="line">    │       ├── generic.go</span><br><span class="line">    │       └── internalinterfaces</span><br><span class="line">    └── listers</span><br><span class="line">        └── example</span><br><span class="line">            └── v1</span><br></pre></td></tr></table></figure>
<p>这些生成的代码都是不允许手动修改的，一般你需要修改 <code>pkg/apis</code>下面的源码后，再去通过执行 <code>hack/update-codegen.sh</code> 来生成新的代码。</p>
<p>我们可以通过 <code>code-generator</code> 来控制代码生成的一些参数，但是代码生成更多的属性是通过Go代码中的Tags来控制。这里有两种类型的Tag：</p>
<ul>
<li>Global Tags：全局Tags，在 <code>doc.go</code> 中位于 <code>package</code>之上</li>
<li>Local Tags：局部Tags</li>
</ul>
<p>Tags一般的形式是 <code>// +tag-name</code> 或者 <code>// +tag-name=value</code>，以注释的形式存在。一般来说，Tags存在的位置很重要，有些tag必须直接在type之上，有些tag必须和type间隔一行，具体可以参见pull request <a href="https://github.com/kubernetes/kubernetes/pull/53579" target="_blank" rel="external nofollow noopener noreferrer">#53579</a> and issue <a href="https://github.com/kubernetes/kubernetes/issues/53893" target="_blank" rel="external nofollow noopener noreferrer">#53893</a>。</p>
<h3 id="Global-Tags"><a href="#Global-Tags" class="headerlink" title="Global Tags"></a>Global Tags</h3><p> <code>Global Tags</code> 是定义在 doc.go 文件的注释，起到的是全局的代码生成控制的作用，具体如下所示，在这个文件中，你会看到 <code>+k8s:deepcopy-gen=package</code> 和 <code>+groupName=crddemo.k8s.io</code>，这就是 Kubernetes 进行代码生成要用的 Annotation 风格的注释。</p>
<figure class="highlight go"><figcaption><span>pkg/apis/crddemo/v1/doc.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +k8s:deepcopy-gen=package</span></span><br><span class="line"><span class="comment">// +groupName=example.houmin.cc</span></span><br><span class="line"><span class="keyword">package</span> v1</span><br></pre></td></tr></table></figure>
<ul>
<li><code>+k8s:deepcopy-gen=package</code> 意思是，请为整个 v1 包里的所有类型定义自动生成 DeepCopy 方法；</li>
<li><code>+groupName=example.houmin.cc</code>，则定义了这个包对应的crddemo API 组的名字，注意这个注释必须就在package之上 (see <a href="https://github.com/kubernetes/kubernetes/issues/53893" target="_blank" rel="external nofollow noopener noreferrer">Issue #53893</a>).</li>
</ul>
<p>如果你有一些Type不需要 <code>deepcopy</code>，那么你可以通过一个 Local Tag <code>// +k8s:deepcopy-gen=false</code> 来为这个 Typo 不生成 <code>deep copy</code>。如果没有打开package全局生成 <code>deepcopy</code>的开关，你可以对每个你想要的Type使用Local Tag <code>// +k8s:deepcopy-gen=true</code> 为它生成 <code>deepcopy</code>。</p>
<h3 id="Local-Tags"><a href="#Local-Tags" class="headerlink" title="Local Tags"></a>Local Tags</h3><p>Local Tags 是直接写在 API Types 之上的注释，下面是一个例子。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> v1</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	metav1 <span class="string">"k8s.io/apimachinery/pkg/apis/meta/v1"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// +genclient</span></span><br><span class="line"><span class="comment">// +genclient:noStatus</span></span><br><span class="line"><span class="comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Foo <span class="keyword">struct</span> &#123;</span><br><span class="line">	metav1.TypeMeta <span class="string">`json:",inline"`</span></span><br><span class="line"></span><br><span class="line">	metav1.ObjectMeta <span class="string">`json:"metadata,omitempty"`</span></span><br><span class="line"></span><br><span class="line">	Spec   FooSpec   <span class="string">`json:"spec"`</span></span><br><span class="line">	Status FooStatus <span class="string">`json:"status"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FooSpec is the spec for a Foo resource</span></span><br><span class="line"><span class="keyword">type</span> FooSpec <span class="keyword">struct</span> &#123;</span><br><span class="line">	DeploymentName <span class="keyword">string</span> <span class="string">`json:"deploymentName"`</span></span><br><span class="line">	Replicas       *<span class="keyword">int32</span> <span class="string">`json:"replicas"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FooStatus is the status for a Foo resource</span></span><br><span class="line"><span class="keyword">type</span> FooStatus <span class="keyword">struct</span> &#123;</span><br><span class="line">	AvailableReplicas <span class="keyword">int32</span> <span class="string">`json:"availableReplicas"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> FooList <span class="keyword">struct</span> &#123;</span><br><span class="line">	metav1.TypeMeta <span class="string">`json:",inline"`</span></span><br><span class="line">	metav1.ListMeta <span class="string">`json:"metadata"`</span></span><br><span class="line"></span><br><span class="line">	Items []Foo <span class="string">`json:"items"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个 <code>deepcopy</code> tag解释如下：</p>
<ul>
<li><code>+k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</code> 的意思是，请在生成 DeepCopy 的时候，实现 Kubernetes 提供的 runtime.Object 接口。否则，在某些版本的 Kubernetes 里，你的这个类型定义会出现编译错误。</li>
</ul>
<p>在上面的示例中，有部分tag用于控制 <code>client-gen</code>，如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +genclient</span></span><br><span class="line"><span class="comment">// +genclient:noStatus</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>+genclient</code> 这段注解的意思是：请为下面资源类型生成对应的 Client 代码。因为Foo才是主类型，所以 +genclient 要写在Mydemo之上，不用写在 <code>FooList</code> 之上，这是要细心注意的。</li>
<li><code>+genclient:noStatus</code> 的意思是：这个 API 资源类型定义里，没有 Status 字段，这个tag告诉 <code>client-gen</code> 不要生成 <code>UpdateStatus</code>方法，一般用于使用子资源分离的例如/status分离的，用来避免更新到status资源(当然代码的struct中也没有status)</li>
</ul>
<p>对于 <code>cluster-wide</code>的资源，你需要使用下面的tag</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +genclient:nonNamespaced</span></span><br></pre></td></tr></table></figure>
<p>有时候你想控制client提供的HTTP方法，你可以使用类似于下面的tag</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +genclient:noVerbs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// +genclient:onlyVerbs=create,delete</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// +genclient:skipVerbs=get,list,create,update,patch,delete,deleteCollection,watch</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// +genclient:method=Create,verb=create,result=k8s.io/apimachinery/pkg/apis/meta/v1.Status</span></span><br></pre></td></tr></table></figure>
<p>前三个很好理解，指定了client可以使用的verb。对于第四个tag，这里对应的Type只能是 create-only，并且不会返回 API Type本身，而是返回了 <code>metav1.Status</code>。</p>
<h2 id="Controller开发"><a href="#Controller开发" class="headerlink" title="Controller开发"></a>Controller开发</h2><p>在代码生成 <code>informers</code>、<code>clients</code>、<code>listers</code>等代码后，我们就可以用这些API编写Controller的代码了。</p>
<h3 id="主函数实现"><a href="#主函数实现" class="headerlink" title="主函数实现"></a>主函数实现</h3><p>我们可以像使用原生 kubernetes client一样，使用我们生成的client，如下所示：</p>
<figure class="highlight go"><figcaption><span>main.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"flag"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">	kubeinformers <span class="string">"k8s.io/client-go/informers"</span></span><br><span class="line">	<span class="string">"k8s.io/client-go/kubernetes"</span></span><br><span class="line">	<span class="string">"k8s.io/client-go/tools/clientcmd"</span></span><br><span class="line">	<span class="string">"k8s.io/klog/v2"</span></span><br><span class="line"></span><br><span class="line">	clientset <span class="string">"github.com/SimpCosm/crddemo/pkg/client/clientset/versioned"</span></span><br><span class="line">	informers <span class="string">"github.com/SimpCosm/crddemo/pkg/client/informers/externalversions"</span></span><br><span class="line">	<span class="string">"github.com/SimpCosm/crddemo/pkg/signals"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	masterURL  <span class="keyword">string</span></span><br><span class="line">	kubeconfig <span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	klog.InitFlags(<span class="literal">nil</span>)</span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set up signals so we handle the first shutdown signal gracefully</span></span><br><span class="line">	stopCh := signals.SetupSignalHandler()</span><br><span class="line"></span><br><span class="line">	cfg, err := clientcmd.BuildConfigFromFlags(masterURL, kubeconfig)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Fatalf(<span class="string">"Error building kubeconfig: %s"</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	kubeClient, err := kubernetes.NewForConfig(cfg)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Fatalf(<span class="string">"Error building kubernetes clientset: %s"</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	exampleClient, err := clientset.NewForConfig(cfg)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Fatalf(<span class="string">"Error building example clientset: %s"</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	kubeInformerFactory := kubeinformers.NewSharedInformerFactory(kubeClient, time.Second*<span class="number">30</span>)</span><br><span class="line">	exampleInformerFactory := informers.NewSharedInformerFactory(exampleClient, time.Second*<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">	controller := NewController(kubeClient, exampleClient,</span><br><span class="line">		kubeInformerFactory.Apps().V1().Deployments(),</span><br><span class="line">		exampleInformerFactory.Example().V1().Foos())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// notice that there is no need to run Start methods in a separate goroutine. (i.e. go kubeInformerFactory.Start(stopCh)</span></span><br><span class="line">	<span class="comment">// Start method is non-blocking and runs all registered informers in a dedicated goroutine.</span></span><br><span class="line">	kubeInformerFactory.Start(stopCh)</span><br><span class="line">	exampleInformerFactory.Start(stopCh)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err = controller.Run(<span class="number">2</span>, stopCh); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Fatalf(<span class="string">"Error running controller: %s"</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	flag.StringVar(&amp;kubeconfig, <span class="string">"kubeconfig"</span>, <span class="string">""</span>, <span class="string">"Path to a kubeconfig. Only required if out-of-cluster."</span>)</span><br><span class="line">	flag.StringVar(&amp;masterURL, <span class="string">"master"</span>, <span class="string">""</span>, <span class="string">"The address of the Kubernetes API server. Overrides any value in kubeconfig. Only required if out-of-cluster."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Controller定义"><a href="#Controller定义" class="headerlink" title="Controller定义"></a>Controller定义</h3><p>这里我们定义了自己的Controller：</p>
<ul>
<li>分别有原生的kubernetes clientset和自定义API group的clientset。</li>
<li>因为我们会监听原生的 <code>Deployment</code>和自己的 <code>Foo</code>，所以分别加上了各自的lister。</li>
<li>每次资源发生改变时，会将其放入到workqueue等待处理在Control Loop中处理。</li>
</ul>
<figure class="highlight go"><figcaption><span>controller.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller is the controller implementation for Foo resources</span></span><br><span class="line"><span class="keyword">type</span> Controller <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// kubeclientset is a standard kubernetes clientset</span></span><br><span class="line">	kubeclientset kubernetes.Interface</span><br><span class="line">	<span class="comment">// sampleclientset is a clientset for our own API group</span></span><br><span class="line">	sampleclientset clientset.Interface</span><br><span class="line"></span><br><span class="line">	deploymentsLister appslisters.DeploymentLister</span><br><span class="line">	deploymentsSynced cache.InformerSynced</span><br><span class="line">	foosLister        listers.FooLister</span><br><span class="line">	foosSynced        cache.InformerSynced</span><br><span class="line"></span><br><span class="line">	<span class="comment">// workqueue is a rate limited work queue. This is used to queue work to be</span></span><br><span class="line">	<span class="comment">// processed instead of performing it as soon as a change happens. This</span></span><br><span class="line">	<span class="comment">// means we can ensure we only process a fixed amount of resources at a</span></span><br><span class="line">	<span class="comment">// time, and makes it easy to ensure we are never processing the same item</span></span><br><span class="line">	<span class="comment">// simultaneously in two different workers.</span></span><br><span class="line">	workqueue workqueue.RateLimitingInterface</span><br><span class="line">	<span class="comment">// recorder is an event recorder for recording Event resources to the</span></span><br><span class="line">	<span class="comment">// Kubernetes API.</span></span><br><span class="line">	recorder record.EventRecorder</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Controller创建"><a href="#Controller创建" class="headerlink" title="Controller创建"></a>Controller创建</h3><p>接下来，我们来看跟业务最紧密的控制器Controller的编写</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewController returns a new sample controller</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewController</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	kubeclientset kubernetes.Interface,</span></span></span><br><span class="line"><span class="function"><span class="params">	sampleclientset clientset.Interface,</span></span></span><br><span class="line"><span class="function"><span class="params">	deploymentInformer appsinformers.DeploymentInformer,</span></span></span><br><span class="line"><span class="function"><span class="params">	fooInformer informers.FooInformer)</span> *<span class="title">Controller</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create event broadcaster</span></span><br><span class="line">	<span class="comment">// Add example types to the default Kubernetes Scheme so Events can be</span></span><br><span class="line">	<span class="comment">// logged for example types.</span></span><br><span class="line">	utilruntime.Must(samplescheme.AddToScheme(scheme.Scheme))</span><br><span class="line">	klog.V(<span class="number">4</span>).Info(<span class="string">"Creating event broadcaster"</span>)</span><br><span class="line">	eventBroadcaster := record.NewBroadcaster()</span><br><span class="line">	eventBroadcaster.StartStructuredLogging(<span class="number">0</span>)</span><br><span class="line">	eventBroadcaster.StartRecordingToSink(&amp;typedcorev1.EventSinkImpl&#123;Interface: kubeclientset.CoreV1().Events(<span class="string">""</span>)&#125;)</span><br><span class="line">	recorder := eventBroadcaster.NewRecorder(scheme.Scheme, corev1.EventSource&#123;Component: controllerAgentName&#125;)</span><br><span class="line"></span><br><span class="line">	controller := &amp;Controller&#123;</span><br><span class="line">		kubeclientset:     kubeclientset,</span><br><span class="line">		sampleclientset:   sampleclientset,</span><br><span class="line">		deploymentsLister: deploymentInformer.Lister(),</span><br><span class="line">		deploymentsSynced: deploymentInformer.Informer().HasSynced,</span><br><span class="line">		foosLister:        fooInformer.Lister(),</span><br><span class="line">		foosSynced:        fooInformer.Informer().HasSynced,</span><br><span class="line">		workqueue:         workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), <span class="string">"Foos"</span>),</span><br><span class="line">		recorder:          recorder,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	klog.Info(<span class="string">"Setting up event handlers"</span>)</span><br><span class="line">	<span class="comment">// Set up an event handler for when Foo resources change</span></span><br><span class="line">	fooInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">		AddFunc: controller.enqueueFoo,</span><br><span class="line">		UpdateFunc: <span class="function"><span class="keyword">func</span><span class="params">(old, <span class="built_in">new</span> <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">			controller.enqueueFoo(<span class="built_in">new</span>)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	</span><br><span class="line">	deploymentInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">		AddFunc: controller.handleObject,</span><br><span class="line">		UpdateFunc: <span class="function"><span class="keyword">func</span><span class="params">(old, <span class="built_in">new</span> <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">			newDepl := <span class="built_in">new</span>.(*appsv1.Deployment)</span><br><span class="line">			oldDepl := old.(*appsv1.Deployment)</span><br><span class="line">			<span class="keyword">if</span> newDepl.ResourceVersion == oldDepl.ResourceVersion &#123;</span><br><span class="line">				<span class="comment">// Periodic resync will send update events for all known Deployments.</span></span><br><span class="line">				<span class="comment">// Two different versions of the same Deployment will always have different RVs.</span></span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			controller.handleObject(<span class="built_in">new</span>)</span><br><span class="line">		&#125;,</span><br><span class="line">		DeleteFunc: controller.handleObject,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> controller</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面Controller的代码实现，我们基本实现了控制器ListAndWatch的事件注册逻辑：通过 APIServer 的 LIST API获取所有最新版本的 API 对象；然后，再通过 WATCH-API 来监听所有这些API对象的变化。通过监听到的事件变化，Informer 就可以实时地更新本地缓存，并且调用这些事件对应的 EventHandler了。</p>
<h3 id="Control-Loop"><a href="#Control-Loop" class="headerlink" title="Control Loop"></a>Control Loop</h3><p>下面，我们再来看原理图中的Control Loop的部分</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span> <span class="title">Run</span><span class="params">(threadiness <span class="keyword">int</span>, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> utilruntime.HandleCrash()</span><br><span class="line">	<span class="keyword">defer</span> c.workqueue.ShutDown()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Start the informer factories to begin populating the informer caches</span></span><br><span class="line">	klog.Info(<span class="string">"Starting Foo controller"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Wait for the caches to be synced before starting workers</span></span><br><span class="line">	klog.Info(<span class="string">"Waiting for informer caches to sync"</span>)</span><br><span class="line">	<span class="keyword">if</span> ok := cache.WaitForCacheSync(stopCh, c.deploymentsSynced, c.foosSynced); !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to wait for caches to sync"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	klog.Info(<span class="string">"Starting workers"</span>)</span><br><span class="line">	<span class="comment">// Launch two workers to process Foo resources</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; threadiness; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> wait.Until(c.runWorker, time.Second, stopCh)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	klog.Info(<span class="string">"Started workers"</span>)</span><br><span class="line">	&lt;-stopCh</span><br><span class="line">	klog.Info(<span class="string">"Shutting down workers"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，启动控制循环的逻辑非常简单，就是同步+循环监听任务。而这个循环监听任务就是我们真正的业务实现部分了</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// runWorker is a long-running function that will continually call the</span></span><br><span class="line"><span class="comment">// processNextWorkItem function in order to read and process a message on the</span></span><br><span class="line"><span class="comment">// workqueue.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span> <span class="title">runWorker</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> c.processNextWorkItem() &#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// processNextWorkItem will read a single work item off the workqueue and</span></span><br><span class="line"><span class="comment">// attempt to process it, by calling the syncHandler.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span> <span class="title">processNextWorkItem</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	obj, shutdown := c.workqueue.Get()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> shutdown &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We wrap this block in a func so we can defer c.workqueue.Done.</span></span><br><span class="line">	err := <span class="function"><span class="keyword">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="comment">// We call Done here so the workqueue knows we have finished</span></span><br><span class="line">		<span class="comment">// processing this item. We also must remember to call Forget if we</span></span><br><span class="line">		<span class="comment">// do not want this work item being re-queued. For example, we do</span></span><br><span class="line">		<span class="comment">// not call Forget if a transient error occurs, instead the item is</span></span><br><span class="line">		<span class="comment">// put back on the workqueue and attempted again after a back-off</span></span><br><span class="line">		<span class="comment">// period.</span></span><br><span class="line">		<span class="keyword">defer</span> c.workqueue.Done(obj)</span><br><span class="line">		<span class="keyword">var</span> key <span class="keyword">string</span></span><br><span class="line">		<span class="keyword">var</span> ok <span class="keyword">bool</span></span><br><span class="line">		<span class="comment">// We expect strings to come off the workqueue. These are of the</span></span><br><span class="line">		<span class="comment">// form namespace/name. We do this as the delayed nature of the</span></span><br><span class="line">		<span class="comment">// workqueue means the items in the informer cache may actually be</span></span><br><span class="line">		<span class="comment">// more up to date that when the item was initially put onto the</span></span><br><span class="line">		<span class="comment">// workqueue.</span></span><br><span class="line">		<span class="keyword">if</span> key, ok = obj.(<span class="keyword">string</span>); !ok &#123;</span><br><span class="line">			<span class="comment">// As the item in the workqueue is actually invalid, we call</span></span><br><span class="line">			<span class="comment">// Forget here else we'd go into a loop of attempting to</span></span><br><span class="line">			<span class="comment">// process a work item that is invalid.</span></span><br><span class="line">			c.workqueue.Forget(obj)</span><br><span class="line">			utilruntime.HandleError(fmt.Errorf(<span class="string">"expected string in workqueue but got %#v"</span>, obj))</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Run the syncHandler, passing it the namespace/name string of the</span></span><br><span class="line">		<span class="comment">// Foo resource to be synced.</span></span><br><span class="line">		<span class="keyword">if</span> err := c.syncHandler(key); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// Put the item back on the workqueue to handle any transient errors.</span></span><br><span class="line">			c.workqueue.AddRateLimited(key)</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"error syncing '%s': %s, requeuing"</span>, key, err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Finally, if no error occurs we Forget this item so it does not</span></span><br><span class="line">		<span class="comment">// get queued again until another change happens.</span></span><br><span class="line">		c.workqueue.Forget(obj)</span><br><span class="line">		klog.Infof(<span class="string">"Successfully synced '%s'"</span>, key)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;(obj)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utilruntime.HandleError(err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中的 <code>fooInformer</code>，从namespace中通过key获取 <code>Foo</code> 对象这个操作，其实就是在访问本地缓存的索引，实际上，在 Kubernetes 的源码中，你会经常看到控制器从各种 Lister 里获取对象，比如：podLister、nodeLister 等等，它们使用的都是 Informer 和缓存机制。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// syncHandler compares the actual state with the desired, and attempts to</span></span><br><span class="line"><span class="comment">// converge the two. It then updates the Status block of the Foo resource</span></span><br><span class="line"><span class="comment">// with the current status of the resource.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span> <span class="title">syncHandler</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// Convert the namespace/name string into a distinct namespace and name</span></span><br><span class="line">	namespace, name, err := cache.SplitMetaNamespaceKey(key)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		utilruntime.HandleError(fmt.Errorf(<span class="string">"invalid resource key: %s"</span>, key))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get the Foo resource with this namespace/name</span></span><br><span class="line">	foo, err := c.foosLister.Foos(namespace).Get(name)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// The Foo resource may no longer exist, in which case we stop</span></span><br><span class="line">		<span class="comment">// processing.</span></span><br><span class="line">		<span class="keyword">if</span> errors.IsNotFound(err) &#123;</span><br><span class="line">			utilruntime.HandleError(fmt.Errorf(<span class="string">"foo '%s' in work queue no longer exists"</span>, key))</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	deploymentName := foo.Spec.DeploymentName</span><br><span class="line">	<span class="keyword">if</span> deploymentName == <span class="string">""</span> &#123;</span><br><span class="line">		<span class="comment">// We choose to absorb the error here as the worker would requeue the</span></span><br><span class="line">		<span class="comment">// resource otherwise. Instead, the next time the resource is updated</span></span><br><span class="line">		<span class="comment">// the resource will be queued again.</span></span><br><span class="line">		utilruntime.HandleError(fmt.Errorf(<span class="string">"%s: deployment name must be specified"</span>, key))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get the deployment with the name specified in Foo.spec</span></span><br><span class="line">	deployment, err := c.deploymentsLister.Deployments(foo.Namespace).Get(deploymentName)</span><br><span class="line">	<span class="comment">// If the resource doesn't exist, we'll create it</span></span><br><span class="line">	<span class="keyword">if</span> errors.IsNotFound(err) &#123;</span><br><span class="line">		deployment, err = c.kubeclientset.AppsV1().Deployments(foo.Namespace).Create(context.TODO(), newDeployment(foo), metav1.CreateOptions&#123;&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If an error occurs during Get/Create, we'll requeue the item so we can</span></span><br><span class="line">	<span class="comment">// attempt processing again later. This could have been caused by a</span></span><br><span class="line">	<span class="comment">// temporary network failure, or any other transient reason.</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If the Deployment is not controlled by this Foo resource, we should log</span></span><br><span class="line">	<span class="comment">// a warning to the event recorder and return error msg.</span></span><br><span class="line">	<span class="keyword">if</span> !metav1.IsControlledBy(deployment, foo) &#123;</span><br><span class="line">		msg := fmt.Sprintf(MessageResourceExists, deployment.Name)</span><br><span class="line">		c.recorder.Event(foo, corev1.EventTypeWarning, ErrResourceExists, msg)</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(msg)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If this number of the replicas on the Foo resource is specified, and the</span></span><br><span class="line">	<span class="comment">// number does not equal the current desired replicas on the Deployment, we</span></span><br><span class="line">	<span class="comment">// should update the Deployment resource.</span></span><br><span class="line">	<span class="keyword">if</span> foo.Spec.Replicas != <span class="literal">nil</span> &amp;&amp; *foo.Spec.Replicas != *deployment.Spec.Replicas &#123;</span><br><span class="line">		klog.V(<span class="number">4</span>).Infof(<span class="string">"Foo %s replicas: %d, deployment replicas: %d"</span>, name, *foo.Spec.Replicas, *deployment.Spec.Replicas)</span><br><span class="line">		deployment, err = c.kubeclientset.AppsV1().Deployments(foo.Namespace).Update(context.TODO(), newDeployment(foo), metav1.UpdateOptions&#123;&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If an error occurs during Update, we'll requeue the item so we can</span></span><br><span class="line">	<span class="comment">// attempt processing again later. This could have been caused by a</span></span><br><span class="line">	<span class="comment">// temporary network failure, or any other transient reason.</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Finally, we update the status block of the Foo resource to reflect the</span></span><br><span class="line">	<span class="comment">// current state of the world</span></span><br><span class="line">	err = c.updateFooStatus(foo, deployment)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	c.recorder.Event(foo, corev1.EventTypeNormal, SuccessSynced, MessageResourceSynced)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而如果控制循环从缓存中拿不到这个对象（<code>fooInformer</code> 返回了 IsNotFound 错误），那就意味着这个 <code>Foo</code>  对象的 Key 是通过前面的“删除”事件添加进工作队列的。所以，尽管队列里有这个 Key，但是对应的 <code>Foo</code>  对象已经被删除了。而如果能够获取到对应的 <code>Foo</code>  对象，就可以执行控制器模式里的对比 <code>Desired State</code> 和 <code>CurrentState</code> 的功能逻辑了。</p>
<p>至此，一个完整的自定义 API 对象和它所对应的自定义控制器，就编写完毕了。</p>
<h2 id="部署测试"><a href="#部署测试" class="headerlink" title="部署测试"></a>部署测试</h2><p>编译完成后，会生成 <em>crddemo</em> 的二进制文件，我们要做把crddemo放到kubernetes集群中，或者本地也行，只要能访问到 <code>apiserver</code> 和具备<code>kubeconfig</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./crddemo --kubeconfig=.kube/config</span></span><br><span class="line">I1106 10:47:59.055510   11946 controller.go:115] Setting up event handlers</span><br><span class="line">I1106 10:47:59.055608   11946 controller.go:156] Starting Foo controller</span><br><span class="line">I1106 10:47:59.055620   11946 controller.go:159] Waiting <span class="keyword">for</span> informer caches to sync</span><br><span class="line">E1106 10:47:59.079342   11946 reflector.go:138] pkg/client/informers/externalversions/factory.go:116: Failed to watch *v1.Foo: failed to list *v1.Foo: the server could not find the requested resource (get foos.example.houmin.cc)</span><br><span class="line">E1106 10:48:00.369747   11946 reflector.go:138] pkg/client/informers/externalversions/factory.go:116: Failed to watch *v1.Foo: failed to list *v1.Foo: the server could not find the requested resource (get foos.example.houmin.cc)</span><br><span class="line">E1106 10:48:03.038137   11946 reflector.go:138] pkg/client/informers/externalversions/factory.go:116: Failed to watch *v1.Foo: failed to list *v1.Foo: the server could not find the requested resource (get foos.example.houmin.cc)</span><br></pre></td></tr></table></figure>
<p>可以看到，程序运行的时候，一开始会报错。这是因为，此时 Mydemo 对象的 CRD 还没有被创建出来，所以 Informer 去 APIServer 里获取 Mydemos 对象时，并不能找到 Mydemo 这个 API 资源类型的定义</p>
<p>接下来，我们执行我们自定义资源的定义文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$  kubectl apply -f artifacts/examples/crd.yaml </span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/foos.example.houmin.cc created</span><br></pre></td></tr></table></figure>
<p>此时，观察crddemo的日志输出，可以看到Controller的日志恢复了正常，控制循环启动成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">I0308 12:30:29.956263   28282 controller.go:113] Starting workers</span><br><span class="line">I0308 12:30:29.956307   28282 controller.go:118] Started workers</span><br></pre></td></tr></table></figure>
<p>然后，我们可以对我们的Mydemo对象进行增删改查操作了。</p>
<p>提交我们的自定义资源对象</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f artifacts/examples/example-foo.yaml </span></span><br><span class="line">foo.example.houmin.cc/example-foo created</span><br></pre></td></tr></table></figure>
<p>创建成功够，看k8s集群是否成功存储起来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get foo</span></span><br><span class="line">NAME          AGE</span><br><span class="line">example-foo   8s</span><br></pre></td></tr></table></figure>
<p>这时候，查看一下控制器的输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./crddemo --kubeconfig=.kube/config</span></span><br><span class="line">I1106 10:50:36.627136   12768 controller.go:115] Setting up event handlers</span><br><span class="line">I1106 10:50:36.627225   12768 controller.go:156] Starting Foo controller</span><br><span class="line">I1106 10:50:36.627235   12768 controller.go:159] Waiting <span class="keyword">for</span> informer caches to sync</span><br><span class="line">I1106 10:50:36.727340   12768 controller.go:164] Starting workers</span><br><span class="line">I1106 10:50:36.727364   12768 controller.go:170] Started workers</span><br><span class="line">I1106 10:51:27.596870   12768 controller.go:228] Successfully synced <span class="string">'default/example-foo'</span></span><br><span class="line">I1106 10:51:27.597113   12768 event.go:291] <span class="string">"Event occurred"</span> object=<span class="string">"default/example-foo"</span> kind=<span class="string">"Foo"</span> apiVersion=<span class="string">"example.houmin.cc/v1"</span> <span class="built_in">type</span>=<span class="string">"Normal"</span> reason=<span class="string">"Synced"</span> message=<span class="string">"Foo synced successfully"</span></span><br><span class="line">I1106 10:51:27.612272   12768 controller.go:228] Successfully synced <span class="string">'default/example-foo'</span></span><br><span class="line">I1106 10:51:27.612393   12768 event.go:291] <span class="string">"Event occurred"</span> object=<span class="string">"default/example-foo"</span> kind=<span class="string">"Foo"</span> apiVersion=<span class="string">"example.houmin.cc/v1"</span> <span class="built_in">type</span>=<span class="string">"Normal"</span> reason=<span class="string">"Synced"</span> message=<span class="string">"Foo synced successfully"</span></span><br></pre></td></tr></table></figure>
<p>可以看到，我们上面创建 example-mydemo.yaml 的操作，触发了 EventHandler 的添加事件，从而被放进了工作队列。紧接着，控制循环就从队列里拿到了这个对象，并且打印出了正在处理这个 Foo 对象的日志。</p>
<p>同时我们可以看到，与Foo相关的Deployment也同时被创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get deployment</span></span><br><span class="line">NAME          READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">example-foo   1/1     1            1           76s</span><br></pre></td></tr></table></figure>
<p>我们这时候，尝试修改资源，对对应的replicas属性进行修改</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">example.houmin.cc/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Foo</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-foo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">deploymentName:</span> <span class="string">example-foo</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>手动执行修改:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f artifacts/examples/example-foo.yaml</span></span><br></pre></td></tr></table></figure>
<p>同时我们可以看到，与Foo相关的Deployment的副本数也同时增加：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get deployment</span></span><br><span class="line">NAME          READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">example-foo   3/3     3            3           2m34s</span><br></pre></td></tr></table></figure>
<p>我们这时候，尝试修改资源，对对应的replicas属性进行修改</p>
<p>可以看到，这一次，Informer 注册的更新事件被触发，更新后的 Foo 对象的 Key 被添加到了工作队列之中。</p>
<p>所以，接下来控制循环从工作队列里拿到的 Foo 对象，与前一个对象是不同的：它的<code>ResourceVersion</code>的值发生了改变；而 Spec 里的Replicas 字段，则变成了3。最后，我再把这个对象删除掉：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$  kubectl delete -f artifacts/examples/example-foo.yaml </span><br><span class="line">foo.example.houmin.cc <span class="string">"example-foo"</span> deleted</span><br></pre></td></tr></table></figure>
<p>然后，k8s集群的资源也被清除了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$  kubectl get foo                    </span><br><span class="line">No resources found <span class="keyword">in</span> default namespace.</span><br></pre></td></tr></table></figure>
<p>以上就是使用自定义控制器的基本开发流程</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://lihaoquan.me/2020/3/8/k8s-crd-develop.html" target="_blank" rel="external nofollow noopener noreferrer">https://lihaoquan.me/2020/3/8/k8s-crd-develop.html</a></li>
<li><a href="https://blog.openshift.com/kubernetes-deep-dive-code-generation-customresources/" target="_blank" rel="external nofollow noopener noreferrer">Kubernetes Deep Dive: Code Generation for CustomResources</a></li>
<li><a href="https://github.com/kubernetes/code-generator" target="_blank" rel="external nofollow noopener noreferrer">code-generator</a></li>
<li><a href="https://github.com/kubernetes/sample-controller" target="_blank" rel="external nofollow noopener noreferrer">sample controller</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md" target="_blank" rel="external nofollow noopener noreferrer">API Conventions</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/customresources-versioning.md" target="_blank" rel="external nofollow noopener noreferrer">CustomReourcesVersioning</a></li>
<li><a href="https://github.com/kubernetes/community/blob/8cafef897a22026d42f5e5bb3f104febe7e29830/contributors/devel/controllers.md" target="_blank" rel="external nofollow noopener noreferrer">Writing Controllers</a></li>
</ul>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章推荐</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/3bc1a603/" rel="bookmark">【Kubernetes】ApiServer 启动分析</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/76a404e7/" rel="bookmark">【Kubernetes】Controller Manager</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/b0614056/" rel="bookmark">【Kubernetes】API Install</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/d8b96fe4/" rel="bookmark">【Kubernetes】开篇</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/4756d236/" rel="bookmark">【Kubernetes】DaemonSet</a></div>
    </li>
  </ul>

      
        <div class="reward-container">
  <div></div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/wechatpay.png" alt="Houmin 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/alipay.jpg" alt="Houmin 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Houmin
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://houmin.cc/posts/c57d800c/" title="【Kubernetes】CRD">http://houmin.cc/posts/c57d800c/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
              <a href="/tags/crd/" rel="tag"><i class="fa fa-tag"></i> crd</a>
              <a href="/tags/controller/" rel="tag"><i class="fa fa-tag"></i> controller</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/posts/b88b921f/" rel="next" title="【Kubernetes】Pod">
                  <i class="fa fa-chevron-left"></i> 【Kubernetes】Pod
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/posts/58272b06/" rel="prev" title="【Kubernetes】监控的可观测性">
                  【Kubernetes】监控的可观测性 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="comments"></div>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#CRD使用方法"><span class="nav-number">1.</span> <span class="nav-text">CRD使用方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-CustomResourceDefinition"><span class="nav-number">1.1.</span> <span class="nav-text">Create CustomResourceDefinition</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-custom-objects"><span class="nav-number">1.2.</span> <span class="nav-text">Create custom objects</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定义CRD资源"><span class="nav-number">2.</span> <span class="nav-text">定义CRD资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码生成"><span class="nav-number">3.</span> <span class="nav-text">代码生成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Global-Tags"><span class="nav-number">3.1.</span> <span class="nav-text">Global Tags</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Local-Tags"><span class="nav-number">3.2.</span> <span class="nav-text">Local Tags</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Controller开发"><span class="nav-number">4.</span> <span class="nav-text">Controller开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主函数实现"><span class="nav-number">4.1.</span> <span class="nav-text">主函数实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Controller定义"><span class="nav-number">4.2.</span> <span class="nav-text">Controller定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Controller创建"><span class="nav-number">4.3.</span> <span class="nav-text">Controller创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Control-Loop"><span class="nav-number">4.4.</span> <span class="nav-text">Control Loop</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署测试"><span class="nav-number">5.</span> <span class="nav-text">部署测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">6.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Houmin" src="https://cosmos-1251905798.cos.ap-beijing.myqcloud.com/theme/avatar.png">
  <p class="site-author-name" itemprop="name">Houmin</p>
  <div class="site-description" itemprop="description">丈夫拥书万卷，何假南面百城</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">148</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">213</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/SimpCosm" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;SimpCosm" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weihoumin@gmail.com" title="E-Mail &amp;rarr; mailto:weihoumin@gmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="hitokoto">
    <!-- hitokoto -->
    <div id="hito-expression">:D 获取中...</div>

    <script src="https://cdn.jsdelivr.net/npm/bluebird@3/js/browser/bluebird.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@2.0.3/fetch.min.js"></script>
    <script>
      fetch('https://v1.hitokoto.cn')
        .then(function (res){
          return res.json();
        })
        .then(function (data) {
          var hitokoto = document.getElementById('hito-expression');
          hitokoto.innerText = data.hitokoto + '——【' + data.from + '】';
        })
        .catch(function (err) {
          console.error(err);
        })
    </script>
  </div>

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heartbeat"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Houmin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">1.6m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">47:03</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>



  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.1.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  




  <script src="/js/local-search.js"></script>








<script>
if (document.querySelectorAll('div.pdf').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/pdfobject@2/pdfobject.min.js', () => {
    document.querySelectorAll('div.pdf').forEach(element => {
      PDFObject.embed(element.getAttribute('target'), element, {
        pdfOpenParams: {
          navpanes: 0,
          toolbar: 0,
          statusbar: 0,
          pagemode: 'thumbs',
          view: 'FitH'
        },
        PDFJS_URL: '/lib/pdf/web/viewer.html',
        height: element.getAttribute('height') || '800px'
      });
    });
  }, window.PDFObject);
}
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>



  

  

  


<script>
NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'iEBFuhVyk4tuhVYctQ265uid-gzGzoHsz',
    appKey: 'KGjOktrtgSEWK1v9DYA3T3Az',
    placeholder: "Just go go",
    avatar: 'retro',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: 'zh-cn' || 'zh-cn',
    path: location.pathname,
    recordIP: true,
    serverURLs: ''
  });
}, window.Valine);
</script>

</body>
</html>
